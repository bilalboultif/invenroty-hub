<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Client - Family Tracker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css"
    />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.0/leaflet-routing-machine.css"
    />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="navbar.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <script src="navbar.js" defer></script>
    
    <style>

/* General Reset */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}


.system-message .message-content {
    font-style: italic;
    color: #888;  /* Lighter color for system messages */
    text-align: center;
    padding: 10px;
}
.message .message-header {
    display: flex;
    align-items: center;
}
.message .user-image {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    margin-right: 10px;
}
.message .username {
    font-weight: bold;
}


/* Body Styles */
body {
  font-family: 'Arial', sans-serif;
  background: linear-gradient(to right, #55403f5e, #feb47b0a); /* Gradient Background */
  color: #333;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: flex-start;
  min-height: 100vh;
  padding: 20px;
  overflow-y: auto; /* Allow scrolling */
}

.vertical-progress {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    gap: 15px;
    margin-top: 20px;
    border-right: 3px solid #ccc;
    padding-right: 15px;
    position: relative;
}

.step-line-container {
  position: relative;
  display: flex;
  flex-direction: column;
  gap: 40px;
  padding-left: 10px;
  border-right: 2px solid transparent;
}
.step-line-container::after {
  content: attr(data-progress);
  position: absolute;
  left: 60px; /* increased from 40px to add more distance from the dots */
  top: calc(var(--progress-percent, 0%) - 10px);
  background: #0d6efd;
  color: #fff;
  font-size: 12px;
  padding: 2px 8px;
  border-radius: 12px;
  font-weight: bold;
  z-index: 3;
  transform: translateY(-50%);
  transition: top 0.3s ease;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
}


.step-line-container::before {
  content: "";
  position: absolute;
  left: 18px;
  top: 0;
  width: 4px;
  height: 100%;
  background: linear-gradient(to bottom, #0d6efd 0%, #0d6efd 70%, #ccc 70%);
  border-radius: 2px;
  z-index: 0;
  transition: background 0.4s ease;
}

.step-line-item {
  position: relative;
  display: flex;
  align-items: center;
  gap: 12px;
  z-index: 1;
  transition: transform 0.3s ease;
}

.step-line-item:hover {
  transform: translateX(5px);
}

.step-dot {
  width: 20px;
  height: 20px;
  border: 3px solid #ccc;
  border-radius: 50%;
  background-color: white;
  position: relative;
  z-index: 2;
  transition: all 0.3s ease;
}

.step-dot.completed {
  border-color: #0d6efd;
  background-color: #0d6efd;
  box-shadow: 0 0 0 4px rgba(13, 110, 253, 0.2);
}

.step-dot.current {
  border-color: #ffc107;
  background-color: #fff3cd;
  box-shadow: 0 0 0 4px rgba(255, 193, 7, 0.3);
}

.step-line-item div:last-child {
  font-weight: bold;
  color: #333;
  transition: color 0.3s ease;
}

.step-line-item:hover div:last-child {
  color: #0d6efd;
}

.step-dot.current {
  animation: blink 1s infinite;
}

@keyframes blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.5; }
}




#haj-body {
  all: initial;
  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
  line-height: 1.6;
  color: #333;
  direction: rtl;
  text-align: right;
  display: block;
}



/* Admin Details Section Styling */
#details-admin {
  background-color: #24b96283;
  color: white;
  padding: 10px 20px;
  border-radius: 10px;
  cursor: pointer;
  font-size: 1.2rem;
  margin-bottom: 20px;
  transition: background-color 0.3s ease, transform 0.3s ease;
}

#details-admin:hover {
  background-color: #22a148c2;
  transform: scale(1.05);
}

/* Initially hide admin details */
#adminDetails.hidden {
  display: none;
  opacity: 0;
}

/* When the admin details are visible */
#adminDetails {
  display: block;
  background-color: rgba(0, 0, 0, 0.5);
  border-radius: 15px;
  padding: 20px;
  margin-bottom: 20px;
  width: 90%;
  max-width: 800px;
  color: white;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
  transition: opacity 0.3s ease;
}
/* Button Styling */
button {
  background-color: #000;
  color: white;
  border: none;
  padding: 10px 20px;
  margin: 10px;
  border-radius: 10px;
  font-size: 1rem;
  cursor: pointer;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
  transition: all 0.3s ease-in-out;
}

button:hover {
  background-color: #0a0a0a59;
  transform: scale(1.05);
  box-shadow: 0 6px 10px rgba(0, 0, 0, 0.3);
}

button:focus {
  outline: none;
  border: 2px solid #ff7e5f;
}

button:disabled {
  background-color: #ddd;
  cursor: not-allowed;
}

/* Input Fields */
input[type="text"], select {
  padding: 10px;
  margin: 10px 0;
  border-radius: 10px;
  border: 1px solid #ff7e5f;
  font-size: 1rem;
  width: 80%;
  max-width: 400px;
  transition: border-color 0.3s ease-in-out;
}

input[type="text"]:focus, select:focus {
  border-color: #ff4e50;
  outline: none;
}

/* Containers */
#securityCodeContainer, #deviceInfo, #callInProgress, #locationResult, #incoming-call-container, #callTimer {
  background-color: rgba(0, 0, 0, 0.14);
  border-radius: 15px;
  padding: 20px;
  margin-bottom: 20px;
  width: 90%;
  max-width: 800px;
  color: white;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.4);
  transition: opacity 0.3s ease;
}

#callInProgress {
  display: none;
}

/* Buttons in the Same Line */
.buttons-container {
  display: flex;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: 15px;
  margin-top: 20px;
}

.buttons-container button {
  margin: 0;
  flex: 1 1 calc(33% - 10px); /* Responsive layout for buttons */
}

.buttons-container button:nth-child(4) {
  flex: 1 1 100%; /* Make the "Feeling Unwell" button span the whole row */
}

/* Call Status and Incoming Call UI */
.call-status {
  text-align: center;
  margin: 20px 0;
}

.call-status h2 {
  font-size: 1.2rem;
}

.call-status button {
  background-color: #ff6f61;
  transition: background-color 0.3s;
}

.call-status button:hover {
  background-color: #ff3b3f;
}

#incoming-call-container {
  display: flex;
  flex-direction: column;
  align-items: center;
}

#caller-name {
  font-size: 1.2rem;
  color: white;
  margin-bottom: 20px;
}

/* Call Timer */
#callTimer {
  font-size: 2rem;
  margin-top: 20px;
  color: #ff4e50;
  text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
}
.video-container {
  display: flex
;
    /* gap: 20px; */
    margin-top: 80px;
    position: fixed;
    top: 50px;
    left: 10px;
        }

        .video {
            width: 300px;
            height: 600px;
            background-color: #eee;
            border-radius: 12px;
            box-shadow: 0px 6px 12px rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .video-placeholder {
            font-size: 50px;
            color: #bbb;
        }

        .video video {
            width: 100%;
            height: 100%;
            border-radius: 12px;
            object-fit: cover;
        }
/* Control Buttons */
#control-buttons {
  display: none;
  margin-top: 20px;
}

#control-buttons button {
  background-color: #ff6f61;
  margin: 5px;
}

#control-buttons button:hover {
  background-color: #ff3b3f;
}

/* Status Indicator */
#status-indicator {
  font-size: 1.2rem;
  color: #fff;
  background-color: rgba(0, 0, 0, 0.5);
  padding: 10px;
  border-radius: 15px;
  text-align: center;
  margin-top: 20px;
}

/* Select Element Styling */
select {
  background-color: #fff;
  color: #333;
  border-radius: 10px;
  border: 1px solid #ff7e5f;
  font-size: 1rem;
}
/* Style for the status dot */
.status-dot {
    display: inline-block;
    width: 12px;
    height: 12px;
    border-radius: 50%;  /* Makes it a circle */
    margin-right: 10px;  /* Space between the dot and the username */
    vertical-align: middle;  /* Align the dot vertically with the text */
}

/* Smooth transition for elements */
@keyframes fadeIn {
  0% {
    opacity: 0;
  }
  100% {
    opacity: 1;
  }
}

/* Animation for Buttons */
button, select, input {
  transition: transform 0.3s ease, background-color 0.3s ease;
}

button:hover, select:hover, input:hover {
  transform: translateY(-3px);
}

@keyframes slideIn {
  0% {
    transform: translateX(-100%);
  }
  100% {
    transform: translateX(0);
  }
}


/* Fullscreen button styling */
.fullscreen-icon {
    position: absolute;
  top: 10px;
  left: 100px;
  background-color: transparent;
  border: none;
  font-size: 24px;
  color: #333;
  cursor: pointer;
  z-index: 1000;
  transition: transform 0.2s ease-in-out;
}

/* Hover effect for fullscreen button */
.fullscreen-icon:hover {
    transform: scale(1.2);
    color: #4CAF50;
}

/* Fullscreen styles when in fullscreen mode */
.video-container.fullscreen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw; /* Take full width of the viewport */
    height: 100vh; /* Take full height of the viewport */
    z-index: 9999;
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0;
}

/* Fullscreen remote video (full screen on the body) */
.video#remote-video-container.fullscreen {
    width: 100vw; /* Remote video takes full width */
    height: 100vh; /* Remote video takes full height */
    max-width: none;
    max-height: none;
    z-index: 1; /* Ensure it's on top */
}

/* Small local video in fullscreen mode */
.video#my-video-container.fullscreen {
    width: 20vw;  /* 20% of the screen width */
    height: 20vh; /* 20% of the screen height */
    top: 10px;   /* Position it in a corner */
    left: 10px;  /* Position it in a corner */
    z-index: 999; /* Ensure it stays above other elements */
}


    /* Chat Container Styles */
    #chat-container {
            display: none; /* Initially hidden */
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 400px;
            height: 800px;
            background-color: #fff;
            border: 1px solid #ccc;
            box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            padding: 10px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
        }

        /* Toggle Button (Icon) */
        #toggle-chat-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #2678ccd1;
            color: white;
            border: none;
            border-radius: 50%;
            padding: 15px;
            font-size: 24px;
            cursor: pointer;
            z-index: 10000;
        }

        
/* Styling the red color for the mention count */
#mentionCount {
    position: absolute;
    top: -5px;
    right: -5px;
    font-size: 12px;
    color: red;
    background-color: white;
    border-radius: 50%;
    width: 18px;
    height: 18px;
    display: flex;
    justify-content: center;
    align-items: center;
    font-weight: bold;
    box-shadow: 0 0 3px rgba(0, 0, 0, 0.1); /* Optional: small shadow for better visibility */
}

/* Optionally, you can add styles for the icon or button itself */
.material-icons {
    font-size: 24px;
}

/* Ensure the icon image doesn't change its size */
.material-icons img {
    width: 30px;
    height: 30px;
    margin-bottom: -10px;
}
        /* User list (if needed) */
        .user-list {
            padding: 10px;
            background-color: #f7f7f7;
            border-bottom: 1px solid #ddd;
        }

        /* Message List */
        .message-list {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
            max-height: 600px;  /* Set max height to 300px to show 5 messages */
            margin-bottom: 10px;
        }

        .message {
    display: flex;  /* Flexbox layout for horizontal alignment */
    flex-direction: column; /* Stack the message header, content, and button vertically */
    margin-bottom: 10px;
    padding: 10px;
    border: 1px solid #ddd;
    border-radius: 5px;
    background-color: #f9f9f9;
}

.reply-count {
    color: #007bff;  /* Blue color for the reply count */
    cursor: pointer; /* Change cursor to pointer for clickable reply count */
    margin-top: 5px;
}

.replies-container {
    margin-top: 10px;
    padding-left: 20px;
}
.reply-btn {
    align-self: flex-end; /* Position the button at the end of the message */
    padding: 0;;
    font-size: 12px;
    background-color: #007bff00;
    color: white;
    border: none;
    border-radius: 50px;
    cursor: pointer;
    transition: background-color 0.3s ease;
    margin-top: -25px;
}

.reply-btn:hover {
    background-color: #84898f; /* Darker blue when hovered */
}
.reply {
    margin-bottom: 5px;
}

.reply-header {
    font-weight: bold;
}

.reply-time {
    font-size: 0.75em;
    color: #888;
}


.message-header {
    display: flex;
    align-items: center;
    margin-bottom: 5px;
}

.user-image {
    width: 30px;
    height: 30px;
    border-radius: 50%;
    margin-right: 10px;
}

        .username {
            font-weight: bold;
        }

        .message-content {
            margin-top: 5px;
        }

        .message-input {
            display: flex;
            align-items: center;
            padding: 10px;
            background-color: #f7f7f7;
            border-top: 1px solid #ddd;
        }

        .message-input input {
            flex: 1;
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #ccc;
            margin-right: 10px;
        }

        .message-input button {
            padding: 10px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
        }

        /* Room Selection Styling */
        .select-container {
            padding: 10px;
            background-color: #f7f7f7;
            border-top: 1px solid #ddd;
        }
        /* Style the user list container */
      /* Styling for the user list */
        .user-list {
            display: flex;  
            flex-wrap: nowrap;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            padding: 10px;
            background-color: #f7f7f7;
            border-bottom: 1px solid #ddd;
            max-width: 100%;
            scrollbar-width: thin;
        }

        .user-list::-webkit-scrollbar {
            height: 8px;
        }

        .user-list::-webkit-scrollbar-thumb {
            background: #ccc;
            border-radius: 4px;
        }

        .user-list::-webkit-scrollbar-track {
            background: transparent;
        }

        #userList {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
        }

        #userList li {
            display: inline-block;
            margin-right: 20px;
            font-size: 16px;
            font-weight: bold;
            color: #333;
            flex-shrink: 0;
            text-align: center;
            padding: 5px;
        }

        #userList li:hover {
            color: #007BFF;
            cursor: pointer;
        }

        .scroll-buttons {
            display: flex;
            justify-content: center;
            margin-top: 10px;
        }

        .scroll-buttons button {
            padding: 5px 10px;
            font-size: 16px;
            background-color: #007BFF;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 5px;
        }
/* Typing indicator style */
.typing-indicator {
    font-size: 10px;
    color: #666;
    display: inline-block;
    margin-top: 10px;
}

/* Style for messages where the logged-in user is mentioned */
.mentioned-message {
    background-color: #5cc3f459; /* Highlight background with yellow */
    border-radius: 5px;
    padding: 5px;
    margin-bottom: 10px; /* Adds space between messages */
}


#dots {
    display: inline-block;
    font-size: 10px;
    margin-left: 2px;
    position: relative;
}

.dot {
    display: inline-block;
    width: 2px;
    height: 2px;
    margin-right: 2px;
    background-color: #666;
    border-radius: 50%;
    opacity: 0;
    animation: wave 1.5s infinite ease-in-out;
}

/* Create the wave effect */
@keyframes wave {
    0%, 100% {
        opacity: 0;
        transform: scale(0.8);
    }
    50% {
        opacity: 1;
        transform: scale(1.2);
    }
}

/* Delay each dot's animation to create the wave effect */
.dot:nth-child(1) {
    animation-delay: 0s;
}

.dot:nth-child(2) {
    animation-delay: 0.2s;
}

.dot:nth-child(3) {
    animation-delay: 0.4s;
}

/* Optional: Style the message text */
#typingMessage {
    font-weight: bold;
}

#mentionDropdown {
    max-height: 150px;
    overflow-y: auto;
    width: 200px;
    border-radius: 5px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    background-color: white;
    z-index: 1000; /* Ensure it's on top of other elements */
    position: absolute; /* Position it under the input field */
}

#mentionDropdown li {
    padding: 8px;
    cursor: pointer;
}

#mentionDropdown li:hover {
    background-color: #f0f0f0;
}



#room-details {
  width: 80%;
  max-width: 900px;
  margin: 2rem auto;
  background-color: #fff;
  border-radius: 8px;
  padding: 2rem;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

#room-details.open {
  display: block;
  animation: fadeIn 0.5s ease-out;
}

#room-details p {
  font-size: 1.1rem;
  margin-bottom: 1rem;
}

#room-details strong {
  color: #2c3e50;
}

/* Clients List Styling */
#client-list {
  list-style: none;
  padding: 0;
}

#client-list li {
  font-size: 1rem;
  margin: 0.5rem 0;
  padding: 0.5rem;
  background-color: #ecf0f1;
  border-radius: 5px;
  transition: background-color 0.3s ease, transform 0.3s ease;
}

#client-list li:hover {
  background-color: #dfe6e9;
  transform: translateX(5px);
}

/* Animation for Fading In the Room Details */
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Responsive Design */
@media (max-width: 768px) {
  #room-details {
    width: 90%;
  }
}

#room-details h3 {
    text-align: center;
    color: #333;
}



#client-list {
    list-style-type: none;
    padding: 0;
}

#client-list li {
    margin: 10px 0;
    font-size: 14px;
}

#client-list button {
    margin-left: 10px;
    padding: 5px 10px;
    cursor: pointer;
    background-color: #4CAF50;
    color: white;
    border: none;
}

#client-list button:hover {
    background-color: #45a049;
}



/* Ratings Container */
#ratings-container {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 1.5rem;
  margin-top: 2rem;
}



#load-more-ratings {
  display: block;
  margin: 20px auto;
  padding: 10px 20px;
  background-color: #2980b9;
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  font-size: 16px;
  transition: background-color 0.3s ease;
}

#load-more-ratings:hover {
  background-color: #3498db;
}
.rating {
  background-color: #fff;
  border-radius: 8px;
  padding: 1.5rem;
  width: 80%;
  max-width: 700px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.rating:hover {
  transform: translateY(-5px);
  box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
}

.rating p {
  margin: 0.5rem 0;
}

.rating strong {
  color: #2c3e50;
}

/* Rating Form Styling */
#submit-rating-form {
  background-color: #fff;
  padding: 2rem;
  border-radius: 8px;
  width: 80%;
  max-width: 600px;
  margin: 2rem auto;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

#submit-rating-form:hover {
  transform: translateY(-5px);
  box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
}

#submit-rating-form h4 {
  margin-bottom: 1.5rem;
  font-size: 1.8rem;
  color: #333;
}

#submit-rating-form label {
  display: block;
  font-size: 1rem;
  margin-bottom: 0.5rem;
  color: #555;
}

#submit-rating-form input,
#submit-rating-form textarea {
  width: 100%;
  padding: 0.8rem;
  margin-bottom: 1rem;
  border: 1px solid #ddd;
  border-radius: 6px;
  font-size: 1rem;
  color: #333;
  transition: border 0.3s ease;
}

#submit-rating-form input:focus,
#submit-rating-form textarea:focus {
  border-color: #3498db;
  outline: none;
}

#submit-rating-form button {
  background-color: #3498db;
  color: #fff;
  padding: 1rem 2rem;
  font-size: 1.1rem;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: background-color 0.3s ease, transform 0.3s ease;
}

#submit-rating-form button:hover {
  background-color: #2980b9;
  transform: scale(1.05);
}

#submit-rating-form button:active {
  transform: scale(0.98);
}

/* Mobile Responsiveness */
@media (max-width: 768px) {
  #submit-rating-form {
    width: 90%;
  }

  .rating {
    width: 90%;
  }
}



/* Hotel Details Container */
#hotel-details {
  width: 80%;
  max-width: 900px;
  margin: 2rem auto;
  background-color: #fff;
  border-radius: 8px;
  padding: 2rem;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

#hotel-details:hover {
  transform: translateY(-5px);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
}

/* General Paragraph Styling inside hotel-details */
#hotel-details p {
  font-size: 1.1rem;
  margin-bottom: 1rem;
}

#hotel-details strong {
  color: #2c3e50;
}

/* Section Titles */
h3 {
  font-size: 1.8rem;
  color: #333;
  margin-top: 2rem;
  text-decoration: underline;
  text-align: center;
}

/* Hotel Images Section */
#hotel-images {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 1.5rem;
  margin-top: 1.5rem;
}

#hotel-images img {
  width: 100%;
  border-radius: 8px;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

#hotel-images img:hover {
  transform: scale(1.05);
  box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
}

/* Ratings Section */
/* Rating Container Styles */
#hotel-ratings {
  padding: 20px;
  background-color: #f9f9f9;
  border-radius: 10px;
}

.rating {
  background-color: #fff;
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 15px;
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.rating:hover {
  transform: translateY(-5px);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
}

.username-comment {
  font-size: 1.1rem;
  font-weight: bold;
  color: #2c3e50;
  cursor: pointer;
  margin: 0;
  transition: color 0.3s ease;
}

.username-comment:hover {
  color: #2980b9;
}

.rating-details {
  margin-top: 10px;
  padding-left: 20px;
  display: none;
  color: #7f8c8d;
}

.rating-details p {
  margin: 5px 0;
}

/* Optional: Style for when the details are expanded */
.rating-details p strong {
  color: #34495e;
}


.rating p {
  margin: 0.5rem 0;
}

.rating strong {
  color: #2c3e50;
}

/* Room Details Styling */
.room-detailsH {
  margin-top: 1.5rem;
  background-color: #fff;
  padding: 1.5rem;
  border-radius: 8px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  transition: transform 0.3s ease, opacity 0.3s ease;
}

.room-detailsH.open {
  display: block;
  animation: fadeIn 0.5s ease-out;
}

.room-detailsH ul {
  padding: 0;
  list-style: none;
}

.room-detailsH li {
  background-color: #ecf0f1;
  padding: 1rem;
  margin-bottom: 1rem;
  border-radius: 5px;
  transition: background-color 0.3s ease;
}

.room-detailsH li:hover {
  background-color: #dfe6e9;
}

.room-images-list img {
  border-radius: 5px;
  margin-top: 0.5rem;
  transition: transform 0.3s ease;
}

.room-images-list img:hover {
  transform: scale(1.1);
}

/* More Images Button */
.more-images-btn {
  display: block;
  margin-top: 1.5rem;
  padding: 10px 20px;
  font-size: 1rem;
  background-color: #2c3e50;
  color: #fff;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  transition: background-color 0.3s ease, transform 0.3s ease;
}

.more-images-btn:hover {
  background-color: #34495e;
  transform: translateY(-3px);
}

/* Toggle Room Images Button */
.room-images-btn {
  padding: 10px 20px;
  font-size: 1rem;
  background-color: #3498db;
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  transition: background-color 0.3s ease, transform 0.3s ease;
}

.room-images-btn:hover {
  background-color: #2980b9;
  transform: translateY(-3px);
}

/* Animation for Fading In */
@keyframes fadeIn {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

/* Responsive Design */
@media (max-width: 768px) {
  .room-detailsH {
    width: 90%;
  }
}

.room-detail-item {
  background-color: #fff;
  border-radius: 8px;
  padding: 1.5rem;
  width: 45%;
  box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

.room-detail-item:hover {
  transform: translateY(-5px);
  box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
}

.room-detail-item p {
  margin: 0.5rem 0;
}

.room-detail-item strong {
  color: #2c3e50;
}

/* Responsive Design */
@media (max-width: 768px) {
  #hotel-details {
    width: 90%;
  }

  .room-detail-item {
    width: 100%;
  }

  #hotel-images {
    grid-template-columns: 1fr;
  }
}


/* Room Type Image Container */
#room-type-container {
  background-color: #fff;
  padding: 1.5rem;
  border-radius: 8px;
  box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  margin-bottom: 1.5rem;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}

#room-type-container:hover {
  transform: translateY(-5px);
  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
}

#room-type-container img {
  border-radius: 8px;
  margin-top: 0.5rem;
  max-width: 100%;
  transition: transform 0.3s ease;
}

#room-type-container img:hover {
  transform: scale(1.05);
}

#room-type-container strong {
  font-weight: bold;
  color: #34495e;
}

#room-type-container p {
  color: #7f8c8d;
  font-size: 0.95rem;
  margin: 0.5rem 0;
}

#room-type-container .description {
  font-style: italic;
  color: #95a5a6;
}

/* Add Button Style (Optional for interaction) */
.more-images-btn {
  display: inline-block;
  padding: 10px 20px;
  font-size: 1rem;
  background-color: #2c3e50;
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  transition: background-color 0.3s ease, transform 0.3s ease;
  margin-top: 1rem;
}

.more-images-btn:hover {
  background-color: #34495e;
  transform: translateY(-3px);
}

/* Responsive Design */
@media (max-width: 768px) {
  #room-type-container {
    width: 90%;
  }
}

/* Full Star */
.star {
  color: #d3d3d3; /* Default gray color */
  font-size: 25px;
}

/* Yellow star for full rating */
.star.yellow {
  color: yellow;
}

/* Half Yellow Star (dynamically filled based on the rating percentage) */
.star.yellow-half {
  background: linear-gradient(90deg, yellow var(--yellow-percentage, 50%), #d3d3d3 0%);
  -webkit-background-clip: text;
  color: transparent;
}

/* Style for the average rating text */
.average-rating {
  font-size: 18px;
  margin-top: 10px;
  font-weight: bold;
}

.star-container {
  display: inline-block;
}

body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    line-height: 1.6;
    color: #333;
    text-align: right;
}

.navbar {
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

#haj-body .card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    margin-bottom: 20px;
    border: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

#haj-body .card:hover {
    transform: translateY(-5px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

#haj-body .card-title {
    color: #2c3e50;
    font-weight: 600;
}

#haj-body .btn-primary {
    background-color: #3498db;
    border-color: #3498db;
    transition: all 0.3s ease;
}

#haj-body .btn-primary:hover {
    background-color: #2980b9;
    border-color: #2980b9;
    transform: translateY(-2px);
}

.condition-item {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 15px;
    border-right: 4px solid #3498db;
}

.condition-item h4 {
    color: #2c3e50;
    margin-bottom: 10px;
    font-size: 1.2rem;
}

.condition-item p {
    margin-bottom: 0;
    color: #555;
}

.condition-item ul {
    margin-bottom: 0;
    padding-right: 20px;
}

.step-item {
    padding: 20px;
    margin-bottom: 15px;
    border-radius: 8px;
    background-color: #f8f9fa;
    border-right: 4px solid #3498db;
}

.step-item.completed {
    border-right-color: #2ecc71;
}

.step-item.current {
    border-right-color: #e74c3c;
    background-color: #fff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}

.step-number {
    display: inline-block;
    width: 30px;
    height: 30px;
    line-height: 30px;
    text-align: center;
    background-color: #3498db;
    color: white;
    border-radius: 50%;
    margin-left: 10px;
}

.step-item.completed .step-number {
    background-color: #2ecc71;
}

.step-item.current .step-number {
    background-color: #e74c3c;
}

h1, h2 {
    color: #2c3e50;
    font-weight: 600;
}

.lead {
    color: #7f8c8d;
}

footer {
    border-top: 1px solid #eee;
    padding: 20px 0;
    margin-top: 40px;
}

.sub-step {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    margin-top: 15px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.sub-step h4 {
    color: #2c3e50;
    margin-bottom: 15px;
    font-size: 1.2rem;
}

.progress {
    display: flex
;
    height: 1rem;
    overflow: hidden;
    font-size: .75rem;
    background-color: #e9ecef;
    border-radius: .25rem;
    flex-direction: row-reverse;
}

.progress-bar {
    background-color: #28a745;
    transition: width 0.3s ease;
}

.ihram-section {
    background-color: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    margin-bottom: 20px;
    border-right: 4px solid #3498db;
}

.ihram-section h3 {
    color: #2c3e50;
    margin-bottom: 15px;
    font-size: 1.4rem;
}

.ihram-section p {
    color: #555;
    line-height: 1.8;
    margin-bottom: 15px;
}

.ihram-section .card {
    border: none;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
}

.ihram-section .card-body {
    padding: 1.5rem;
}

.ihram-section h4 {
    color: #2c3e50;
    font-size: 1.2rem;
    margin: 1rem 0;
    padding-bottom: 0.5rem;
    border-bottom: 2px solid #3498db;
}

.ihram-section .alert {
    background-color: #e8f4f8;
    border-color: #b8e2f2;
    color: #2c3e50;
}

.ihram-section .alert h5 {
    color: #2c3e50;
    margin-bottom: 0.5rem;
}

.ihram-section .list-group-item {
    border-right: none;
    border-left: none;
    padding: 0.75rem 1.25rem;
    background-color: #fff;
    transition: all 0.3s ease;
}

.ihram-section .list-group-item:hover {
    background-color: #f8f9fa;
    transform: translateX(-5px);
    border-right: 3px solid #3498db;
}

.ihram-section .list-group-item:first-child {
    border-top: none;
}

.ihram-section .list-group-item:last-child {
    border-bottom: none;
}

.list-group-item {
    background-color: #fff;
    border: 1px solid rgba(0,0,0,.125);
    padding: 12px 20px;
    margin-bottom: 5px;
    border-radius: 4px;
    transition: all 0.3s ease;
}

.list-group-item:hover {
    background-color: #f8f9fa;
    transform: translateX(-5px);
}

.talbiyah-text {
   
    line-height: 2;
    color: #2c3e50;
    font-weight: 500;
    padding: 1rem;
    background-color: rgba(52, 152, 219, 0.1);
    border-radius: 8px;
    
}

.alert-primary {
    background-color: #e8f4f8;
    border-color: #b8e2f2;
    color: #2c3e50;
}

.alert-info {
    background-color: #e8f4f8;
    border-color: #b8e2f2;
    color: #2c3e50;
}

.card.bg-light {
    background-color: #f8f9fa !important;
    border: 1px solid #e9ecef;
}

.card.bg-light .list-group-item {
    background-color: transparent;
    border-color: #e9ecef;
}

.card.bg-light .list-group-item strong {
    color: #2c3e50;
    font-weight: 600;
}

.alert-info h5 {
    color: #2c3e50;
    font-weight: 600;
}

.alert-info p {
    font-size: 1.1rem;
    line-height: 1.6;
}

.text-muted {
    color: #6c757d !important;
    font-size: 0.9rem;
}

.card.bg-light .alert-primary {
    background-color: rgba(52, 152, 219, 0.1);
    border: none;
}

.card.bg-light .alert-primary .talbiyah-text {
    background-color: transparent;
    padding: 0.5rem;
}

.alert-warning {
    background-color: #fff3cd;
    border-color: #ffeeba;
    color: #856404;
}

.alert-warning h5 {
    color: #856404;
    font-weight: 600;
}

.ihram-section .alert-warning {
    background-color: #fff3cd;
    border-color: #ffeeba;
}

.ihram-section .alert-warning p {
    color: #856404;
    font-size: 1.1rem;
    line-height: 1.6;
}

.ihram-section .card.bg-light .alert-warning {
    background-color: #fff3cd;
    border: none;
}

.ihram-section .card.bg-light .list-group-item strong {
    color: #2c3e50;
    font-weight: 600;
    margin-left: 0.5rem;
}

.ihram-section .alert-primary ul {
    padding-right: 1.5rem;
}

.ihram-section .alert-primary ul li {
    margin-bottom: 0.5rem;
}

.ihram-section .alert-primary ul li:last-child {
    margin-bottom: 0;
}

/* Steps Timeline */
.steps-timeline {
    position: relative;
    padding: 20px 0;
}

.steps-timeline::before {
    content: '';
    position: absolute;
    top: 0;
    left: 50%;
    width: 2px;
    height: 100%;
    background: #e9ecef;
    transform: translateX(-50%);
}

.step-item {
    position: relative;
    margin-bottom: 30px;
    width: 100%;
}

.step-item::before {
    content: '';
    position: absolute;
    top: 20px;
    left: 50%;
    width: 20px;
    height: 20px;
    background: #fff;
    border: 2px solid #007bff;
    border-radius: 50%;
    transform: translateX(-50%);
    margin-left: 50%;
    margin-top: 5%;
}

.step-item.completed::before {
    background: #28a745;
    border-color: #28a745;
    margin-left: 50%;
    margin-top: 5%;
}

.step-item.active::before {
    background: #007bff;
    border-color: #007bff;
    box-shadow: 0 0 0 4px rgba(0, 123, 255, 0.2);
}

.step-content {
    background: #fff;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    margin-left: 50px;
    position: relative;
}

.step-content::before {
    content: '';
    position: absolute;
    top: 20px;
    left: -10px;
    width: 0;
    height: 0;
    border-top: 10px solid transparent;
    border-bottom: 10px solid transparent;
    border-right: 10px solid #fff;
}

/* Countdown Timer */
.countdown-timer {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 20px;
    margin: 20px 0;
}

.countdown-item {
    text-align: center;
    padding: 10px;
}

.countdown-item span {
    display: block;
}

.countdown-item span:first-child {
    font-size: 2rem;
    font-weight: bold;
    color: #007bff;
}

.countdown-label {
    font-size: 0.9rem;
    color: #6c757d;
    margin-top: 5px;
}

/* Current Step */
.current-step-content {
    background: #fff;
    border-radius: 8px;
    padding: 20px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.current-step-content .card {
    border: none;
    box-shadow: none;
}

.current-step-content .card-title {
    color: #007bff;
    margin-bottom: 15px;
}

.step-details {
    margin-top: 15px;
    padding-top: 15px;
    border-top: 1px solid #e9ecef;
}

.step-details p {
    margin-bottom: 5px;
    color: #6c757d;
}

/* Responsive Design */
@media (max-width: 768px) {
    .steps-timeline::before {
        left: 20px;
    }
    
    .step-item::before {
        left: 20px;
    }
    
    .step-content {
        margin-left: 50px;
    }
    
    .step-content::before {
        left: -10px;
        border-right: 10px solid #fff;
    }
    
    .countdown-item span:first-child {
        font-size: 1.5rem;
    }
} 

.btn.disabled {
    opacity: 0.65;
    cursor: not-allowed;
}
.countdown-display {
    margin-bottom: 1rem;
}
.countdown-display .alert {
    margin-bottom: 0;
}

.d-flex {
    display: flex !important
;
    flex-direction: row-reverse;
}

/* Logout Button with Icon */
#logoutButton {
  position: fixed;
  top: 0px;
  right: 0px;
  background-color: #13a137;
  color: white;
  border: none;
  padding: 10px;
  border-radius: 50%;
  font-size: 1.5rem;
  cursor: pointer;
  display: flex;
  justify-content: center;
  align-items: center;
  transition: background-color 0.3s ease, transform 0.3s ease;
  z-index: 11110;
}

#logoutButton i {
  font-size: 1.5rem; /* Adjust icon size */
}

#logoutButton:hover {
  background-color: #ff4e50;
  transform: scale(1.1);
}

#logoutButton:focus {
  outline: none;
}
/* Style for the refresh button */
#refreshButton {
   position: fixed;
  top: 0px;
  left:  0px;
  background-color: #eddede; /* Transparent background */
   border: none;
  padding: 10px;
  border-radius: 50%;
  font-size: 1.5rem;
  cursor: pointer;
  display: flex;
  justify-content: center;
  align-items: center;
  transition: background-color 0.3s ease, transform 0.3s ease;
  z-index: 11110;
}

#refreshButton:hover {
  transform: scale(1.2); /* Slightly increase the size on hover */
  color: #4CAF50; /* Change color on hover */
}
 /* Navbar Styling */
  nav {
      background-color: #333;
      padding: 10px 0;
      position: fixed;
      top: 0;
      width: 100%;
      z-index: 1111;
    }

    nav .nav-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    nav ul {
      list-style: none;
      margin: 0;
      padding: 0;
      text-align: center;
      display: flex;
    }

    nav ul li {
      margin: 0 20px;
    }

    nav ul li a {
      color: white;
      text-decoration: none;
      padding: 10px 20px;
      font-size: 18px;
      display: inline-block;
      border-radius: 4px;
      transition: background-color 0.3s ease, transform 0.3s ease, color 0.3s ease;
    }

    /* Navbar links hover effects */
    nav ul li a:hover {
      background-color: #575757;
      color: #fff;
      transform: translateY(-2px);
    }

    /* Active link effect */
    nav ul li a.active {
      background-color: #444;
      color: #ffcc00;
      transform: translateY(-2px);
    }

    /* Responsive Design */
    @media screen and (max-width: 600px) {
      nav ul {
        display: none;
        flex-direction: column;
        position: absolute;
        top: 100%;
        left: 0;
        width: 100%;
        background-color: #333;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      }

      nav ul li {
        margin: 10px 0;
      }

      nav .menu-toggle {
        display: block;
        color: white;
        cursor: pointer;
        padding: 10px;
        margin-top: -8px;
      }
      #refreshButton {
        left: 80px;
      }
     
    }

    /* Animation for links */
    @keyframes fadeInUp {
      0% {
        opacity: 0;
        transform: translateY(20px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }

    nav ul li a {
      animation: fadeInUp 0.6s ease-out forwards;
    }

    /* Staggered Animation Delays */
    nav ul li a:nth-child(1) {
      animation-delay: 0.1s;
    }

    nav ul li a:nth-child(2) {
      animation-delay: 0.2s;
    }

    nav ul li a:nth-child(3) {
      animation-delay: 0.3s;
    }

    </style>
  </head>
  <body>
      <nav>
        <div class="nav-container">
            <div class="menu-toggle">
                <i class="fas fa-bars"></i>
            </div>
            <ul>
                <li><a href="client-dashboard.html">Home</a></li>
                <li><a href="clientWalkToMasjid.html">Macca Map</a></li>
                <li><a href="clientWalkToMasjid2.html">Medina Map</a></li>
            </ul>
        </div>
      </nav>
    <button id="logoutButton">
        <i class="fas fa-sign-out-alt"></i> <!-- Font Awesome logout icon -->
      </button>
      <button id="refreshButton" class="refresh-icon">
        <i class="fas fa-sync-alt"></i> <!-- Font Awesome refresh icon -->
      </button>
    <h1 style="margin-top: 50px;">Welcome, <span id="clientName"></span> - Family Tracker</h1>
   
    <!-- Admin Details Toggle -->
<div id="details-admin" class="toggle-btn">Admin details</div>
<div id="adminDetails" class="hidden">
  <!-- Admin details will be populated here -->
  <p id="adminInfo">Admin Name: John Doe</p>
  <button id="copyButton">Copy Admin Info</button>
</div>
    <!-- Security Code Section -->
    <div id="securityCodeContainer">
      <h2>Your Security Code:</h2>
      <p id="securityCode">Loading...</p>
    </div>
    <h2 id="ipAddress">IP Address: Not Available</h2>
    <h2 id="macAddress">MAC Address: Not Available</h2>

    <!-- Input for Phone Number -->
    <label for="phoneNumber">Enter Phone Number:</label>
    <input type="text" id="phoneNumber" placeholder="Enter phone number" />

    <!-- Button to send SMS -->
    <button id="sendSMSBtn">Send Location via SMS</button>

    <!-- Internet connection status toggle -->
    <div id="connectionStatus" class="status-toggle offline">Internet: OFF</div>

    <!-- Location Result -->
    <div id="locationResult" class="location-result"></div>

    <h1>Device Information</h1>

    <p id="batteryInfo">Battery Info: Loading...</p>

    <!-- Device Info Display -->
    <div id="deviceInfo">
      <h1>SIM and Network Information</h1>
      <p id="simInfo">SIM Info: Loading...</p>
      <p id="networkInfo">Network Info: Loading...</p>
      <p id="deviceDetails">Device Info: Loading...</p>
    </div>

    <div id="help-buttos">
      <button id="emergencyButton">SOS</button>
    <!-- Example HTML buttons to select destination -->
    <button onclick="setDestination('mina')">Mina</button>
    <button onclick="setDestination('jamarat')">Jamarat</button>
    <button onclick="setDestination('kaaba')">Kaaba</button>
    <!-- Health Notification Button -->
    <button id="healthAlertButton">I am feeling unwell</button>
    </div>
    <!-- Incoming Call Section -->
    <div class="call-status">
      <h2>Incoming Audio Call</h2>
      <p id="callMessage" style="display: none">You have an incoming call...</p>
      <button id="acceptCallButton" style="display: none">Accept Call</button>
      <button id="rejectCallButton" style="display: none">Reject Call</button>
    </div>

  
  <!-- For calling the admin -->
  
  <!-- For answering the call from admin -->
  <div id="incoming-call-container" style="display: none;">
      <span id="caller-name">Admin is calling...</span>
      <button id="answer-call-button">Answer</button>
      <button id="reject-call-button">Reject</button>
  </div>
  
  <!-- For ending the call -->
  <button id="end-call-button" style="display: none;">End Call</button>
  
  <!-- Mute and Camera Control buttons -->
  <div id="control-buttons" style="display: none;">
      <button id="mute-button">Mute</button>
      <button id="camera-button">Turn Off Camera</button>
  </div>
  
    <div id="callTimer" style="display: none">00:00</div>
    <!-- Timer Display -->
    <!-- Call in Progress Section (Visible only after accepting the call) -->
    <div id="callInProgress" style="display: none">
      <h2>In Call...</h2>

      <button id="endCallButton">End Call</button>
      <button id="muteButton">Mute</button>
      <canvas id="soundWave" width="500" height="100"></canvas>
      <audio id="audioCall" controls style="display: none">
        <source id="audioSource" type="audio/wav" />
      </audio>
    </div>
    <div id="connection-status">Status: Online</div>
   
    <!-- Incoming Call UI -->
    <div id="incoming-call-container" style="display: none;">
        <p id="caller-name">Admin</p>
        <button id="answer-call-button">Answer Call</button>
        <button id="reject-call-button">Reject Call</button>
    </div>

    <div class="myId">
      <label for="name" style="display: none;">Name:</label>
      <input style="display: none;" type="text" id="name" placeholder="Enter your name" style="margin-bottom: 20px;">
      <button style="display: none;" id="copy-id" onclick="copyToClipboard()" style="margin-bottom: 2rem;">Copy ID</button>
      
      <input style="display: none;" type="text" id="idToCall" placeholder="ID to call">
      <h2 id="callTheAdmin"></h2>
      <div class="call-button">
          <button id="start-call">Start Call</button>
      </div>
  </div>

  <!-- Caller Container (Displays when someone is calling) -->
  <div id="caller-container" style="display: none;">
      <h1 id="caller-name"></h1>
      <button id="answer-call">Answer</button>
  </div>

  <!-- After Call UI (Visible once the call is answered) -->
  <div id="after-answer" style="display: none;">
      <h2 id="you-live-with-name">You live with </h2>
      <button id="mute-button" onclick="toggleMute()">Mute</button>
      <button id="camera-button" onclick="toggleCamera()">Turn Off Camera</button>
      <button id="end-call">End Call</button>
  </div>
    <div class="video-container" id="video-call-container" style="display: none;">
      <button id="fullscreenButton" class="fullscreen-icon">
        <i class="fas fa-expand"></i> <!-- Fullscreen icon -->
    </button>
      <div class="video" id="my-video-container" style="width: 100px;height: 100px;/* margin-top: 10px; *//* margin-left: 300px; */z-index: 1;position: fixed;top: 50px;left: 80px;">
        <!-- Local Video Placeholder -->
        <div id="local-video-placeholder" class="video-placeholder" style="display: block;">
            <span id="video-icon" style="font-size: 20px; color: #ccc;"></span>
        </div>
        <!-- Actual Local Video (hidden by default) -->
        <video id="my-video" playsinline="" muted=""  autoplay=""></video>
    </div>

    <div class="video" id="remote-video-container" style="margin-left: 45px; margin-top: -105px; display: block;">
      <!-- Remote Video (hidden by default) -->
      <video id="user-video" playsinline="" style="width: 300px;" autoplay=""></video>
  </div>
  </div>
  <button id="profileBtn">Profile</button>

<!-- Profile container (hidden initially) -->
<div id="profileContainer" style="display:none; padding: 20px; border: 1px solid #ddd; background-color: #f9f9f9;">
    <h2>Client Profile</h2>
    <p><strong>Username:</strong> <span id="profileUsername"></span></p>
    <p><strong>Email:</strong> <span id="profileEmail"></span></p>
    <p><strong>Phone Number:</strong> <span id="profilePhoneNumber"></span></p>
    <p><strong>Age:</strong> <span id="profileAge"></span></p>
    <p><strong>Gender:</strong> <span id="profileGender"></span></p>
    <p><strong>First Name:</strong> <span id="profileFirstName"></span></p>
    <p><strong>Last Name:</strong> <span id="profileLastName"></span></p>
    <p><strong>Security Code:</strong> <span id="profileSecurityCode"></span></p>
    <p><strong>Status:</strong> <span id="profileStatus"></span></p>

    <h3>Group Info</h3>
    <p><strong>Group Name:</strong> <span id="profileGroupName"></span></p>

    <h3>Trip Info</h3>
    <p><strong>Flight Number:</strong> <span id="profileFlightNumber"></span></p>
    <p><strong>Hotel Name:</strong> <span id="profileHotelName"></span></p>
    <p><strong>Room Number:</strong> <span id="profileRoomNumber"></span></p>
    <p><strong>Arafa Khayma:</strong> <span id="profileArafaKhayma"></span></p>
    <p><strong>Mina Khayma:</strong> <span id="profileMinaKhayma"></span></p>

      <!-- QR Code Display -->
      <div id="qrCodeContainer">
        <h3>Profile QR Code</h3>
        <div id="qrCode"></div>
    </div>
    <!-- Close button -->
    <button id="closeProfileBtn">Close</button>
</div>

  <h2>Route to Parent</h2>
  <p>Select your transport mode:</p>
  <select id="transportSelect">
    <option value="foot">Walking</option>
    <option value="car">Car</option>
    <option value="bike">Bicycle</option>
    <option value="bus">Public Transport</option>
  </select>

  <div id="map" style="height: 400px; width: 100%"></div>
  <div id="status-indicator"></div> <!-- Shows if admin is online or offline -->


  <div id="tripInfo"></div>

  <h2>Your Group Information</h2>
<div id="group-info">
    <p>Loading...</p>
</div>
<div class="container mt-5">
<div id="
haj-body" >
<div id="gender-selection" class="mb-4" style="display: none;">
    <label class="form-label">اختر الجنس:</label>
    <div class="form-check form-check-inline">
      <input class="form-check-input" type="radio" name="gender" id="genderMale" value="male">
      <label class="form-check-label" for="genderMale">ذكر</label>
    </div>
    <div class="form-check form-check-inline">
      <input class="form-check-input" type="radio" name="gender" id="genderFemale" value="female">
      <label class="form-check-label" for="genderFemale">أنثى</label>
    </div>
  </div>
  
  <div id="progress-map" class="mb-4 text-center"></div>
 <div id="hajj-map" style="height: 400px; width: 100%; margin-bottom: 20px;"></div>
  <section id="steps" class="mb-5">
      <h2 class="text-center mb-4">خطوات الحج</h2>
      <div class="row">
          <div class="col-md-8 mx-auto">
              <div class="card">
                  <div class="card-body">
                    
                      
                      <div id="countdown" class="text-center mb-4">
                          <h4>الوقت المتبقي</h4>
                          <div class="countdown-timer">
                              <div class="row">
                                  <div class="col">
                                      <div class="countdown-item">
                                          <span id="days">00</span>
                                          <span class="countdown-label">أيام</span>
                                      </div>
                                  </div>
                                  <div class="col">
                                      <div class="countdown-item">
                                          <span id="hours">00</span>
                                          <span class="countdown-label">ساعات</span>
                                      </div>
                                  </div>
                                  <div class="col">
                                      <div class="countdown-item">
                                          <span id="minutes">00</span>
                                          <span class="countdown-label">دقائق</span>
                                      </div>
                                  </div>
                                  <div class="col">
                                      <div class="countdown-item">
                                          <span id="seconds">00</span>
                                          <span class="countdown-label">ثواني</span>
                                      </div>
                                  </div>
                              </div>
                          </div>
                      </div>

                      <div id="stepsList" class="mt-4">
                          <h4>خطوات الحج</h4>
                          <div class="steps-timeline">
                              <!-- Steps will be loaded here -->
                          </div>
                      </div>

                      <div id="steps-container" class="mt-4">
                          <!-- Steps from updateSteps() will be rendered here -->
                      </div>

                  

                  </div>
              </div>
          </div>
      </div>
  </section>
</div>
</div>
     <!-- Toggle Button -->
     <button id="toggle-chat-btn" onclick="toggleChat()">
      <span class="material-icons"><img src="img/chat.png" style="width: 30px; height: 30px; margin-bottom: -10px;"></span> <!-- Chat Icon -->
  </button>

  <!-- Chat Container -->
  <div id="chat-container" style="display: none;">
      <!-- User List -->
      <div class="user-list">
          <ul id="userList">
              <!-- Dynamic user list goes here -->
          </ul>
      </div>
      <div class="scroll-buttons">
          <button id="scroll-left">←</button>
          <button id="scroll-right">→</button>
      </div>

      <!-- Messages List -->
      <div class="message-list" id="messageList">
          <!-- Dynamic messages go here -->
      </div>
      <div id="typingIndicator" class="typing-indicator" style="display: none;">
        <!-- Initially, we'll just show the text; dots will be added via CSS animation -->
        <span id="typingMessage"></span>
        <span id="dots">
            <span class="dot"></span>
            <span class="dot"></span>
            <span class="dot"></span>
        </span>
    </div>
          <!-- Input Area -->
      <div class="message-input">
          <form id="chatForm">
              <input type="text" id="inputMessage" placeholder="Type your message...">
              <!-- Dropdown for showing mentions -->
<ul id="mentionDropdown" style="display: none; position: absolute; list-style: none; background-color: white; border: 1px solid #ccc; padding: 0; margin: 0;">
  <!-- User list will be dynamically added here -->
</ul>
              <button type="submit" id="sendButton">Send</button>
              <img src="https://icons.getbootstrap.com/assets/icons/emoji-smile.svg" id="emojiPicker" alt="emoji" style="cursor: pointer;">
              <div id="emojiPickerContainer" style="display:none;">
                  <div class="emoji" data-emoji="😊">😊</div>
                  <div class="emoji" data-emoji="😎">😎</div>
                  <div class="emoji" data-emoji="😂">😂</div>
                  <div class="emoji" data-emoji="🤖">🤖</div>
                  <!-- Add more emojis as needed -->
              </div>
                      </form>
      </div>
      <!-- Typing Indicator (Hidden by default) -->



      <!-- Room Selection -->
      <div class="select-container">
          <p id="roomSelect">
              <!-- Dynamic rooms go here -->
          </p>
      </div>
      
  </div>

<!-- Toggle Button to show/hide room details -->
<!-- Toggle Button to show/hide room details -->
<button id="toggle-room-details">Show Room Details</button>

<!-- Room details container (Initially hidden) -->
<div id="room-details" style="display:none;">
  <h3>Room Details</h3>
  <p><strong>Room Number:</strong> <span id="room-number-detail"></span></p>
  <p><strong>Hotel Name:</strong> <span id="hotel-name-detail"></span></p>
  <p><strong>Level:</strong> <span id="room-level"></span></p>
  <p><strong>Start Date:</strong> <span id="start-date"></span></p>
  <p><strong>End Date:</strong> <span id="end-date"></span></p>

  <h4>Clients in this room:</h4>
  <ul id="client-list">
      <!-- Clients will be dynamically populated here -->
  </ul>
</div>


<h3>Hotel Ratings and Feedback</h3>

<!-- Display existing ratings -->
<div id="ratings-container">
    <!-- Ratings will be displayed here -->
</div>

<!-- Rating form for submitting feedback -->
<div id="submit-rating-form">
  <h4>Rate the Hotel</h4>
  <label for="rating">Rating (1 to 5):</label>
  <input type="number" id="rating" min="1" max="5" required>

  <label for="comment">Comment:</label>
  <textarea id="comment" rows="4" cols="50"></textarea>

  <button id="submit-rating-btn">Submit Rating</button>
</div>

<h2>Hotel Details</h2>
<div id="hotel-details">
  <p><strong>Hotel Name:</strong> <span id="hotel-name"></span></p>
  <p><strong>Location:</strong> <span id="hotel-location"></span></p>
  <p><strong>latitude:</strong> <span id="hotel-latitude"></span></p>
  <p><strong>longitude:</strong> <span id="hotel-longitude"></span></p>
  <p><strong>Manager:</strong> <span id="hotel-manager"></span></p>
  <p><strong>Contact Info:</strong> <span id="hotel-contact"></span></p>
  <p><strong>Capacity:</strong> <span id="hotel-capacity"></span></p>
  <p><strong>Rooms Available:</strong> <span id="rooms-available"></span></p>
  <h3>Hotel Images</h3>
  <div id="hotel-images">
      <!-- Hotel images will be displayed here -->
  </div>
  <h3>Hotel Ratings</h3>
  <div id="hotel-ratings">
    <!-- Ratings will be dynamically displayed here -->
  </div>
  
  <button id="load-more-ratings" style="display: none;">Load More Ratings</button>
  
  <h3>Room Details</h3>
  <div class="room-detailsH" id="room-detailsH">
      <!-- Room details will be displayed here -->
  </div>
</div>






<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet-routing-machine/3.2.0/leaflet-routing-machine.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/cordova-plugin-wifi-manager/www/wifiManager.js"></script>
   
    <script src="cordova.js"></script>
    <script src="./hotel.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.socket.io/4.0.1/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/simple-peer@9.10.0/simplepeer.min.js"></script>    
    
    <script>

        
      // Select the elements
// Toggle the visibility of the admin details when clicking on "Admin details"
const detailsAdmin = document.getElementById('details-admin');
const adminDetails = document.getElementById('adminDetails');
const copyButton = document.getElementById('copyButton');
const adminInfo = document.getElementById('adminInfo');





// Toggle the admin details visibility on click
detailsAdmin.addEventListener('click', function() {
  // Toggle the hidden class to show/hide admin details
  adminDetails.classList.toggle('hidden');
});
const clientStatus = localStorage.getItem('offlineStatus')
// Copy the admin information when the "Copy Admin Info" button is clicked
copyButton.addEventListener('click', function() {
  const textToCopy = adminInfo.textContent || adminInfo.innerText;
  const textarea = document.createElement('textarea');
  textarea.value = textToCopy;
  document.body.appendChild(textarea);
  textarea.select();
  document.execCommand('copy');
  document.body.removeChild(textarea);

  // Optionally, show a message or style change after copying
  alert('Admin info copied to clipboard!');
});

   // Client-Side: Connecting to the WebSocket server
   const socket = io("https://my-node-backend-fcdy.onrender.com", {
        transports: ["websocket"],
      });
const clientId = localStorage.getItem("clientId"); // Retrieve clientId from localStorage
const firstName = localStorage.getItem("firstName")
const lastName = localStorage.getItem("lastName")
let cachedProfileData = null;

        // Function to fetch the client data without Cache-Control
function fetchClientData(clientId) {
    return fetch(`https://my-node-backend-fcdy.onrender.com/client/${clientId}`, {
        method: 'GET',
        // Remove the Cache-Control header
        // headers: { 'Cache-Control': 'no-cache', 'Pragma': 'no-cache' }, // Do not send this header
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.profile) {
            console.log('Fetched client data:', data.profile);
            return data.profile;  // Return the client profile data
        } else {
            throw new Error('Client data not found');
        }
    })
    .catch(error => {
        console.error('Error fetching client data:', error);
    });
}

        // Function to fetch the group data using groupId
        function fetchGroupData(groupId) {
            return fetch(`https://my-node-backend-fcdy.onrender.com/groups/${groupId}`)
                .then(response => response.json())
                .then(groupData => {
                    if (groupData.success && groupData.group) {
                        return groupData.group; // Return group data
                    } else {
                        throw new Error('Group data not found');
                    }
                })
                .catch(error => {
                    console.error('Error fetching group data:', error);
                });
        }

            // Fetch Trip Info using clientId
    function fetchTripInfoA(clientId) {
        console.log(`Fetching trip info for client ${clientId}`);
        return fetch(`https://my-node-backend-fcdy.onrender.com/tripInfo/${clientId}`)
            .then(response => response.json())
            .then(tripInfoData => {
                console.log("Trip Info Response:", tripInfoData); // Log the entire response
                if (tripInfoData.success && tripInfoData.tripInfo) {
                    return tripInfoData.tripInfo; // Return trip info data
                } else {
                    console.error('Trip info not found or incorrect response structure');
                    throw new Error('Trip info not found');
                }
            })
            .catch(error => {
                console.error('Error fetching trip info:', error);
            });
    }

 // Function to fetch and cache all the profile data
 function fetchAllData() {
        console.log("Fetching all data...");
        return fetchClientData(clientId)
            .then(clientData => {
                const groupId = clientData.group._id;
                const clientIdForTrip = clientData.client._id;
                console.log("Client Data:", clientData); // Log the client data to verify the structure
                console.log("Fetching tripInfo from ID: ", clientIdForTrip);
                return Promise.all([
                    Promise.resolve(clientData), // Return client data
                    fetchGroupData(groupId),      // Fetch group data
                    fetchTripInfoA(clientIdForTrip)       // Fetch trip info data
                ]);
            })
            .then(([clientData, groupData, tripInfoData]) => {
                console.log("All Data:", { clientData, groupData, tripInfoData }); // Log all the data
                // Return all data in a single object
                return {
                    client: clientData,
                    group: groupData,
                    tripInfo: tripInfoData
                };
            })
            .catch(error => {
                console.error('Error fetching all data:', error);
            });
    }

    // Fetch the profile data once when the client logs in (or page loads)
    window.addEventListener('load', () => {
        console.log("Page loaded, fetching all data...");
        
        fetchAllData().then(data => {
            if (data) {
                console.log("Cached Profile Data: ", data); // Log the cached data
                // Cache the data for future use
                cachedProfileData = data;
            }
        });
    });

        // Handle the profile button click
        document.getElementById('profileBtn').addEventListener('click', function() {
            document.getElementById('profileContainer').style.display = 'block';

            if (cachedProfileData) {
                // If data is cached, directly render it
                renderProfile(cachedProfileData);
            } else {
                // Otherwise, fetch the data first
                fetchAllData().then(data => {
                    if (data) {
                        renderProfile(data);
                    }
                });
            }
        });

        // Function to render the profile data and generate a QR code
function renderProfile(data) {
    const { client, group, tripInfo } = data;
    console.log(data);

    // Fill the profile container with client data
    document.getElementById('profileUsername').innerText = client.client.username;
    document.getElementById('profileEmail').innerText = client.client.email;
    document.getElementById('profilePhoneNumber').innerText = client.client.phoneNumber;
    document.getElementById('profileAge').innerText = client.client.age;
    document.getElementById('profileGender').innerText = client.client.gender;
    document.getElementById('profileFirstName').innerText = client.client.firstName;
    document.getElementById('profileLastName').innerText = client.client.lastName;
    document.getElementById('profileSecurityCode').innerText = client.client.securityCode;
    document.getElementById('profileStatus').innerText = clientStatus;

    // Fill the group data
    document.getElementById('profileGroupName').innerText = group ? group.groupName : 'No group';

    // Fill the trip info data
    document.getElementById('profileFlightNumber').innerText = tripInfo?.flightInfo?.flightNumber || 'Not available';
    document.getElementById('profileHotelName').innerText = tripInfo?.hotelInfo?.hotelName || 'Not available';
    document.getElementById('profileRoomNumber').innerText = tripInfo?.hotelInfo?.roomNumber || 'Not available';
    document.getElementById('profileArafaKhayma').innerText = tripInfo?.arafaKhayma || 'Not available';
    document.getElementById('profileMinaKhayma').innerText = tripInfo?.minaKhayma || 'Not available';
roomGroup = group.groupName
    // Format the string for QR Code
    const qrData = `
Client Profile
Username: ${client.client.username}
Email: ${client.client.email}
Phone Number: ${client.client.phoneNumber}
Age: ${client.client.age}
Gender: ${client.client.gender}
First Name: ${client.client.firstName}
Last Name: ${client.client.lastName}
Security Code: ${client.client.securityCode}
Status: ${clientStatus}
Group Info
Group Name: ${group ? group.groupName : 'No group'}

Trip Info
Flight Number: ${tripInfo?.flightInfo?.flightNumber || 'Not available'}
Hotel Name: ${tripInfo?.hotelInfo?.hotelName || 'Not available'}
Room Number: ${tripInfo?.hotelInfo?.roomNumber || 'Not available'}
Arafa Khayma: ${tripInfo?.arafaKhayma || 'Not available'}
Mina Khayma: ${tripInfo?.minaKhayma || 'Not available'}
`;

    // Clear any existing QR code in the container
    const qrContainer = document.getElementById("qrCode");
    qrContainer.innerHTML = '';  // This will remove any previous QR code

    // Generate the QR code
    new QRCode(qrContainer, {
        text: qrData,
        width: 256,   // Increased width
        height: 256,  // Increased height
        colorDark: "#000000",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.M,  // Lower error correction level for easier scanning
    });
}

        // Close profile container when close button is clicked
        document.getElementById('closeProfileBtn').addEventListener('click', function() {
            document.getElementById('profileContainer').style.display = 'none';
        });


// Fetch client's trip information
function fetchTripInfo() {
    fetch(`https://my-node-backend-fcdy.onrender.com/tripInfo/${clientId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const tripInfo = data.tripInfo;
                const tripInfoElement = document.getElementById('tripInfo');
                
                // Update flight info
                tripInfoElement.innerHTML = `
                    <h2>Flight Info</h2>
                    <p>Seat: ${tripInfo.flightInfo.seat}</p>
                    <h2>Hotel Info</h2>
                    <p>Room Number: ${tripInfo.hotelInfo.roomNumber}</p>
                `;

             
            }
        })
        .catch(error => {
            console.error('Error fetching trip info:', error);
        });
}

// Initialize
fetchTripInfo();

      
      
      
      let callStartTime = null; // To track when the call starts
      let callInterval = null; // To handle the setInterval for updating the timer
      let elapsedTime = 0; // To keep track of the elapsed time in seconds
      // Ensure that clientId is retrieved properly from localStorage on the client page
      const adminId = localStorage.getItem("adminId"); // This should be null for clients
      const token = localStorage.getItem("token"); // Get the JWT token from localStorage

      if (!clientId) {
        alert("Client is not logged in!");
        window.location.href = "index.html"; // Redirect to login if clientId is not found
      } else {
        console.log("Client ID:", clientId);
        fetchClientGroup(clientId);
        // You can now use the clientId for WebSocket connections
      }
      const clientName = localStorage.getItem("username");
      const securityCode = localStorage.getItem("securityCode");

      const groupId = localStorage.getItem('group')


      // Function to fetch the client's group and its details
async function fetchClientGroup(clientId) {
    try {
        const response = await fetch(`https://my-node-backend-fcdy.onrender.com/client-group/${clientId}`);
        const data = await response.json();

        if (data.success) {
            // Successfully fetched group details
            const { groupId, groupName, tripDetails } = data;
            localStorage.setItem("groupId", groupId);  // Store the groupId in localStorage for future use
            localStorage.setItem("groupName", groupName);  // Store the groupName as well

            // Now, fetch the full group details
            fetchGroupDetails(groupId);  // Assuming fetchGroupDetails is already implemented
            fetchHajSteps(groupId);

        } else {
            alert('Failed to load group details');
        }
    } catch (error) {
        console.error('Error fetching client group:', error);
        alert('Error fetching client group');
    }
}

// Function to fetch group details from the server
async function fetchGroupDetails(groupId) {
    try {
        const response = await fetch(`https://my-node-backend-fcdy.onrender.com/group-details/${groupId}`);
        const data = await response.json();

        if (data.success) {
            displayGroupDetails(data.group);
        } else {
            alert('Failed to load group details');
        }
    } catch (error) {
        console.error('Error fetching group details:', error);
        alert('Error fetching group details');
    }
}

// Function to display group details
// Function to display group details on the page
function displayGroupDetails(group) {
    const groupInfoDiv = document.getElementById('group-info');
    localStorage.setItem('hotelLongitude', group.tripDetails.hotelInfo.coordinates.longitude);
    localStorage.setItem('hotelLatitude', group.tripDetails.hotelInfo.coordinates.latitude);

    groupInfoDiv.innerHTML = `
       <h2>Group Name: ${group.groupName}</h2>
       <h2>Flight Information:</h2>
       <ul>
           <li><strong>Flight Number:</strong> ${group.tripDetails.flightInfo.flightNumber}</li>
           <li><strong>Departure Time:</strong> ${new Date(group.tripDetails.flightInfo.departureTime).toLocaleString()}</li>
           <li><strong>Arrival Time:</strong> ${new Date(group.tripDetails.flightInfo.arrivalTime).toLocaleString()}</li>
           <li><strong>Departure Airport:</strong> ${group.tripDetails.flightInfo.departureAirport}</li>
           <li><strong>Arrival Airport:</strong> ${group.tripDetails.flightInfo.arrivalAirport}</li>
       </ul>

       <h2>Bus Information:</h2>
       <ul>
           <li><strong>Departure Time:</strong> ${new Date(group.tripDetails.busInfo.departureTime).toLocaleString()}</li>
           <li><strong>Departure Place:</strong> ${group.tripDetails.busInfo.departurePlace}</li>
           <li><strong>Destination:</strong> ${group.tripDetails.busInfo.destination}</li>
       </ul>

       <h2>Hotel Information:</h2>
       <ul>
           <li><strong>Hotel Name:</strong> ${group.tripDetails.hotelInfo.hotelName}</li>
           <li><strong>Location:</strong> ${group.tripDetails.hotelInfo.location}</li>
           <li><strong>latitude:</strong> ${group.tripDetails.hotelInfo.coordinates.latitude}</li>
           <li><strong>longitude:</strong> ${group.tripDetails.hotelInfo.coordinates.longitude}</li>
           <li><strong>Check-In Time:</strong> ${new Date(group.tripDetails.hotelInfo.checkInTime).toLocaleString()}</li>
           <li><strong>Check-Out Time:</strong> ${new Date(group.tripDetails.hotelInfo.checkOutTime).toLocaleString()}</li>
       </ul>

       <h2>Food Plan:</h2>
       <ul>
           ${group.tripDetails.foodPlan.map(plan => `
               <li><strong>Day:</strong> ${plan.day}</li>
               <ul>
                   ${plan.meals.map(meal => `<li>${meal}</li>`).join('')}
               </ul>
           `).join('')}
       </ul>
   `;
}
// Fetch the group details when the page loads
fetchGroupDetails(groupId);

      if (!clientName || !clientId || !securityCode) {
        alert("Client not logged in or missing information!");
        window.location.href = "index.html"; // Redirect to login
      }

      document.getElementById("clientName").textContent = clientName;
      document.getElementById("securityCode").textContent = securityCode;

      let isCallPending = false;
      let isMuted = false; // Track mute status
      let mediaStream = null; // To hold the media stream

   

      if (clientId) {
        socket.emit("joinClientRoom", clientId);
        console.log(`Client with ID ${clientId} has joined the room`);
         socket.on('clientStatusUpdated', (data) => {
        console.log(`Client ${data.clientId} is now ${data.status}`);
    });
      }

      let storedAdminName = null
let storedadminSocketId  = null
      let storedAdminId = null;
      let storedClientId = null;
      const callTimerElement = document.getElementById("callTimer");

//       function startCallWithMicrophone() {
//     console.log('Start call with microphone initiated.');

//     // Check if peerConnection already exists, if not, create a new one
//     if (!window.peerConnection) {
//         console.log('Creating new peer connection...');
//         window.peerConnection = new RTCPeerConnection({
//             iceServers: [{ urls: "stun:stun.l.google.com:19302" }] // Use Google's public STUN server
//         });

//         // Handle ICE candidates (send them to the server for forwarding to the admin)
//         window.peerConnection.onicecandidate = (event) => {
//             if (event.candidate) {
//                 console.log('Sending ICE candidate:', event.candidate);
//                 socket.emit('iceCandidate', {
//                     candidate: event.candidate,
//                     clientId: storedClientId // Use stored clientId from your code
//                 });
//             } else {
//                 console.log('No ICE candidate found.');
//             }
//         };

//         // Handle incoming tracks (remote stream)
//         window.peerConnection.ontrack = (event) => {
//             const remoteStream = event.streams[0];
//             console.log('Received remote stream:', remoteStream);

//             // Assuming there is an <audio> element on the page for playback
//             const audioElement = document.getElementById('audioCall');
//             audioElement.srcObject = remoteStream;
//             audioElement.muted = false; // Unmute the remote stream
//             audioElement.play().catch(error => console.error('Error playing remote audio:', error));
//         };
//     }

//     // Get local media stream (audio) and add it to the peer connection
//     navigator.mediaDevices.getUserMedia({ audio: true })
//         .then(stream => {
//             console.log('Local media stream successfully obtained:', stream);

//             const audioElement = document.getElementById('audioCall');
//             audioElement.srcObject = stream;
//             audioElement.muted = false; // Ensure admin's audio is unmuted
//             audioElement.play().then(() => {
//                 console.log('Local audio playback started');
//             }).catch((error) => {
//                 console.error('Error starting local audio playback:', error);
//             });

//             // Add the tracks to the peer connection
//             stream.getTracks().forEach(track => {
//                 console.log('Adding local track to peer connection:', track);
//                 window.peerConnection.addTrack(track, stream);
//             });

//             // If you need to send an offer to the admin, create and send the offer now
//             if (!window.isOfferSent) { // Check if offer has already been sent
//                 window.isOfferSent = true;
//                 console.log('Creating and sending offer to the admin...');
//                 window.peerConnection.createOffer()
//                     .then(offer => {
//                         return window.peerConnection.setLocalDescription(offer);
//                     })
//                     .then(() => {
//                         console.log('Sending offer to the admin...');
//                         socket.emit('offer', {
//                             offer: window.peerConnection.localDescription,
//                             clientId: storedClientId // Use stored clientId for this client
//                         });
//                     })
//                     .catch(error => console.error('Error creating or sending offer:', error));
//             }
//         })
//         .catch(error => {
//             console.error('Error accessing media devices:', error);
//         });
// }

// let iceCandidateQueue = []; // Buffer for incoming ICE candidates

// // Listen for the incoming call
// socket.on("callIncoming", (data) => {
//     console.log("Received callIncoming event:", data);
//     document.getElementById("callMessage").style.display = "block";
//     storedAdminId = data.adminId;
//     storedClientId = data.clientId;

//     if (storedClientId === clientId) {
//         console.log('Displaying accept/reject UI for the client.');
//         const acceptButton = document.getElementById("acceptCallButton");
//         const rejectButton = document.getElementById("rejectCallButton");

//         acceptButton.style.display = "block";
//         rejectButton.style.display = "block";

//         acceptButton.onclick = function () {
//             console.log("Emitting acceptCall with adminId:", storedAdminId);
//             socket.emit("acceptCall", {
//                 adminId: storedAdminId,
//                 clientId: storedClientId,
//             });
//             document.getElementById("callInProgress").style.display = "block";
//             document.getElementById("callMessage").textContent = "In Call...";
//             startCallTimer();
//         };

//         rejectButton.onclick = function () {
//             console.log("Rejecting call.");
//             socket.emit("rejectCall", { clientId });
//             document.getElementById("callMessage").textContent = "Call Rejected.";
//         };
//     }
// });

// // Listen for the server's response to the accepted call (admin should accept)
// socket.on('callAccepted', (data) => {
//     console.log('Received callAccepted:', data); // Log received data
    
//     const { adminId, clientId } = data;

//     if (!window.peerConnection) {
//         console.log('Creating peer connection for the call.');
//         window.peerConnection = new RTCPeerConnection({
//             iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
//         });

//         window.peerConnection.oniceconnectionstatechange = (event) => {
//             console.log('ICE connection state change:', event);
//             console.log('Current ICE connection state:', window.peerConnection.iceConnectionState);
//         };

//         window.peerConnection.onicecandidate = (event) => {
//             console.log('ICE candidate event:', event);
//             if (event.candidate) {
//                 console.log('Sending ICE candidate:', event.candidate);
//                 socket.emit('iceCandidate', {
//                     candidate: event.candidate,
//                     clientId: storedClientId,
//                     adminId: storedAdminId
//                 });
//             }
//         };

//         window.peerConnection.ontrack = (event) => {
//             console.log('Received remote stream:', event);
//             const remoteStream = event.streams[0];
//             const audioElement = document.getElementById('audioCall');
//             audioElement.srcObject = remoteStream;
//             audioElement.muted = false;
//             audioElement.play().catch(err => console.error('Error playing remote audio:', err));
//         };

//         // Process queued ICE candidates if any
//         iceCandidateQueue.forEach(candidate => {
//             console.log('Adding buffered ICE candidate:', candidate);
//             window.peerConnection.addIceCandidate(candidate)
//                 .catch(err => console.error('Error adding buffered ICE candidate:', err));
//         });

//         iceCandidateQueue = [];
//     }

//     // Get local media (audio)
//     navigator.mediaDevices.getUserMedia({ audio: true })
//         .then(stream => {
//             console.log('Local stream obtained:', stream);
//             const audioElement = document.getElementById('audioCall');
//             audioElement.srcObject = stream;
//             audioElement.muted = false;
//             audioElement.play().catch(err => console.error('Error playing local audio:', err));

//             // Add local audio tracks to the peer connection
//             stream.getTracks().forEach(track => {
//                 window.peerConnection.addTrack(track, stream);
//             });

//             // Send offer to admin if not already sent
//             if (!window.isOfferSent) {
//                 window.isOfferSent = true;
//                 window.peerConnection.createOffer()
//                     .then(offer => {
//                         console.log('Created offer:', offer);
//                         return window.peerConnection.setLocalDescription(offer);
//                     })
//                     .then(() => {
//                         console.log('Sending offer to admin:', window.peerConnection.localDescription);
//                         socket.emit('offer', {
//                             offer: window.peerConnection.localDescription,
//                             clientId: storedClientId
//                         });
//                     })
//                     .catch(err => console.error('Error creating or sending offer:', err));
//             }
//         })
//         .catch(err => console.error('Error accessing media devices:', err));
// });

// // Handle ICE candidate from admin
// socket.on('iceCandidate', (data) => {
//     const { candidate } = data;
//     console.log('Received ICE candidate from admin:', candidate);

//     // Make sure peerConnection exists before trying to add the candidate
//     if (window.peerConnection) {
//         window.peerConnection.addIceCandidate(new RTCIceCandidate(candidate))
//             .catch(err => console.error('Error adding ICE candidate:', err));
//     } else {
//         // Buffer the candidate if peerConnection is not yet initialized
//         console.log('Buffering ICE candidate until peerConnection is initialized.');
//         iceCandidateQueue.push(new RTCIceCandidate(candidate));
//     }
// });

// // Listen for the admin's offer and handle it
// socket.on('offer', (data) => {
//     console.log('Received offer from admin:', data);
//     const { offer, clientId, storedAdminId } = data;

// if (clientId && storedAdminId && offer) {
//     // Send offer to the client
//     io.to(clientId).emit('offer', { offer, storedAdminId });

//     // Wait for the client's answer (with timeout)
//     let answerReceived = false;
//     setTimeout(() => {
//         if (!answerReceived) {
//             io.to(storedAdminId).emit('clientNotAnswering', { clientId });
//         }
//     }, 15000); // 15 seconds timeout
// } else {
//     console.log('Missing adminId, clientId, or offer');
// }

//     // Ensure the peer connection is initialized
//     if (!window.peerConnection) {
//         console.log('Creating new peer connection for received offer...');
//         window.peerConnection = new RTCPeerConnection({
//             iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
//         });

//         window.peerConnection.onicecandidate = (event) => {
//             if (event.candidate) {
//                 console.log('Sending ICE candidate:', event.candidate);
//                 socket.emit('iceCandidate', {
//                     candidate: event.candidate,
//                     clientId: storedClientId,
//                     adminId: storedAdminId
//                 });
//             }
//         };

//         window.peerConnection.ontrack = (event) => {
//             const remoteStream = event.streams[0];
//             console.log('Received remote stream:', remoteStream);

//             const audioElement = document.getElementById('audioCall');
//             audioElement.srcObject = remoteStream;
//             audioElement.muted = false;
//             audioElement.play().catch(err => console.error('Error playing remote audio:', err));
//         };

//         // Once the peer connection is created, process any queued ICE candidates
//         iceCandidateQueue.forEach(candidate => {
//             console.log('Adding buffered ICE candidate:', candidate);
//             window.peerConnection.addIceCandidate(candidate)
//                 .catch(err => console.error('Error adding buffered ICE candidate:', err));
//         });

//         // Clear the candidate queue after processing
//         iceCandidateQueue = [];
//     }

//     // Set the remote description (offer) from the admin
//     window.peerConnection.setRemoteDescription(new RTCSessionDescription(offer))
//         .then(() => {
//             console.log('Remote description set, creating answer...');
//             return window.peerConnection.createAnswer();
//         })
//         .then(answer => {
//             console.log('Setting local description with answer...');
//             return window.peerConnection.setLocalDescription(answer);
//         })
//         .then(() => {
//             console.log('Sending answer to admin:', window.peerConnection.localDescription);
//             socket.emit('answer', {
//                 answer: window.peerConnection.localDescription,
//                 clientId: storedClientId,
//                 adminId: storedAdminId
//             });
//         })
//         .catch(err => console.error('Error handling offer:', err));
// });

// // Handle the answer from admin
// socket.on('answer', (data) => {
//     console.log('Received answer from admin:', data);

//     if (window.peerConnection) {
//         const { answer } = data;
//         window.peerConnection.setRemoteDescription(new RTCSessionDescription(answer))
//             .catch(err => console.error('Error setting remote description:', err));
//     }
// });


//       // End call logic
//      // End call logic for client
// function endCall(storedAdminId, storedClientId) {
//     // Retrieve admin info from localStorage
//     const adminInfo = JSON.parse(localStorage.getItem("adminInfo"));
//     console.log("adminInfo:", adminInfo);

//     storedAdminId = adminInfo.adminId;
//     console.log("adminId:", storedAdminId);

//     storedClientId = clientId;
    
//     // Stop all media tracks (audio/video) if mediaStream exists
//     if (mediaStream) {
//         mediaStream.getTracks().forEach((track) => track.stop());
//     }

//     console.log("Emitting endCall with:", { storedAdminId, storedClientId });

   
//         // Emit the endCall event to the server
//         socket.emit('endCall', { adminId: storedAdminId, clientId: storedClientId });
   

//     // Handle the end of the call on the client side (UI updates)
//     document.getElementById("callInProgress").style.display = "none"; // Hide call UI
//     document.getElementById("callMessage").textContent = "Call Ended."; // Show call ended message

//     // Stop the call timer
//     stopCallTimer();

//     // Get the formatted duration time
//     const minutes = Math.floor(elapsedTime / 60);
//     const seconds = elapsedTime % 60;
//     const formattedTime = `${String(minutes).padStart(2, "0")}:${String(seconds).padStart(2, "0")}`;

//     // Display formatted time in the timer element
//     callTimerElement.textContent = formattedTime;

//     // Add blinking class for visual feedback
//     callTimerElement.classList.add("blinking");

//     // Display the timer for 5 seconds (blinking effect)
//     callTimerElement.style.display = "block"; // Ensure it's visible

//     // Hide the timer and reset after 5 seconds
//     setTimeout(() => {
//         callTimerElement.classList.remove("blinking");
//         callTimerElement.style.display = "none"; // Hide the timer
//         callTimerElement.textContent = "00:00"; // Reset to 00:00
//     }, 5000); // 5 seconds
// }

// // Event listener for end call button
// document.getElementById('endCallButton').addEventListener('click', function () {
//     const adminInfo = JSON.parse(localStorage.getItem("adminInfo"));
//     console.log("adminInfo:", adminInfo);

//    const  storedAdminId = adminInfo.adminId;
//     console.log("adminId:", storedAdminId);

//     const storedClientId = localStorage.getItem("clientId");
//     endCall(storedAdminId, storedClientId);
// });

// // Socket events for call acceptance/rejection status
//       socket.on("callEnded", () => {
//         console.log("Received callEnded event");
//         stopCallTimer();
//         document.getElementById("callInProgress").style.display = "none";
//         document.getElementById("callMessage").textContent = "Call Ended.";
//         // Add the blinking class
//         callTimerElement.classList.add("blinking");

//         // Show the timer and blink for 5 seconds
//         callTimerElement.style.display = "block"; // Ensure the timer is visible
//         setTimeout(() => {
//           callTimerElement.classList.remove("blinking"); // Remove blinking class
//           callTimerElement.style.display = "none"; // Hide the timer
//           callTimerElement.textContent = "00:00"; // Reset the timer to 00:00 for the next call
//         }, 5000); // 5 seconds
//       });

//       // Accept the incoming call
//       function acceptCall() {
//         document.getElementById("callTimer").style.display = "block"; // Show in-call UI
//         document.getElementById("callMessage").textContent = "Call Accepted!";
//         document.getElementById("acceptCallButton").style.display = "none";
//         document.getElementById("rejectCallButton").style.display = "none";
//         document.getElementById("callInProgress").style.display = "block"; // Show in-call UI

//         initializeAudioVisualizer();

//         socket.emit("acceptCall", {
//         adminId: storedAdminId,
//         clientId: storedClientId
//     });

//         fetch("https://my-node-backend-fcdy.onrender.com/answerCall", {
//           method: "POST",
//           headers: { "Content-Type": "application/json" },
//           body: JSON.stringify({ clientId, decision: "accept" }),
//         })
//           .then((response) => response.json())
//           .then((data) => {
//             if (data.success) {
//               document.getElementById("callMessage").textContent = "In call...";
//             }
//           })
//           .catch((err) => console.error("Error:", err));
//       }

//       // Reject the incoming call
//       function rejectCall() {
//         socket.emit("rejectCall", { clientId });

//         fetch("https://my-node-backend-fcdy.onrender.com/answerCall", {
//           method: "POST",
//           headers: { "Content-Type": "application/json" },
//           body: JSON.stringify({ clientId, decision: "reject" }),
//         })
//           .then((response) => response.json())
//           .then((data) => {
//             if (data.success) {
//               document.getElementById("callMessage").textContent =
//                 "Call Rejected.";
//             }
//           })
//           .catch((err) => console.error("Error:", err));
//       }

//       // Socket events for call acceptance/rejection status
//       socket.on("getCallStatus", (status) => {
//         if (status === "accepted" || status === "rejected") {
//           document.getElementById(
//             "callMessage"
//           ).textContent = `Call ${status}.`;
//           document.getElementById("acceptCallButton").style.display = "none";
//           document.getElementById("rejectCallButton").style.display = "none";
//         }
//       });

//       // Socket connection handling
//       socket.on("connect", () => {
//         if (clientId) {
//           socket.emit("joinRoom", clientId); // Join the room using the clientId
//         }
//       });

//       socket.on("disconnect", () =>
//         console.log("Client disconnected from server")
//       );

//       // Event listeners for buttons
//       document
//         .getElementById("acceptCallButton")
//         .addEventListener("click", acceptCall);
//       document
//         .getElementById("rejectCallButton")
//         .addEventListener("click", rejectCall);
     
//       document
//         .getElementById("muteButton")
//         .addEventListener("click", toggleMute);

//       // Function to toggle mute status
//       function toggleMute() {
//         isMuted = !isMuted;
//         const muteButton = document.getElementById("muteButton");
//         muteButton.textContent = isMuted ? "Unmute" : "Mute";

//         if (mediaStream) {
//           mediaStream.getTracks().forEach((track) => {
//             if (track.kind === "audio") {
//               track.enabled = !isMuted; // Enable/disable audio track
//             }
//           });
//         }
//       }

//       // Function to initialize audio visualizer
//       function initializeAudioVisualizer() {
//         let canvas = document.getElementById("soundWave");
//         let canvasContext = canvas.getContext("2d");
//         let audioContext = new (window.AudioContext ||
//           window.webkitAudioContext)();
//         let analyserNode = audioContext.createAnalyser();
//         analyserNode.fftSize = 256;
//         let bufferLength = analyserNode.frequencyBinCount;
//         let dataArray = new Uint8Array(bufferLength);

//         navigator.mediaDevices
//           .getUserMedia({ audio: true })
//           .then((stream) => {
//             mediaStream = stream; // Save the stream for ending or muting
//             const source = audioContext.createMediaStreamSource(stream);
//             source.connect(analyserNode);
//             drawWaveform();
//           })
//           .catch((err) => console.error("Error accessing microphone:", err));

//         function drawWaveform() {
//           requestAnimationFrame(drawWaveform);
//           analyserNode.getByteFrequencyData(dataArray);
//           canvasContext.clearRect(0, 0, canvas.width, canvas.height);

//           canvasContext.fillStyle = "rgb(0, 0, 0)";
//           canvasContext.fillRect(0, 0, canvas.width, canvas.height);
//           canvasContext.lineWidth = 2;
//           canvasContext.strokeStyle = "rgb(255, 255, 255)";
//           canvasContext.beginPath();

//           let sliceWidth = (canvas.width * 1.0) / bufferLength;
//           let x = 0;
//           for (let i = 0; i < bufferLength; i++) {
//             let v = dataArray[i] / 128.0;
//             let y = (v * canvas.height) / 2;
//             if (i === 0) canvasContext.moveTo(x, y);
//             else canvasContext.lineTo(x, y);
//             x += sliceWidth;
//           }
//           canvasContext.lineTo(canvas.width, canvas.height / 2);
//           canvasContext.stroke();
//         }
//       }

//       // Function to update the timer and display it
//       function updateTimer() {
//         elapsedTime++;
//         const minutes = Math.floor(elapsedTime / 60);
//         const seconds = elapsedTime % 60;
//         const formattedTime = `${String(minutes).padStart(2, "0")}:${String(
//           seconds
//         ).padStart(2, "0")}`;

//         // Update the timer on the page
//         document.getElementById("callTimer").textContent = formattedTime;
//       }

//       // Function to start the timer when the call is accepted
//       function startCallTimer() {
//         elapsedTime = 0; // Reset the timer to 0
//         document.getElementById("callTimer").textContent = "00:00"; // Reset the displayed timer
//         callInterval = setInterval(updateTimer, 1000); // Start the timer interval
//                // Debugging the adminName
//     if (adminName && adminName.trim() !== "") {
//         console.log("Setting username:", adminName);
//     } else {
//         console.log("Admin name is invalid or empty");
//     }

//     // Redirect to the room page with the username as a query parameter
//     const roomId = clientId; // Use client._id or whatever ID you're generating for the room
//     console.log("Redirecting to room with ID:", roomId);
//     localStorage.setItem("username", clientName); // Store the username
//     console.log("username: ", clientName)
//     window.location.href = `https://video-call-server-production.up.railway.app/${roomId}?username=${encodeURIComponent(clientName)}`;
//       }

//       // Function to stop the timer when the call ends
//       function stopCallTimer() {
//         clearInterval(callInterval); // Stop the interval
//       }

      // ------ map --------------------------------- Initialize the map and other required variables
      let windowMap;
      let routeControl;
      let adminName = "Admin"; // Placeholder name for Admin
      let parentName = "You"; // Placeholder name for Parent

      // Define a custom icon for both Admin and Parent locations
      const adminIcon = L.icon({
        iconUrl: "marker-icon-2x.png", // Admin's icon URL
        iconSize: [25, 41], // Size of the icon
        iconAnchor: [12, 41], // Point of the icon which will correspond to marker's location
        popupAnchor: [1, -34], // Point from which the popup should open
      });

      // Define a custom icon for the Client's location
      const clientIcon = L.icon({
        iconUrl: "dot.png", // Use a different icon for the client
        iconSize: [20, 20], // Adjust size of the icon (width, height)
        iconAnchor: [15, 15], // Anchor the icon at the center
        popupAnchor: [0, -15],
      });

      // Connect to the server (ensure you have your Socket.io server running)

      // Listen for locations from Admin and update the map
      socket.on("receiveLocationsFromAdmin", function (data) {
        console.log("Received locations from Admin:", data);

        if (data && data.adminLocation && data.parentLocation) {
          const { adminLocation, parentLocation } = data;

          // Initialize the map with Admin's location if not initialized
          if (!windowMap) {
            initializeMap(adminLocation.lat, adminLocation.lng);
          }
          if (routeControl) {
            windowMap.removeLayer(routeControl); // Remove the old route
          }

          // Update Parent's location on the map
          updateParentLocationOnMap(parentLocation.lat, parentLocation.lng);

          // Update the route from Admin to Parent
          updateRoute(adminLocation, parentLocation);

          // Update Admin's location on the map
          updateAdminLocationOnMap(adminLocation.lat, adminLocation.lng);
        }
      });

      // Initialize the Map with Admin's Location
      function initializeMap(lat, lng) {
        console.log("Initializing map with Admin's coordinates:", lat, lng);
        windowMap = L.map("map").setView([lat, lng], 13);

        // Add OpenStreetMap tiles to the map
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          attribution:
            '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
        }).addTo(windowMap);
      }
      // Update Parent's Location on the Map (using a simple circle marker for now)
      function updateParentLocationOnMap(lat, lng) {
        if (windowMap) {
          // Create a circle marker for Parent's location (now using client icon)
          L.marker([lat, lng], { icon: clientIcon }) // Swap the icons
            .addTo(windowMap)
            .on("mouseover", function () {
              this.bindPopup(`${parentName}`).openPopup(); // Show Parent's name
            })
            .on("mouseout", function () {
              this.closePopup(); // Close the popup when mouse leaves
            });
        }
      }

      // Update Admin's Location on the Map (using the custom icon for Admin, but we swap it to client)
      function updateAdminLocationOnMap(lat, lng) {
        
        console.log("Updating Admin location on map:", lat, lng); // Log Admin's location update
        if (windowMap) {
          // Add a custom marker for Admin's location using the clientIcon
          L.marker([lat, lng], { icon: adminIcon }) // Use the adminIcon but for client
            .addTo(windowMap)
            .on("mouseover", function () {
              console.log("Hovering over Admin marker"); // Debug hover event
              this.bindPopup(`${adminName}'s Location`).openPopup(); // Show Admin's name
            })
            .on("mouseout", function () {
              console.log("Mouse left Admin marker"); // Debug mouseout event
              this.closePopup(); // Close the popup when mouse leaves
            });
        } else {
          console.error("Map is not initialized yet."); // Error if the map is not initialized
        }
      }

      // Update the Route from Admin to Parent
      function updateRoute(adminLocation, parentLocation) {
        if (!adminLocation || !parentLocation || !windowMap) {
          console.error("Invalid locations or map not initialized yet");
          return;
        }

        // Create or update the route
        if (routeControl) {
          routeControl.setWaypoints([
            L.latLng(adminLocation.lat, adminLocation.lng),
            L.latLng(parentLocation.lat, parentLocation.lng),
          ]);
        } else {
          routeControl = L.Routing.control({
            waypoints: [
              L.latLng(adminLocation.lat, adminLocation.lng),
              L.latLng(parentLocation.lat, parentLocation.lng),
            ],
            createMarker: function () {
              return null;
            }, // Hide route markers
            routeWhileDragging: true, // Allow route dragging
          }).addTo(windowMap); // Add the route to the map
        }
      }

      // Define key destination coordinates
      const destinations = {
        mina: {
          name: "Mina",
          lat: 40.044, // Example coordinates for Mina
          lng: -86.481,
        },
        jamarat: {
          name: "Jamarat",
          lat: 39.925, // Example coordinates for Jamarat
          lng: -86.38,
        },
        kaaba: {
          name: "Kaaba",
          lat: 39.778, // Example coordinates for Kaaba
          lng: -86.3453,
        },
      };
      // Define custom icons for Mina, Jamarat, and Kaaba
      const minaIcon = L.icon({
        iconUrl: "mina-icon.png", // Replace with the actual image URL for Mina
        iconSize: [30, 30], // Set the size of the icon
        iconAnchor: [15, 15], // Anchor the icon at the center
        popupAnchor: [0, -15], // Popup relative to the icon
      });

      const jamaratIcon = L.icon({
        iconUrl: "jamarat-icon.png", // Replace with the actual image URL for Jamarat
        iconSize: [30, 30], // Set the size of the icon
        iconAnchor: [15, 15], // Anchor the icon at the center
        popupAnchor: [0, -15], // Popup relative to the icon
      });

      const kaabaIcon = L.icon({
        iconUrl: "kaaba-icon.png", // Replace with the actual image URL for Kaaba
        iconSize: [30, 30], // Set the size of the icon
        iconAnchor: [15, 15], // Anchor the icon at the center
        popupAnchor: [0, -15], // Popup relative to the icon
      });

      // Variable to store the current safe location marker
      let safeLocationMarker = null;
      // Retrieve the client's latitude and longitude from localStorage
     let clientLocation = null
// Function to get the client's real-time location
function getRealTimeLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function (position) {
            const latitude = position.coords.latitude;
            const longitude = position.coords.longitude;
            console.log(`Client's Location:`, latitude, longitude);
            localStorage.setItem('latitude', latitude)
            localStorage.setItem('longitude', longitude)

            clientLocation = { latitude, longitude };  // Update the client location

            // Once we have the location, check if we are inside the geofence
            checkGeofence();
        }, function (error) {
            console.error("Error getting client location:", error.message);
            // Handle location acquisition errors gracefully (e.g., ask the user to enable location or retry)
        }, {
            timeout: 10000  // Set a timeout for location acquisition
        });
    } else {
        console.error("Geolocation is not supported by this browser.");
    }
}


      // Function to add the client's location marker on the map
      function addClientLocationMarker(clientLocation) {
        // Check if the map is initialized
        if (windowMap) {
          // Create a custom icon for the client's location (blue dot)
          const clientIcon = L.icon({
            iconUrl: "dot.png", // Path to your blue-dot image
            iconSize: [25, 25], // Icon size (adjust as needed)
            iconAnchor: [12, 12], // Anchor point of the icon (center it)
            popupAnchor: [0, -15], // Popup position relative to the icon
          });

          // Create the marker for the client's location and add it to the map
          L.marker([clientLocation.latitude, clientLocation.longitude], {
            icon: clientIcon,
          })
            .addTo(windowMap)
            .bindPopup("Client Location") // Optional: Add a popup with the label
            .openPopup();
        } else {
          console.error("Map is not initialized.");
        }
      }

      setInterval(() => {
    socket.emit('heartbeat'); // Send heartbeat signal to the server
}, 10000);  // Adjust the interval as needed (e.g., 5000ms = 5 seconds)


  // Listen for updates to client status from the server (admin updates)
  socket.on('clientStatusUpdated', (data) => {
        console.log(`Client ${data.clientId} is now ${data.status}`);
    });
      // Function to add the safe location marker on the map
      function addSafeLocationMarker(safeLocation) {
        // Check if the map is already initialized
        if (windowMap) {
          // Create a custom marker for the safe location
          const safeLocationIcon = L.icon({
            iconUrl: "safe-location-icon.png", // Use a custom icon or a default one
            iconSize: [30, 30], // Icon size
            iconAnchor: [15, 15], // Anchor the icon at the center
            popupAnchor: [0, -15], // Position of popup relative to the icon
          });

          // Create the new marker and add it to the map
          safeLocationMarker = L.marker([safeLocation.lat, safeLocation.lng], {
            icon: safeLocationIcon,
          })
            .addTo(windowMap)
            .bindPopup("Safe Location")
            .openPopup();
        } else {
          console.error("Map is not initialized.");
        }
      }

      // Listen for the safe location from the admin
      socket.on("receiveSafeLocationsFromAdmin", function (data) {
        console.log("Received safe location from Admin:", data);

        // Ensure the data contains the safeLocation object
        if (data && data.safeLocation) {
          const { safeLocation } = data;

          console.log("Admin Safe Location:", safeLocation);

          // Initialize the map with the Admin's safe location if not initialized
          if (!windowMap) {
            console.log(
              "Initializing map with Admin's coordinates:",
              safeLocation.lat,
              safeLocation.lng
            );
            initializeMap(safeLocation.lat, safeLocation.lng); // Ensure map is initialized with the safe location
          }

          // Remove the old safe location marker if it exists
          if (safeLocationMarker) {
            windowMap.removeLayer(safeLocationMarker); // Remove the previous safe location marker
          }

          // Retrieve the client's latitude and longitude from localStorage
          const latitude = parseFloat(localStorage.getItem("latitude"));
          const longitude = parseFloat(localStorage.getItem("longitude"));
        

          // Check if valid latitude and longitude are retrieved
          if (!isNaN(latitude) && !isNaN(longitude)) {
            console.log("Client Latitude:", latitude);
            console.log("Client Longitude:", longitude);

            // Add the client location marker to the map
            addClientLocationMarker(clientLocation);

            // Update the route from the client to the safe location
            updaSafeteRoute(safeLocation, clientLocation);
          } else {
            console.error(
              "Client Location not found in localStorage or invalid values"
            );
          }

          // Add the new safe location marker
          addSafeLocationMarker(safeLocation);
        }
      });

      function updaSafeteRoute(safeLocation, clientLocation) {
        // Check if the route control exists
        if (routeControl) {
          // Update the route using new waypoints
          routeControl.setWaypoints([
            L.latLng(clientLocation.latitude, clientLocation.longitude), // Client location
            L.latLng(safeLocation.lat, safeLocation.lng), // Admin safe location
          ]);
        } else {
          // Create a new route if it doesn't exist
          routeControl = L.Routing.control({
            waypoints: [
              L.latLng(clientLocation.latitude, clientLocation.longitude), // Client location
              L.latLng(safeLocation.lat, safeLocation.lng), // Admin safe location
            ],
            createMarker: function () {
              return null;
            }, // Prevent markers from being created
            routeWhileDragging: true, // Allow dragging the route
          }).addTo(windowMap); // Add the route to the map
        }
      }

      function displayRouteToDestination(clientLocation, destination) {
        // Clear any existing routes
        if (routeControl) {
          // Add the destination icon on the map
          let destinationIcon;
          if (destination.name === "Mina") {
            destinationIcon = minaIcon;
          } else if (destination.name === "Jamarat") {
            destinationIcon = jamaratIcon;
          } else if (destination.name === "Kaaba") {
            destinationIcon = kaabaIcon;
          }

          // Add the destination marker to the map
          L.marker([destination.lat, destination.lng], {
            icon: destinationIcon,
          })
            .addTo(windowMap)
            .bindPopup(destination.name) // Optional: Show the destination name in the popup
            .openPopup();
          routeControl.setWaypoints([
            L.latLng(clientLocation.latitude, clientLocation.longitude), // Client location
            L.latLng(destination.lat, destination.lng), // Selected destination
          ]);
        } else {
          // Create a new route
          routeControl = L.Routing.control({
            waypoints: [
              L.latLng(clientLocation.latitude, clientLocation.longitude), // Client's location
              L.latLng(destination.lat, destination.lng), // Selected destination
            ],
            routeWhileDragging: true, // Allow dragging the route
            createMarker: function () {
              return null;
            }, // Hide markers
          }).addTo(windowMap); // Add the new route to the map
        }
      }

      function setDestination(destinationKey) {
        const destination = destinations[destinationKey];
        if (destination) {
          console.log("Selected Destination:", destination.name);

          // If map is already initialized, just update the view
          if (windowMap) {
            windowMap.setView([destination.lat, destination.lng], 13); // Update the map center to the new destination
          } else {
            initializeMap(destination.lat, destination.lng); // Initialize the map if it's the first time
          }

          // Update the client's location marker on the map
          updateParentLocationOnMap(
            clientLocation.latitude,
            clientLocation.longitude
          );

          // Before displaying a new route, clear any old route that might still exist
          if (routeControl) {
            windowMap.removeLayer(routeControl); // Remove the previous route control
          }

          // Display the route from the client to the new destination
          displayRouteToDestination(clientLocation, destination);
        } else {
          console.error("Invalid destination selected.");
        }
      }

      function setDestination(destinationKey) {
        const destination = destinations[destinationKey];
        if (destination) {
          console.log("Selected Destination:", destination.name);

          // Ensure clientLocation is initialized
          const latitude = parseFloat(localStorage.getItem("latitude"));
          const longitude = parseFloat(localStorage.getItem("longitude"));

          // Check if the client location is valid
          if (isNaN(latitude) || isNaN(longitude)) {
            console.error(
              "Invalid client location in localStorage:",
              latitude,
              longitude
            );
            return; // Exit the function if client location is invalid
          }

          const clientLocation = { latitude, longitude };

          // If the map is already initialized, just update the view
          if (windowMap) {
            windowMap.setView([destination.lat, destination.lng], 13); // Update the map center to the new destination
          } else {
            initializeMap(destination.lat, destination.lng); // Initialize the map if it's the first time
          }

          // Update the parent's location marker on the map
          updateParentLocationOnMap(
            clientLocation.latitude,
            clientLocation.longitude
          );

          // Before displaying a new route, clear any old route that might still exist
          if (routeControl) {
            windowMap.removeLayer(routeControl); // Remove the previous route control
          }

          // Display the route from the client to the new destination
          displayRouteToDestination(clientLocation, destination);
        } else {
          console.error("Invalid destination selected.");
        }
      }

      function sendEmergencyAlert() {
            if (navigator.geolocation) {
              navigator.geolocation.getCurrentPosition(
                function (position) {
                  const latitude = position.coords.latitude;
                  const longitude = position.coords.longitude;

                  if (
                    typeof latitude === "number" &&
                    !isNaN(latitude) &&
                    typeof longitude === "number" &&
                    !isNaN(longitude)
                  ) {
                    const clientId = localStorage.getItem("clientId");
                    const username = localStorage.getItem("username");
                    const securityCode = localStorage.getItem("securityCode");

                    socket.emit("sendEmergencyAlert", {
                      clientId: clientId,
                      username: username,
                      securityCode: securityCode,
                      latitude: latitude,
                      longitude: longitude,
                      alertType: "lost",
                      alertTime: new Date().toISOString(),
                    });

                    console.log("Emergency alert sent!");
                 
                  } else {
                    console.error("Invalid coordinates received:", {
                      latitude,
                      longitude,
                    });
                  }
                },
                function (error) {
                  console.error("Error getting location:", error);
                }
              );
            } else {
              console.error("Geolocation is not supported by this browser.");
            }
          }
         
          document.getElementById("emergencyButton").addEventListener("click", sendEmergencyAlert);
         
      // Function to send health alert to admin






function sendHealthAlert() {
    const healthAlertMessage = "Client is feeling unwell. Please check on them.";
            if (navigator.geolocation) {
              navigator.geolocation.getCurrentPosition(
                function (position) {
                  const latitude = position.coords.latitude;
                  const longitude = position.coords.longitude;

                  if (
                    typeof latitude === "number" &&
                    !isNaN(latitude) &&
                    typeof longitude === "number" &&
                    !isNaN(longitude)
                  ) {
                    const clientId = localStorage.getItem("clientId");
                    const username = localStorage.getItem("username");
                    const securityCode = localStorage.getItem("securityCode");

                    socket.emit("sendHealthAlert", {
                      clientId: clientId,
                      username: username,
                      securityCode: securityCode,
                      latitude: latitude,
                      longitude: longitude,
                      alertType: "health",
                      alertTime: new Date().toISOString(),
                    });

                    console.log("Health alert sent to admin");
                 
                  } else {
                    console.error("Invalid coordinates received:", {
                      latitude,
                      longitude,
                    });
                  }
                },
                function (error) {
                  console.error("Error getting location:", error);
                }
              );
            } else {
              console.error("Geolocation is not supported by this browser.");
            }
          }
      // Add event listener for the health alert button
      document.getElementById("healthAlertButton").addEventListener("click", function () {
          sendHealthAlert(); // Trigger sending health alert
        });

// Save the steps (location) of the client every 5 minutes
function startSavingLocationEveryFiveMinutes() {
    // Call the function immediately to save the first location

        // Start saving location here...
        saveStepsOfClient();
  

    // Set an interval to save location every 5 minutes (300000ms)
    setInterval(saveStepsOfClient, 300000);
}

socket.on('locationTrackingStatus', (data) => {
    const { trackLocation } = data;
    console.log("Received trackLocation:", trackLocation, typeof trackLocation); // Log type too

    if (trackLocation === true) {
        // Start saving the location
        console.log("Location saving is enabled for this client.");
        startSavingLocationEveryFiveMinutes();
    } else {
        // Stop saving the location
        console.log("Location saving is disabled for this client.");
    }
});

function saveStepsOfClient() {



    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            function (position) {
                const latitude = position.coords.latitude;
                const longitude = position.coords.longitude;

                // Check if coordinates are valid
                if (
                    typeof latitude === "number" &&
                    !isNaN(latitude) &&
                    typeof longitude === "number" &&
                    !isNaN(longitude)
                ) {
                    // Get client data from localStorage
                    const clientId = localStorage.getItem("clientId");
                    const username = localStorage.getItem("username");
                    const securityCode = localStorage.getItem("securityCode");
                     // Get checkbox status from localStorage or checkbox element
                   

                    // Log client data for debugging
                    console.log("clientId:", clientId);
                    console.log("username:", username);
                    console.log("securityCode:", securityCode);

                    // If any of these values are missing, log an error and stop the process
                    if (!clientId || !username || !securityCode) {
                        console.error("Missing client data: clientId, username, or securityCode");
                        return;  // Prevent sending if any of these are missing
                    }

                    // Prepare the data to be sent
                    const locationData = {
                        clientId: clientId,
                        username: username,
                        securityCode: securityCode,
                        latitude: latitude,
                        longitude: longitude,
                        alertType: "none",  // You can change this if you have different alert types
                        alertTime: new Date().toISOString(),  // Ensure this is correctly formatted
                    };

                    // Emit the location data to the server
                    socket.emit("locationData", locationData);

                    console.log("Steps of client sent to DB:", locationData);

                } else {
                    console.error("Invalid coordinates received:", { latitude, longitude });
                }
            },
            function (error) {
                console.error("Error getting location:", error);
                // Implement retry logic or a user-friendly message if the location is not found
                if (error.code === error.TIMEOUT) {
                    console.error("Location acquisition timed out. Retrying...");
                    // Retry the location acquisition after 5 seconds
                    setTimeout(saveStepsOfClient, 5000); 
                } else if (error.code === error.PERMISSION_DENIED) {
                    console.error("Permission denied. Please enable location services.");
                } else if (error.code === error.POSITION_UNAVAILABLE) {
                    console.error("Location unavailable. Check if GPS is enabled or if you're connected to the internet.");
                } else {
                    console.error("Unknown error occurred while fetching location.");
                }
            },
            {
                enableHighAccuracy: true,  // Use high accuracy for more precise locations
                timeout: 10000,  // Timeout after 10 seconds if location is not obtained
                maximumAge: 0,  // Do not use a cached position
            }
        );
    } else {
        console.error("Geolocation is not supported by this browser.");
    }
}




      //////------------------------------------ safe rang -----------------------------------------------------------------------------------
      let geofence = null;
let geofenceActive = true;  // Track if geofence is active
let checkGeofenceInterval = null;  // Declare a variable to store the interval reference

// Function to calculate the distance between client and geofence using Haversine formula
function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // Earth's radius in kilometers
    const dLat = toRadians(lat2 - lat1);
    const dLon = toRadians(lon2 - lon1);
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
        Math.cos(toRadians(lat1)) * Math.cos(toRadians(lat2)) *
        Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c * 1000; // Distance in meters
}

// Convert degrees to radians
function toRadians(degrees) {
    return degrees * (Math.PI / 180);
}

function checkGeofence() {
    if (!geofenceActive) {
        console.log('Geofence is stopped, skipping check.');
        return;  // Skip geofence checks if geofence is stopped
    }

    if (clientLocation === null) {
        console.log("Client location is not available yet.");
        return;  // Return early if client location is not yet available
    }

    if (geofence) {
        const distance = calculateDistance(clientLocation.latitude, clientLocation.longitude, geofence.latitude, geofence.longitude);

        // If the client is outside the geofence, trigger the alert
        if (distance > geofence.radius) {
            const username = localStorage.getItem('username');
            const securityCode = localStorage.getItem('securityCode');

            // Emit the geofence alert to the server if the client is outside the geofence
            socket.emit('geofenceAlert', {
                username: username,
                message: 'Client has moved outside the geofence area!',
                latitude: clientLocation.latitude,
                longitude: clientLocation.longitude,
                securityCode: securityCode
            });
        } else {
            // If the client is inside the geofence, clear the alert
            const username = localStorage.getItem('username');
            socket.emit('clearAlert', { clientId: username });
        }
    }
}

// Client-side: When geofence is stopped, stop checking geofence
socket.on('geofenceStopped', () => {
    console.log('Geofence has been stopped. No further checks will be made.');

    // Disable geofence logic in client
    geofenceActive = false;

    // Clear the interval that checks the geofence periodically
    if (checkGeofenceInterval) {
        clearInterval(checkGeofenceInterval);  // Stop the geofence check interval
        checkGeofenceInterval = null;  // Reset the interval reference
    }
});

// Start geofence checking every 5 seconds if geofence is active
function startGeofenceCheck() {
    if (geofenceActive) {
        checkGeofenceInterval = setInterval(checkGeofence, 5000);  // Start checking every 5 seconds
    }
}

// Call getRealTimeLocation periodically (every 5 seconds) to update the client's location
setInterval(getRealTimeLocation, 5000); // This should also be cleared when the geofence is stopped

// Start geofence checking when geofence data is updated
socket.on("geofenceUpdated", (geofenceData) => {
    console.log("Received new geofence data:", geofenceData);
    geofence = geofenceData;
    
    // Start checking geofence if it's not already checking
    if (geofenceActive && !checkGeofenceInterval) {
        startGeofenceCheck();
    }

    // Update the map with the new geofence data
    if (windowMap) {
        if (geofenceMarker) windowMap.removeLayer(geofenceMarker);
        if (geofenceCircle) windowMap.removeLayer(geofenceCircle);

        geofenceMarker = L.marker([geofence.latitude, geofence.longitude]).addTo(windowMap);
        geofenceCircle = L.circle([geofence.latitude, geofence.longitude], {
            radius: geofence.radius,
            color: "blue",
            fillColor: "blue",
            fillOpacity: 0.2,
        }).addTo(windowMap);
    }
});




      //--------------------------------------------------------------------------------- check device offline --------------------------
      let currentClientId =
        localStorage.getItem("clientId") || generateClientId();
      localStorage.setItem("clientId", currentClientId);

      const username = localStorage.getItem("username");

      // Function to generate a unique client ID (you can customize this)
      function generateClientId() {
        return "client-" + Math.random().toString(36).substr(2, 9); // Random client ID
      }



document.getElementById("logoutButton").addEventListener("click", () => {
  console.log("Logging out...");

  // 1. Remove all dynamic hajSteps_ keys
  for (let i = 0; i < localStorage.length; i++) {
    const key = localStorage.key(i);
    if (key && key.startsWith("hajSteps_")) {
      localStorage.removeItem(key);
      i--;
    }
  }

  // 2. Remove known static keys
  const keysToRemove = [
    "securityCode",
    "clientId",
    "username",
    "socketId",
    "token",
    "email",
    "phoneNumber",
    "role",
    "hotelLongitude",
    "hotelLatitude",
    "longitude",
    "latitude",
    "gender",
    "adminId",
    "group",
    "groupId",
    "adminInfo",
    "groupName",
    "adminSocetId",
    "age",
    "clients",
    "offlineStatus",
    "firstName",
    "lastName"
  ];

  keysToRemove.forEach(key => {
    localStorage.removeItem(key);
    console.log(`Removed key: ${key}`);
  });

 if (localStorage.getItem("token")) {
  const status = localStorage.getItem("offlineStatus") === "offline" ? "offline" : "online";
  localStorage.setItem("offlineStatus", status);
}
    localStorage.removeItem("offlineStatus");
  


        // Notify server of logout
        socket.emit("clientStatusUpdate", {
          username,
          securityCode,
          status: "offline",
        });

 

        // Update UI status
        updateConnectionStatus(); // Set status to offline
        alert("You have been logged out.");

        // Optionally, redirect user to login page or home page
        window.location.href = "/index.html"; // Update with your login route or landing page
      });

      // Function to save location data when offline
const saveLocationDataOffline = (locationData) => {
  const clientData = {
    ...locationData,
    clientId: localStorage.getItem("clientId"),
    securityCode: localStorage.getItem("securityCode"),
  };

  if (!clientData.clientId || !clientData.securityCode) {
    console.warn("Missing client ID or security code. Skipping location save/send.");
    return;
  }

  if (!navigator.onLine) {
    const offlineData = JSON.parse(localStorage.getItem("offlineLocationData")) || [];
    offlineData.push(clientData);
    localStorage.setItem("offlineLocationData", JSON.stringify(offlineData));
    console.log("Location data saved offline.");
  } else {
    socket.emit("sendLocationToServer", clientData);
  }
};

 window.addEventListener("online", () => {
  if (localStorage.getItem("token")) {
    console.log("Client is online");
    localStorage.setItem("offlineStatus", "online");

    socket.emit("clientStatusUpdate", {
      username: localStorage.getItem("username"),
      securityCode: localStorage.getItem("securityCode"),
      status: "online",
    });

    syncOfflineData();
    updateConnectionStatus();
  }
});

window.addEventListener("offline", () => {
  if (localStorage.getItem("token")) {
    console.log("Client is offline");
    localStorage.setItem("offlineStatus", "offline");
    updateConnectionStatus();
  }
});

      // Sync offline data when coming online
      function syncOfflineData() {
        if (navigator.onLine) {
          let offlineLocationData =
            JSON.parse(localStorage.getItem("offlineLocationData")) || [];
          if (offlineLocationData.length > 0) {
            offlineLocationData.forEach((data) => {
              socket.emit("sendLocationToServer", data);
            });
            localStorage.removeItem("offlineLocationData"); // Clear offline data after syncing
            console.log("Offline location data synced");
          }
        }
      }

      // Function to update the connection status in the UI and backend
function updateConnectionStatus() {
  const statusElement = document.getElementById("connection-status");

  if (navigator.onLine) {
    statusElement.textContent = "Status: Online";
    statusElement.style.color = "green";
    updateClientStatus("online");
  } else {
    statusElement.textContent = "Status: Offline";
    statusElement.style.color = "red";
    updateClientStatus("offline");
  }
}

// Function to send the connection status to the backend
function updateClientStatus(status) {
  const clientId = localStorage.getItem("clientId"); // moved inside function
  if (!clientId) return;

  const apiUrl = `https://my-node-backend-fcdy.onrender.com/updateClientStatus`;

  fetch(apiUrl, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      clientId,
      status,
    }),
  })
    .then((response) => response.json())
    .then((data) => {
      if (data.success) {
        console.log("the data from update client status: ", data);
        console.log("Status updated successfully");
      } else {
        console.error("Failed to update status");
      }
    })
    .catch((error) => {
      console.error("Error updating status:", error);
    });
}

      // Send initial client status (whether online or offline)
function checkOnlineStatus() {
  const username = localStorage.getItem("username");
  const securityCode = localStorage.getItem("securityCode");

  if (username && securityCode && localStorage.getItem("token")) {
    const status = navigator.onLine ? "online" : "offline";
    socket.emit("clientStatusUpdate", { username, securityCode, status });
  }
}

      // Call initial status check and update UI
      updateConnectionStatus();
      checkOnlineStatus();

      // Example of saving location data
      setInterval(() => {
        const fakeLocationData = {
          latitude: Math.random() * 90, // Random lat for demo purposes
          longitude: Math.random() * 180, // Random lon for demo purposes
          timestamp: Date.now(),
        };
        saveLocationDataOffline(fakeLocationData); // Simulating location data update
      }, 5000); // Every 5 seconds for demo

      function sendLocationData(
        username,
        securityCode,
        clientId,
        latitude,
        longitude
      ) {
        const clientData = {
          username: username,
          securityCode: securityCode,
          clientId: clientId, // Ensure clientId is included
          latitude: latitude,
          longitude: longitude,
          timestamp: new Date(), // Ensure timestamp is included
        };

        // Emit the 'sendLocationData' event with the location data
        socket.emit("sendLocationData", clientData);
      }


     document.addEventListener('DOMContentLoaded', function() {
        let myName;
      let stream;
let peerConnection;
let me;
let callAccepted = false;
let callEnded = false;
let callerSignal;
let callerId;
let callerGender = null



const storedadminNameElem = document.getElementById('storedadminName');
if (storedadminNameElem) {
     myName = storedadminNameElem.textContent;
    console.log(myName);  // Output: the name
} else {
    console.error('Element not found!');
}

let soc;
socket.on('connect', () => {
    console.log('Connected to server with socket ID: ' + socket.id);
    localStorage.setItem("socketId", socket.id)
    
});
setTimeout(() => {
    soc = localStorage.getItem('socketId');
    console.log('Socket ID from localStorage after 5 seconds:', soc);
}, 5000); 

soc =localStorage.setItem("socketId", socket.id)
 // Fetch admin details from the server and update the DOM
 function fetchAdminDetails() {
  const adminInfo = localStorage.getItem('adminInfo');
if (!adminInfo) {
  console.error("Admin info not found in localStorage.");
  return;
}

const parsedAdminInfo = JSON.parse(adminInfo);
const adminId = parsedAdminInfo ? parsedAdminInfo.adminId : null;
console.log("adminInfo ", parsedAdminInfo);
console.log("adminId : ", adminId);

if (!adminId) {
  console.error("Admin ID is missing.");
  return;
}
  socket.on('connect', () => {
    console.log('Socket connected with ID:', socket.id);

    // Wait for the socketId to be updated in the DB before fetching admin details

    // Make a request to the server to fetch admin details after socket connection
    fetch(`https://my-node-backend-fcdy.onrender.com/get-admin-details/${adminId}`)
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          console.log("data from fetch admin: ", data)
          const adminPhoneNumber = data.adminPhoneNumber;
         storedAdminName = data.adminUsername;
          storedAdminSocketId = data.adminSocketId;
          console.log("admin name: ", storedAdminName)
          console.log("admin phone: ", adminPhoneNumber)
          console.log("admin socket ID: ", storedAdminSocketId)
          localStorage.setItem('adminSocetId', data.adminSocketId)

       document.getElementById("callTheAdmin").innerHTML = `Call ${storedAdminName}`
          

          // Update DOM with fetched admin details
          const adminDetailsDiv = document.getElementById('adminDetails');
          adminDetailsDiv.innerHTML = '';  // Clear previous data

          const adminUsernameElem = document.createElement('p');
          adminUsernameElem.textContent = `Admin Username: ${storedAdminName}`;

          const adminPhoneElem = document.createElement('p');
          adminPhoneElem.textContent = `Admin Phone: ${adminPhoneNumber}`;

          const adminSocketIdElem = document.createElement('p');
          adminSocketIdElem.textContent = `Admin Socket ID: ${storedAdminSocketId || 'Not connected'}`;

          // Append to the container
          adminDetailsDiv.appendChild(adminUsernameElem);
          adminDetailsDiv.appendChild(adminPhoneElem);
          adminDetailsDiv.appendChild(adminSocketIdElem);

          // Set myName after the fetch completes
          myName = storedAdminName;
          console.log('Admin Name:', myName);  // Now you can safely use myName
        } else {
          console.error('Error fetching admin details:', data.message);
        }
      })
      .catch(error => {
        console.error('Error fetching admin details:', error);
      });
  });

  socket.on('connect_error', (error) => {
    console.error('Socket connection error:', error);
  });
}

// Call the function to fetch admin details



const myVideo = document.getElementById('my-video');
const userVideo = document.getElementById('user-video');
const videoContainer = document.getElementsByClassName('video-container')
const theVideoCallLive = document.getElementById('video-call-container')
const localVideoContainer = document.getElementById('local-video-placeholder');
const remoteVideoContainer = document.getElementById('remote-video-container');
const startCallButton = document.getElementById('start-call');
const endCallButton = document.getElementById('end-call');
const copyIdButton = document.getElementById('copy-id');
const idToCallInput = document.getElementById('idToCall');
const callerContainer = document.getElementById('caller-container');
const answerCallButton = document.getElementById('answer-call');
const callerNameDisplay = document.getElementById('caller-name');
const nameInput = document.getElementById('name');
const clientGender = localStorage.getItem('gender')
// New UI elements for post-call
const afterAnswerContainer = document.getElementById('after-answer');
const youLiveWithNameDisplay = document.getElementById('you-live-with-name');
const muteButton = document.getElementById('mute-button');
const cameraButton = document.getElementById('camera-button');

// Get user media only when starting or answering a call
// Get user media only when starting or answering a call
function initializeMedia(isVideoEnabled) {
  return navigator.mediaDevices.getUserMedia({
    video: isVideoEnabled,  // Use video if true, audio-only if false
    audio: true  // Always enable audio
  })
    .then((userStream) => {
      stream = userStream;
      myVideo.srcObject = userStream;
      localVideoContainer.style.display = 'none'; // Hide video icon when stream is available
    })
    .catch((error) => {
      console.error("Camera or microphone not available", error);
    });
}


socket.on("me", (id) => {
  me = id; // Store the user's unique socket ID
});

// Listen for incoming calls
socket.on("callUser", (data) => {
  callerSignal = data.signal;
  callerId = data.from;
  callerGender = data.gender;
  callerNameDisplay.textContent = `${data.name} is calling...;`
  callerContainer.style.display = 'block';
});

// Start a call to another user (admin in this case)
function startCalla(idToCall, storedAdminName) {
  const clientGender = localStorage.getItem('gender');  // Get the gender from localStorage
  console.log('Gender from localStorage:', clientGender);

    console.log('socket of admin: ', storedadminSocketId);
    console.log('socket of client: ', soc);
    console.log('name of admin: ', storedAdminName);

    myName = localStorage.getItem("username");
    idToCall = localStorage.getItem('adminSocetId');
    console.log("idToCall ", idToCall);
    console.log('name of client: ', myName);

    // First, let's fetch the updated admin details from the server to get the latest socket ID
    const adminInfo = localStorage.getItem('adminInfo');
    if (!adminInfo) {
        console.error("Admin info not found in localStorage.");
        return;
    }

    const parsedAdminInfo = JSON.parse(adminInfo);
    const adminId = parsedAdminInfo ? parsedAdminInfo.adminId : null;
    
    if (!adminId) {
        console.error("Admin ID is missing.");
        return;
    }

    // Fetch admin details to get the latest socket ID
    fetch(`https://my-node-backend-fcdy.onrender.com/get-admin-details/${adminId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update adminSocketId in localStorage
                console.log(data)
                const currentAdminSocketId = data.adminSocketId;
                const currentAdminGender = data.adminGender
                localStorage.setItem('adminSocetId', currentAdminSocketId);
                console.log("Updated Admin Socket ID: ", currentAdminSocketId);

                // Retrieve the socket ID from localStorage if it's available or use the current socket.id
                const soc = localStorage.getItem('socketId') || socket.id;
                console.log('Client Socket ID:', soc);

                // Now that we have the correct socket ID, proceed to initialize the call
                answerCallButton.style.display = 'none'; // Hide the Answer button

                // Initialize media (open camera and microphone) when starting a call
                const isVideoEnabled = currentAdminGender === clientGender; // Use video if same gender
                console.log("gender of admin is: ", currentAdminGender)
                console.log("gender is same in the caller: ", isVideoEnabled)

// Initialize media (audio and video if same gender, audio only if different gender)
initializeMedia(isVideoEnabled).then(() => {
  const peer = new SimplePeer({
    initiator: true,
    trickle: false,
    stream: stream
  });

                    peer.on("signal", (data) => {
                        // Emit the call to the server, including the updated admin socket ID, signal data, and the client details
                        socket.emit("callUser", {
                            userToCall: currentAdminSocketId,
                            signalData: data,
                            from: soc,
                            name: myName,
                            gender:clientGender
                        });
                    });

                    peer.on("stream", (remoteStream) => {
                        userVideo.srcObject = remoteStream;
                        remoteVideoContainer.style.display = 'block'; // Show the remote video container
                    });

                    socket.on("callAccepted", (signal) => {
                        callAccepted = true;
                        peer.signal(signal);
                        console.log("acceplted and live with : ", storedAdminName)
                        startCallButton.style.display = 'none'; // Hide start call button for caller
                        afterAnswerContainer.style.display = 'block'; // Show post-call UI
                        youLiveWithNameDisplay.textContent = `You live with ${storedAdminName}`; // Update message for caller
                    });

                    peerConnection = peer; // Store the peer connection instance for further control
                });
            } else {
                console.error('Error fetching admin details:', data.message);
            }
        })
        .catch(error => {
            console.error('Error fetching admin details:', error);
        });
}



    socket.on('connect', () => {
  console.log('Socket connected with ID:', socket.id);

  const adminInfo = localStorage.getItem('adminInfo');
if (!adminInfo) {
  console.error("Admin info not found in localStorage.");
  return;
}

const parsedAdminInfo = JSON.parse(adminInfo);
const adminId = parsedAdminInfo ? parsedAdminInfo.adminId : null;
console.log("adminInfo ", parsedAdminInfo);
console.log("adminId : ", adminId);


if (!adminId) {
  console.error("Admin ID is missing.");
  return;
}


});
  // Proceed with fetching the admin details after the socket connection
  fetchAdminDetails();

startCallButton.addEventListener("click", () => {
  // Call the function with the correct parameters when the button is clicked
  startCalla(storedadminSocketId, myName);
  theVideoCallLive.style.display='block'

});
endCallButton.addEventListener('click', () => {
  theVideoCallLive.style.display='none'
  endCall()
})
answerCallButton.addEventListener('click',  answerCall)
// Answer an incoming call
function answerCall() {
  theVideoCallLive.style.display='block'
  const clientGender = localStorage.getItem('gender');  // Get the gender from localStorage

  const isVideoEnabled = clientGender === callerGender;  // Same gender uses video


  // Initialize media (open camera and microphone) when answering a call
  initializeMedia(isVideoEnabled).then(() => {
    const peer = new SimplePeer({
      initiator: false,
      trickle: false,
      stream: stream
    });

    peer.on("signal", (data) => {
      socket.emit("answerCall", { signal: data, to: callerId });
    });

    peer.on("stream", (remoteStream) => {
      userVideo.srcObject = remoteStream;
      remoteVideoContainer.style.display = 'block';
      localVideoContainer.style.display = 'block';
    });

    peer.signal(callerSignal);
    peerConnection = peer;

    // Change UI after answering the call
    startCallButton.style.display = 'none';
    callerContainer.style.display = 'none'; // Hide incoming call message
    answerCallButton.style.display = 'none';  // Hide the Answer button
    afterAnswerContainer.style.display = 'block'; // Show the new post-call UI
    youLiveWithNameDisplay.textContent =` You live with ${callerNameDisplay.textContent.replace(' is calling...', '')}`; // Set the new message

    // Show the mute, camera off, and end call buttons for the receiver as well
    socket.emit("callAccepted", { signal: peer.signal, to: callerId });
  });
}

// Mute / Unmute audio
function toggleMute() {
  const audioTrack = stream.getAudioTracks()[0];
  if (audioTrack.enabled) {
    audioTrack.enabled = false;
    muteButton.textContent = 'Unmute'; // Change button text
  } else {
    audioTrack.enabled = true;
    muteButton.textContent = 'Mute'; // Change button text
  }
}

// Turn off / Turn on camera
function toggleCamera() {
  const videoTrack = stream.getVideoTracks()[0];
  if (videoTrack.enabled) {
    videoTrack.enabled = false;
    cameraButton.textContent = 'Turn On Camera'; // Change button text
  } else {
    videoTrack.enabled = true;
    cameraButton.textContent = 'Turn Off Camera'; // Change button text
  }
}

// End the call
function endCall() {
  callEnded = true;

  // Stop the local stream and remote stream
  if (peerConnection) {
    peerConnection.destroy();
  }
  if (stream) {
    stream.getTracks().forEach(track => track.stop()); // Stop local media tracks
  }

  // Hide video and control elements for both users
  remoteVideoContainer.style.display = 'none';
  afterAnswerContainer.style.display = 'none'; // Hide post-call controls
  startCallButton.style.display = 'block'; // Show the "Start Call" button again

  // Reset the "You live with" message for both users
  youLiveWithNameDisplay.textContent = '';

  // Show the caller container again for new calls
  callerContainer.style.display = 'none'; // Reset the caller container
  muteButton.textContent = 'Mute'; // Reset mute button
  cameraButton.textContent = 'Turn Off Camera'; // Reset camera button

  // Emit the end call event to both users
  socket.emit("callEnded", { to: callerId });
  location.reload(); // Refresh the page after the call ends
}

// Copy the user's ID to clipboard
function copyToClipboard() {
  navigator.clipboard.writeText(me);
  alert('ID copied to clipboard');
}

// Listen for the callEnd event from the server and reset the UI
socket.on('callEnded', () => {
  endCall(); // Ensure the UI resets after the call ends
  location.reload(); // Refresh the page after the call ends
});
socket.on('connect', () => {
    console.log('Connected to server with socket ID: ' + socket.id);
    localStorage.setItem("socketId", socket.id)
});


})


socket.emit('readyForNewCall', { socketId: socket.id });
// Get the fullscreen button and video containers
const fullscreenButton = document.getElementById('fullscreenButton');
const videoContainer = document.getElementById('video-call-container');

// Function to enter fullscreen for the video container
function enterFullscreen() {
    if (videoContainer.requestFullscreen) {
        videoContainer.requestFullscreen();
    } else if (videoContainer.mozRequestFullScreen) { // Firefox
        videoContainer.mozRequestFullScreen();
    } else if (videoContainer.webkitRequestFullscreen) { // Chrome, Safari, Opera
        videoContainer.webkitRequestFullscreen();
    } else if (videoContainer.msRequestFullscreen) { // IE/Edge
        videoContainer.msRequestFullscreen();
    }
}

// Function to exit fullscreen
function exitFullscreen() {
    if (document.exitFullscreen) {
        document.exitFullscreen();
    } else if (document.mozCancelFullScreen) { // Firefox
        document.mozCancelFullScreen();
    } else if (document.webkitExitFullscreen) { // Chrome, Safari, Opera
        document.webkitExitFullscreen();
    } else if (document.msExitFullscreen) { // IE/Edge
        document.msExitFullscreen();
    }
}

// Toggle fullscreen for the video container
fullscreenButton.addEventListener('click', function () {
    if (!document.fullscreenElement) {
        // Apply fullscreen styles
        videoContainer.classList.add('fullscreen');
        remoteVideoContainer.classList.add('fullscreen');
        localVideoContainer.classList.add('fullscreen');
        enterFullscreen(); // Enter fullscreen mode
        fullscreenButton.innerHTML = '<i class="fas fa-compress"></i>'; // Change icon to compress
    } else {
        // Remove fullscreen styles
        videoContainer.classList.remove('fullscreen');
        remoteVideoContainer.classList.remove('fullscreen');
        localVideoContainer.classList.remove('fullscreen');
        exitFullscreen(); // Exit fullscreen mode
        fullscreenButton.innerHTML = '<i class="fas fa-expand"></i>'; // Change icon back to expand
    }
});

// Listen for fullscreen changes (exit fullscreen via ESC key or other means)
document.addEventListener('fullscreenchange', function () {
    if (!document.fullscreenElement) {
        // Reset the layout when exiting fullscreen
        videoContainer.classList.remove('fullscreen');
        remoteVideoContainer.classList.remove('fullscreen');
        localVideoContainer.classList.remove('fullscreen');
        fullscreenButton.innerHTML = '<i class="fas fa-expand"></i>';
    }
});




// done with css and geofence 
// Start with chat
const userListContainer = document.querySelector('.user-list');

document.getElementById('scroll-left').addEventListener('click', () => {
    userListContainer.scrollBy({
        left: -200,
        behavior: 'smooth',
    });
});

document.getElementById('scroll-right').addEventListener('click', () => {
    userListContainer.scrollBy({
        left: 200,
        behavior: 'smooth',
    });
});

console.log("First Name of the client: ", firstName)
let roomGroup = ''; // To hold the room name dynamically fetched
let loggedInUser = { login: '', firstName: firstName, imageUrl: 'default.jpg' }; // Mock user
selectedRoom = localStorage.getItem('groupName')
let messages = {}; // Store messages by room
let reactions = {}; // Store reactions by message ID

// Frontend (client) - Listen for 'update typing' event
socket.on('update typing', (typingUsersList) => {
    const typingIndicator = document.getElementById('typingIndicator');
    const typingMessage = document.getElementById('typingMessage');
    
    // Clear the typing indicator text and hide it initially
    typingMessage.innerHTML = '';
    typingIndicator.style.display = 'none';

    if (typingUsersList.length > 0) {
        typingIndicator.style.display = 'inline-block'; // Show typing indicator
        
        // Create the message for typing users
        if (typingUsersList.length === 1) {
            typingMessage.innerHTML = `${typingUsersList[0]} is typing`;
        } else if (typingUsersList.length === 2) {
            typingMessage.innerHTML = `${typingUsersList[0]} and ${typingUsersList[1]} are typing`;
        } else {
            typingMessage.innerHTML = `${typingUsersList[0]} and ${typingUsersList[1]} are typing, and ${typingUsersList.length - 2} others...`;
        }
    }
});


// Frontend (client) - Handling input and sending 'typing' event

let typingTimeout;
const typingDelay = 1000;  // 1 second delay to stop typing event after typing stops

document.getElementById('inputMessage').addEventListener('input', (e) => {
    console.log('User is typing...');  // Debugging log
    const inputMessage = e.target.value;
    const atPosition = inputMessage.lastIndexOf('@'); // Find the position of '@'

    // If '@' is typed, display the user dropdown
    if (atPosition !== -1) {
        const query = inputMessage.slice(atPosition + 1); // Get the text after '@'

        // Filter the users list based on the query
        const filteredUsers = usersList.filter(user => user.startsWith(query));

        // Display the user dropdown
        showMentionDropdown(filteredUsers);
    } else {
        // Hide the dropdown if '@' is not typed
        hideMentionDropdown();
    }

    clearTimeout(typingTimeout); // Clear any previous typing timeout

    // Emit 'typing' event when the user starts typing
    socket.emit('typing', { 
        room: selectedRoom, 
        username: loggedInUser.login, 
        typing: true 
    });

    // Set a timeout to stop typing event after the delay (1 second)
    typingTimeout = setTimeout(() => {
        socket.emit('typing', { 
            room: selectedRoom, 
            username: loggedInUser.login, 
            typing: false 
        });
    }, typingDelay);
});


// Function to show the mention dropdown with filtered users
function showMentionDropdown(users) {
    const dropdown = document.getElementById('mentionDropdown');
    dropdown.innerHTML = ''; // Clear previous list

    // Create list items for the filtered users
    users.forEach(user => {
        const li = document.createElement('li');
        li.textContent = user;
        li.addEventListener('click', () => {
            // When a user is clicked, insert the mention into the input field
            insertMention(user);
            hideMentionDropdown(); // Hide the dropdown after selection
        });
        dropdown.appendChild(li);
    });

    dropdown.style.display = users.length > 0 ? 'block' : 'none'; // Show the dropdown only if there are users
}

// Function to hide the mention dropdown
function hideMentionDropdown() {
    const dropdown = document.getElementById('mentionDropdown');
    dropdown.style.display = 'none'; // Hide the dropdown
}

// Function to insert the selected mention into the input field
function insertMention(username) {
    const inputMessage = document.getElementById('inputMessage');
    const messageValue = inputMessage.value;

    const atPosition = messageValue.lastIndexOf('@');
    const newMessage = messageValue.slice(0, atPosition) + '@' + username + ' ';
    inputMessage.value = newMessage;

    inputMessage.focus(); // Keep focus on the input field
    inputMessage.selectionStart = inputMessage.selectionEnd = newMessage.length; // Move cursor to the end
}




let hasJoinedRoom = false;
// Prompt for username
function promptForUsername() {
    let username = clientName;
    while (!username) {
        username = prompt("Please enter a username:");
    }
    loggedInUser.login = username;

    // Ensure the room is joined only once
    if (!hasJoinedRoom) {
        socket.emit('join', selectedRoom, username);
        hasJoinedRoom = true;
    }

    document.getElementById('chat-container').style.display = 'none';
    }

// Event listener to send a message
document.getElementById('chatForm').addEventListener('submit', (e) => {
    e.preventDefault(); // Prevent form submission

    const inputMessage = document.getElementById('inputMessage').value.trim();
    if (inputMessage) {
        sendMessage(inputMessage);
        document.getElementById('inputMessage').value = ''; // Clear input
    }
});

// Send message to the server
function sendMessage(message) {
    const timestamp = new Date().toISOString();  // Get current timestamp
    const messageData = {
        text: message,
        user: loggedInUser,
        room: selectedRoom,
        timestamp: timestamp // Store the timestamp with the message
    };
    console.log('Sending message:', messageData);  // Debugging log to ensure message is sent
    socket.emit('chat message', messageData);
}


// Frontend (client) - Listen for incoming chat message
socket.on('chat message', (message) => {
    console.log('Received message:', message); // Debugging log to check if messages are received

    // Store the message by room
    if (!messages[message.room]) {
        messages[message.room] = [];
    }
    messages[message.room].push(message);

    // Detect mentions in the message
    const mentions = detectMentions(message.text);
    updateMentionCounts(mentions);  // Update mention counts
    notifyMentionedUsers(mentions); // Notify mentioned users

    // Render messages if they belong to the selected room
    if (message.room === selectedRoom) {
        renderMessages(); // Only render messages if they are from the selected room
    }
});

// Maintain a set of user IDs (or usernames) to prevent duplicates
// Maintain a set of user IDs to prevent duplicates
let displayedUserIds = new Set();
let usersList = [];
socket.on('update user list', (userList) => {
const status = localStorage.getItem('offlineStatus')
    const userListElement = document.getElementById('userList');
    userListElement.innerHTML = '';  // Clear existing list

    if (!userList || userList.length === 0) {
        console.log("No users to display.");
        return;  // No users to display
    }

    // Reset the displayed user set to track current users
    displayedUserIds.clear();
    usersList = userList.map(user => user.username); // Store the usernames
    userList.forEach((user) => {
        // Debugging log to see what users are being passed
        console.log('User:', user);

        // If this user ID is already in the set, skip adding them again
        if (displayedUserIds.has(user.id)) {
            console.log(`Skipping duplicate user: ${user.username}`);
            return;
        }

        // Add user ID to the set to prevent future duplicates
        displayedUserIds.add(user.id);

        // Create and append the list item
        const li = document.createElement('li');
        li.id = `${user.username}`;

        // Create the status dot <span>
        const statusDot = document.createElement('span');
        statusDot.classList.add('status-dot');

        // Set the color of the dot based on the user's status (online/offline)
        if (status === 'online') {
            statusDot.style.backgroundColor = '#26c026';  // Green dot for online users
        } else {
            statusDot.style.backgroundColor = '#80808075';   // Gray dot for offline users
        }

        // Create the username span element
        const usernameText = document.createElement('span');
        usernameText.textContent = user.username;

        // Append the dot and username to the list item
        li.appendChild(statusDot);
        li.appendChild(usernameText);

        // Append the list item to the user list element
        userListElement.appendChild(li);
    });

    console.log('Updated user list for selected room displayed.');
});

// Frontend (client) - Listen for chat history event
socket.on('chat history', (roomMessages) => {
    // console.log('Received chat history for room:', selectedRoom, roomMessages);

    // Store messages for the room
    messages[selectedRoom] = roomMessages;

    // Render the messages for the selected room
    renderMessages();
});



// Handle emoji picker toggle
document.getElementById('emojiPicker').addEventListener('click', () => {
    const emojiPickerContainer = document.getElementById('emojiPickerContainer');
    emojiPickerContainer.style.display = emojiPickerContainer.style.display === 'none' ? 'block' : 'none';
});

// Handle emoji click and insert emoji into the input field
document.querySelectorAll('.emoji').forEach(emoji => {
    emoji.addEventListener('click', (event) => {
        const emojiText = event.target.getAttribute('data-emoji');
        const inputMessage = document.getElementById('inputMessage');
        inputMessage.value += emojiText; // Append emoji to the input field
        inputMessage.focus(); // Ensure focus stays on the input field
        document.getElementById('emojiPickerContainer').style.display = 'none'; // Hide the picker after selection
    });
});

// Room selection logic (updated)
document.getElementById('roomSelect').textContent = selectedRoom
const gender = localStorage.getItem('gender')

// Regular expression to detect @username (only valid usernames)
const mentionRegex = /@([a-zA-Z0-9_]+)/g;

// Function to detect mentions in a message
function detectMentions(messageText) {
    let mentions = [];
    let match;
    while ((match = mentionRegex.exec(messageText)) !== null) {
        mentions.push(match[1]);  // The username mentioned
    }
    return mentions;
}

// Store mention counts
let mentionCounts = {};  // Object to store mention counts

// Function to update mention counts
function updateMentionCounts(mentions) {
    mentions.forEach(mention => {
        // If this mention already exists in mentionCounts, increment its count
        if (mentionCounts[mention]) {
            mentionCounts[mention] += 1;  // Increment mention count
        } else {
            mentionCounts[mention] = 1;   // Set initial mention count to 1 for this user
        }
    });
    updateChatToggleIcon();  // Update the UI after modifying mention counts
}

// Function to notify the mentioned user
function notifyMentionedUsers(mentions) {
    mentions.forEach(mention => {
        if (mention !== loggedInUser.login) {
            socket.emit('mention notification', {
                mentionedUser: mention,
                room: selectedRoom,
                message: `${loggedInUser.login} mentioned you in a message`
            });
        }
    });
}

// Function to update the chat toggle icon with the mention count
function updateChatToggleIcon() {
    const toggleButton = document.getElementById('toggle-chat-btn');
    let mentionCount = mentionCounts[loggedInUser.login] || 0;

    // If there are mentions, show the count
    if (mentionCount > 0) {
      toggleButton.innerHTML = `
    <span class="material-icons">
        <img src="img/chat.png" style="width: 30px; height: 30px; margin-bottom: -10px;">
        <span id="mentionCount">${mentionCount}</span>
    </span>`;
    } 
}

// Frontend (client) - Listen for the notification event
socket.on('notification', (data) => {
    const { message, room } = data;
    alert(`You were mentioned in room ${room}: ${message}`);
});

function renderMessages() {
    const messageList = document.getElementById('messageList');
    messageList.innerHTML = '';  // Clear existing messages

    // Get messages for the selected room
    const roomMessages = messages[selectedRoom] || [];
    // console.log('Messages for room:', selectedRoom, roomMessages);

    roomMessages.forEach((message) => {
        const messageElement = document.createElement('div');
        messageElement.classList.add('message');

        let displayName = message.user === loggedInUser.login ? 'me' : message.user;

        // Detect mentions in the original message
        let messageContent = message.text;
        const mentions = detectMentions(message.text);

        // Check if the logged-in user is mentioned in the original message
        let isMentionedInOriginal = mentions.includes(loggedInUser.login);

        // Highlight the original message if the logged-in user is mentioned
        mentions.forEach(mention => {
            const mentionLink = `<span class="mention">@${mention}</span>`;
            messageContent = messageContent.replace(`@${mention}`, mentionLink);
        });

        // If the logged-in user is mentioned in the original message, add the highlighted class
        if (isMentionedInOriginal) {
            messageElement.classList.add('mentioned-message');
        }

        messageElement.innerHTML = `
            <div class="message-header">
                <img src="img/male.png" alt="${message.user}" class="user-image">
                <span class="username">${displayName}</span>
            </div>
            <div class="message-content">${messageContent}</div>
        `;

        // Add "+" button for replies
        const replyButton = document.createElement('button');
        replyButton.classList.add('reply-btn');
        replyButton.innerHTML = '<img src="img/reply2.png" style="width: 20px; height: 20px;"></span>';
        messageElement.appendChild(replyButton);

        // Event listener to show reply input when "+" button is clicked
        replyButton.addEventListener('click', () => {
            let replyInput = messageElement.querySelector('.reply-input');
            if (!replyInput) {
                replyInput = document.createElement('input');
                replyInput.classList.add('reply-input');
                replyInput.placeholder = 'Write a reply...';
                messageElement.appendChild(replyInput);

                const replySubmitButton = document.createElement('button');
                replySubmitButton.classList.add('reply-submit-btn');
                replySubmitButton.textContent = 'Reply';
                messageElement.appendChild(replySubmitButton);

                replySubmitButton.addEventListener('click', () => {
                    const replyText = replyInput.value.trim();
                    if (replyText) {
                        const replyMessage = {
                            text: replyText,
                            user: loggedInUser,
                            replyTo: message._id,  // Link the reply to the original message ID
                            room: selectedRoom,
                            timestamp: new Date().toISOString(),
                        };

                        socket.emit('chat message', replyMessage);

                        replyInput.value = '';
                        replyInput.remove();
                        replySubmitButton.remove();
                    }
                });
            }
        });

        // Render replies if any
        if (message.replies && message.replies.length > 0) {
            const replyCount = message.replies.length;
            let mentionsUserInReplies = false;

        
            // Create a container for reply count
            const replyCountElement = document.createElement('div');
            replyCountElement.classList.add('reply-count');
            replyCountElement.textContent = `${replyCount} reply${replyCount > 1 ? 's' : ''}`;

            // Check if any reply mentions the logged-in user
            message.replies.forEach(reply => {
                const replyMentions = detectMentions(reply.text);
                if (replyMentions.includes(loggedInUser.login)) {
                    mentionsUserInReplies = true;
                    
                }
            });

            // If any reply mentions the logged-in user, change the color of replyCountElement
            if (mentionsUserInReplies) {
                replyCountElement.style.color = 'blue';  // Change color (you can customize it)
                replyCountElement.style.background = '#4dff0036'; 

            }

            messageElement.appendChild(replyCountElement);

            // Create a container for replies
            const repliesContainer = document.createElement('div');
            repliesContainer.classList.add('replies-container');
            repliesContainer.style.display = 'none';  // Hide replies initially

            // Add replies
            message.replies.forEach(reply => {
                const replyElement = document.createElement('div');
                replyElement.classList.add('reply');
                replyElement.style.fontSize = '0.8em';  // Smaller size for replies
                replyElement.style.color = 'gray';      // Gray color for replies

                // Check if the reply mentions the logged-in user
                let isMentionedInReply = detectMentions(reply.text).includes(loggedInUser.login);

                // Highlight the reply if it mentions the logged-in user
                if (isMentionedInReply) {
                    replyElement.classList.add('mentioned-message'); // Highlight reply if it mentions the logged-in user
                  
    
                }

                // Check if the original message is also mentioned and highlight it
                if (isMentionedInOriginal) {
                    messageElement.classList.add('mentioned-message'); // Highlight original message if it mentions the logged-in user
                }

                replyElement.innerHTML = `
                    <div class="reply-header">
                        <span class="username">${reply.user === loggedInUser.login ? 'me' : reply.user}</span>
                        <span class="reply-time">${new Date(reply.timestamp).toLocaleTimeString()}</span>
                    </div>
                    <div class="reply-content">${reply.text}</div>
                `;
                repliesContainer.appendChild(replyElement);
            });

            // Append replies container to message
            messageElement.appendChild(repliesContainer);

            // Toggle replies on reply count click
            replyCountElement.addEventListener('click', () => {
                const isVisible = repliesContainer.style.display === 'block';
                repliesContainer.style.display = isVisible ? 'none' : 'block';  // Toggle visibility
            });
        }

        // Append the message to the list
        messageList.appendChild(messageElement);
    });

    messageList.scrollTop = messageList.scrollHeight;  // Scroll to the bottom
}

// Toggle chat container visibility
function toggleChat() {
    const chatContainer = document.getElementById('chat-container');
    const toggleButton = document.getElementById('toggle-chat-btn');

    if (!chatContainer || !toggleButton) {
        console.error("Chat container or toggle button not found!");
        return;
    }

    // Toggle chat visibility and update the button's icon accordingly
    if (chatContainer.style.display === 'none') {
        chatContainer.style.display = 'flex'; // Show the chat container
        // Reset the mention count to 0 when opening the chat container
        mentionCounts[loggedInUser.login] = 0;
        toggleButton.innerHTML = '<span class="material-icons"><img src="img/minus-icon.png" style="width: 30px; height: 30px; margin-bottom: -6px;"></span>'; // Change icon to close
        // Optionally, log a message saying user joined the chat
        console.log('User has opened the chat.');

        // Emit the user joining the chat along with the color change
        socket.emit('userJoinLeave', {
            roomId: selectedRoom,
            message: `${loggedInUser.login} has joined the room ${selectedRoom}`,
            username: loggedInUser.login,
            action: 'join'
        });
    } else {
        chatContainer.style.display = 'none'; // Hide the chat container
        toggleButton.innerHTML = '<span class="material-icons"><img src="img/chat.png" style="width: 30px; height: 30px; margin-bottom: -10px;"></span>'; // Change icon to chat
        // Optionally, log a message saying user left the chat
        console.log('User has closed the chat.');

        // Emit the user leaving the chat along with the color change
        socket.emit('userJoinLeave', {
            roomId: selectedRoom,
            message: `${loggedInUser.login} has left the room ${selectedRoom}`,
            username: loggedInUser.login,
            action: 'leave'
        });
    }
}

// Listen for color change and update the user's color
socket.on('colorChange', (data) => {
    const userElement = document.getElementById(data.username);
    if (userElement) {
        if (data.action === 'join') {
            userElement.style.color = 'black'; // User joined, set color to black
        } else if (data.action === 'leave') {
            userElement.style.color = 'gray'; // User left, set color to gray
        }
    }
});


// Listen for system messages (e.g., "user has joined" or "user has left")
socket.on('systemMessage', (data) => {
    const { message, roomId } = data;  // Destructure the incoming data properly
    console.log("message: ", message, "roomId: ", roomId);  // Log the message and roomId for debugging

    // Check if the system message is for the current room
    if (roomId === selectedRoom) {
        // Ensure that the message is a string (it should be based on your server-side logic)
        if (typeof message === 'string') {
            // Push the system message into the room's message array
            messages[selectedRoom].push({ user: 'System', text: message });

            // Re-render the chat to show the system message
            renderMessages();
        } else {
            console.error("Received message is not a string:", message);
        }
    }
});








// Helper function to send a system message to notify others about user join/leave
function sendSystemMessage(text) {
    const systemMessage = {
        user: 'System',
        text: text,
    };
    // Push the system message to the current room
    messages[selectedRoom].push(systemMessage);
    renderMessages();  // Re-render messages to show the system notification
}
// Call the prompt on page load
promptForUsername();

 


    </script>
    <script>
      // Toggle button functionality to show or hide room details
document.getElementById('toggle-room-details').addEventListener('click', () => {
  console.log('Button clicked');
    const roomDetails = document.getElementById('room-details');
    const toggleButton = document.getElementById('toggle-room-details');

    if (roomDetails.style.display === 'none') {
        roomDetails.style.display = 'block';
        toggleButton.innerText = 'Hide Room Details'; // Change button text
    } else {
        roomDetails.style.display = 'none';
        toggleButton.innerText = 'Show Room Details'; // Change button text
    }
    
    fetchRoomForClient(); // Call the function to fetch room details when button is clicked
});

// Fetch room details for the current client
async function fetchRoomForClient() {
    console.log('Fetching room details for client...');
    const clientId = localStorage.getItem('clientId'); // Get clientId from localStorage

    if (!clientId) {
        alert('Client ID is missing');
        return;
    }

    try {
        // Fetch room details where the client is present
        const response = await fetch(`https://my-node-backend-fcdy.onrender.com/get-room-for-client?clientId=${clientId}`);
        console.log('Response:', response); // Check if the response is being received

        const data = await response.json();
        console.log('Room data:', data); // Check the data received from the server

        if (data.success || Array.isArray(data)) {
            const roomData = data[0]; // Assume the client is in only one room

            if (roomData) {
                // Display room details and clients
                displayRoomDetails(roomData);
            } else {
                alert('No room found for this client');
            }
        } else {
            alert('Failed to fetch room data');
        }
    } catch (error) {
        console.error('Error fetching room data:', error);
        alert('Error fetching room data');
    }
}

async function displayRoomDetails(roomData) {
    // Update room details in the HTML
    document.getElementById('room-number-detail').innerText = roomData.roomNumber;
    document.getElementById('hotel-name-detail').innerText = roomData.hotelName;
    document.getElementById('room-level').innerText = roomData.level;
    document.getElementById('start-date').innerText = new Date(roomData.startDate).toLocaleDateString();
    document.getElementById('end-date').innerText = new Date(roomData.endDate).toLocaleDateString();

    // Populate clients list
    const clientList = document.getElementById('client-list');
    clientList.innerHTML = ''; // Clear any existing content

    roomData.clients.forEach(client => {
        const clientItem = document.createElement('li');
        
        const clientId = localStorage.getItem('clientId'); // Get the logged-in clientId
        
        // Display the client info and the "Update Key Status" button only if the current client is the same as the logged-in client
        clientItem.innerHTML = `
            ${client.clientId.firstName} ${client.clientId.lastName} 
            (${client.clientId.username}) 
            - ${client.hasKey ? 'Has Key' : 'No Key'}
            ${client.clientId._id === clientId ? 
                `<button onclick="updateClientKeyStatus('${roomData._id}', '${client.clientId._id}')">Update Key Status</button>` 
                : ''}
        `;
        
        clientList.appendChild(clientItem);
    });
}

async function updateClientKeyStatus(roomId, clientId) {
    console.log(`Updating key status for client: ${clientId} in room: ${roomId}`);
    
    try {
        // Make a request to the server to update the client's key status
        const response = await fetch(`https://my-node-backend-fcdy.onrender.com/update-key-status`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                roomId,
                clientId
            })
        });

        const result = await response.json();
        if (response.ok) {
            console.log('Key status updated successfully');
            alert('Key status updated');
            // You may want to refresh or update the UI to reflect the new status
        } else {
            console.error('Failed to update key status:', result.message || 'Unknown error');
            alert('Failed to update key status');
        }
    } catch (error) {
        console.error('Error updating key status:', error);
        alert('Error updating key status');
    }
}



    </script>
<script>
  // Fetch hotel details and display ratings and room details
  let allRatings = []; // Store all ratings globally
let displayedRatings = 0; // Track how many ratings have been displayed

// Fetch hotel details and ratings
async function fetchHotelDetails() {
  const hotelId = window.env.HOTELID2; // Use this for fetching hotel details

  try {
    // Fetch hotel details from backend
    const response = await fetch(`https://my-node-backend-fcdy.onrender.com/get-hotel-details/${hotelId}`);
    const hotel = await response.json();

    if (response.ok) {
      // Display hotel information
      document.getElementById('hotel-name').textContent = hotel.hotelName;
      document.getElementById('hotel-location').textContent = hotel.location;
      document.getElementById('hotel-latitude').textContent = hotel.latitude;
      document.getElementById('hotel-contact').textContent = hotel.contactInfo;
      document.getElementById('hotel-capacity').textContent = hotel.capacity;
      document.getElementById('rooms-available').textContent = hotel.roomsAvailable;

      // Display hotel images (e.g., Restaurant, Meeting Room)
      displayHotelImages(hotel.images);
      
      // Fetch and display ratings
      await displayRatings(); // Pass the hotelId to displayRatings
    } else {
      console.error('Error fetching hotel details:', hotel.message);
    }
  } catch (error) {
    console.error('Error fetching hotel details:', error);
  }
}

// Function to display hotel ratings with pagination

async function displayRatings() {
  const ratingsContainer = document.getElementById('hotel-ratings');
  ratingsContainer.innerHTML = ''; // Clear previous ratings
  const hotelId = window.env.HOTELID1;  // Example hotelId
  
  try {
    // Fetch the ratings for the hotel
    const response = await fetch(`https://my-node-backend-fcdy.onrender.com/get-hotel-ratings/${hotelId}`);
    const data = await response.json();
console.log("Rating DATA: ", data)
    if (data.ratings && data.ratings.length > 0) {
      // Store all ratings globally
      allRatings = data.ratings;

      // Calculate and display the average rating
      calculateAndDisplayAverageRating(allRatings);

      // Display the first 5 ratings
      const ratingsToDisplay = allRatings.slice(displayedRatings, displayedRatings + 5);

      // Loop through and display the ratings
      ratingsToDisplay.forEach(rating => {
        const ratingElement = document.createElement('div');
        ratingElement.classList.add('rating');
        
        // Generate star rating HTML based on the rating value (1-5)
        let starsHTML = '';
        for (let i = 1; i <= 5; i++) {
          if (i <= rating.rating) {
            starsHTML += `<span class="star yellow">★</span>`; // Full star
          } else if (i === Math.floor(rating.rating) + 1 && rating.rating % 1 !== 0) {
            // Calculate the yellow percentage for the half star
            const yellowPercentage = (rating.rating % 1) * 100;
            starsHTML += `<span class="star yellow-half" style="--yellow-percentage: ${yellowPercentage}%;">★</span>`; // Half star
          } else {
            starsHTML += `<span class="star gray">★</span>`; // Gray star
          }
        }

        // Display only the username, stars, and comment initially
        ratingElement.innerHTML = `
          <p class="username-comment" data-id="${rating._id}">
            <strong>${rating.clientId ? rating.clientId.username : 'Unknown'}</strong>: 
            ${starsHTML} 
            ${rating.comment || 'No comment provided'}
          </p>
          <div class="rating-details" id="rating-details-${rating._id}" style="display: none;">
            <p><strong>Username:</strong> ${rating.clientId ? rating.clientId.username : 'Unknown'}</p>
            <p><strong>First Name:</strong> ${rating.clientId ? rating.clientId.firstName : ''}</p>
            <p><strong>Last Name:</strong> ${rating.clientId ? rating.clientId.lastName : ''}</p>
            <p><strong>Rating:</strong> ${rating.rating} / 5</p>
            <p><strong>Comment:</strong> ${rating.comment || 'No comment provided'}</p>
            <p><strong>Submitted on:</strong> ${new Date(rating.date).toLocaleDateString()}</p>
          </div>
        `;
        
        ratingsContainer.appendChild(ratingElement);

        // Add click event listener to toggle the rating details
        const usernameCommentElement = ratingElement.querySelector('.username-comment');
        usernameCommentElement.addEventListener('click', () => {
          const detailsElement = document.getElementById(`rating-details-${rating._id}`);
          detailsElement.style.display = detailsElement.style.display === 'none' ? 'block' : 'none';
        });
      });

      // Update the count of displayed ratings
      displayedRatings += ratingsToDisplay.length;

      // If there are more than 5 ratings, show the "Load More" button
      if (allRatings.length > 5) {
        const loadMoreButton = document.createElement('button');
        loadMoreButton.textContent = 'Load More Ratings';
        loadMoreButton.id = 'load-more-ratings';
        loadMoreButton.addEventListener('click', loadMoreRatings);

        ratingsContainer.appendChild(loadMoreButton);
      }
    } else {
      ratingsContainer.innerHTML = '<p>No ratings available for this hotel.</p>';
    }
  } catch (error) {
    console.error('Error fetching ratings:', error);
    ratingsContainer.innerHTML = '<p>Error fetching ratings.</p>';
  }
}


// Function to load 5 more ratings when the "Load More" button is clicked
function loadMoreRatings() {
  const ratingsContainer = document.getElementById('hotel-ratings');
  const loadMoreButton = document.getElementById('load-more-ratings');
  
  // Display the next 5 ratings
  const ratingsToDisplay = allRatings.slice(displayedRatings, displayedRatings + 5);

  // Loop through and display the new ratings
  ratingsToDisplay.forEach(rating => {
    const ratingElement = document.createElement('div');
    ratingElement.classList.add('rating');
    
    // Generate star rating HTML based on the rating value (1-5)
    let starsHTML = '';
    for (let i = 1; i <= 5; i++) {
      if (i <= rating.rating) {
        starsHTML += `<span class="star yellow">★</span>`; // Full star
      } else if (i === Math.floor(rating.rating) + 1 && rating.rating % 1 !== 0) {
        starsHTML += `<span class="star yellow-half">★</span>`; // Half star
      } else {
        starsHTML += `<span class="star gray">★</span>`; // Gray star
      }
    }

    // Display only the username, stars, and comment initially
    ratingElement.innerHTML = `
      <p class="username-comment" data-id="${rating._id}">
        <strong>${rating.clientId ? rating.clientId.username : 'Unknown'}</strong>: 
        ${starsHTML} 
        ${rating.comment || 'No comment provided'}
      </p>
      <div class="rating-details" id="rating-details-${rating._id}" style="display: none;">
        <p><strong>Username:</strong> ${rating.clientId ? rating.clientId.username : 'Unknown'}</p>
        <p><strong>First Name:</strong> ${rating.clientId ? rating.clientId.firstName : ''}</p>
        <p><strong>Last Name:</strong> ${rating.clientId ? rating.clientId.lastName : ''}</p>
        <p><strong>Rating:</strong> ${rating.rating} / 5</p>
        <p><strong>Comment:</strong> ${rating.comment || 'No comment provided'}</p>
        <p><strong>Submitted on:</strong> ${new Date(rating.date).toLocaleDateString()}</p>
      </div>
    `;
    
    ratingsContainer.appendChild(ratingElement);

    // Add click event listener to toggle the rating details
    const usernameCommentElement = ratingElement.querySelector('.username-comment');
    usernameCommentElement.addEventListener('click', () => {
      const detailsElement = document.getElementById(`rating-details-${rating._id}`);
      detailsElement.style.display = detailsElement.style.display === 'none' ? 'block' : 'none';
    });
  });

  // Update the count of displayed ratings
  displayedRatings += ratingsToDisplay.length;

  // If there are no more ratings to show, hide the "Load More" button
  if (displayedRatings >= allRatings.length) {
    loadMoreButton.style.display = 'none';
  }
}

// Function to calculate and display the average rating
function calculateAndDisplayAverageRating(ratings) {
  let totalRating = 0;

  // Sum the ratings
  ratings.forEach(rating => {
    totalRating += rating.rating;
  });

  // Calculate the average rating
  const averageRating = totalRating / ratings.length;

  // Format the average rating to one decimal place
  const formattedAverageRating = averageRating.toFixed(1); 

  // Display average rating stars
  let averageStarsHTML = '';
  for (let i = 1; i <= 5; i++) {
    if (i <= Math.floor(averageRating)) {
      averageStarsHTML += `<span class="star yellow">★</span>`; // Full star
    } else if (i === Math.floor(averageRating) + 1 && averageRating % 1 !== 0) {
      // Calculate the yellow percentage for the half star
      const yellowPercentage = (averageRating % 1) * 100;
      averageStarsHTML += `<span class="star yellow-half" style="--yellow-percentage: ${yellowPercentage}%;">★</span>`; // Half star
    } else {
      averageStarsHTML += `<span class="star gray">★</span>`; // Gray star
    }
  }

  const averageRatingHTML = `<div class="average-rating">${averageStarsHTML} (${formattedAverageRating}/5)</div>`;
  document.getElementById('hotel-ratings').insertAdjacentHTML('beforebegin', averageRatingHTML);  // Display it above the ratings
}




// Function to display hotel images
function displayHotelImages(images) {
  const hotelImagesContainer = document.getElementById('hotel-images');
  hotelImagesContainer.innerHTML = ''; // Clear any existing images

  if (images && images.length > 0) {
    images.forEach(image => {
      const imageElement = document.createElement('div');
      imageElement.innerHTML = `
        <p><strong>Category:</strong> ${image.category}</p>
        <img src="https://my-node-backend-fcdy.onrender.com/${image.url}" alt="${image.category}" width="200px" />
        <p><strong>Description:</strong> ${image.description}</p>
      `;
      hotelImagesContainer.appendChild(imageElement);
    });
  } else {
    hotelImagesContainer.innerHTML = '<p>No hotel images available.</p>';
  }
}
// Function to display hotel ratings and fetch client details


   // Funct// Function to fetch and display rooms for a specific client
async function fetchClientRooms() {
  const clientId = localStorage.getItem('clientId'); // Assuming clientId is stored in localStorage
  const hotelId = window.env.HOTELID1;  // Example hotelId

  try {
    // Fetch all rooms for the hotel
    const response = await fetch(`https://my-node-backend-fcdy.onrender.com/hotel/${hotelId}/rooms`);
    const rooms = await response.json();
    console.log('Fetched rooms:', rooms); // Add logging here to see the data structure

    if (response.ok) {
      // Filter rooms based on the client's presence in the room's clients array
      const clientRooms = rooms.filter(room => {
        return Array.isArray(room.clients) && room.clients.some(client => client.clientId === clientId);
      });

      console.log("Room details for this client: ", clientRooms); // Only client-specific rooms are logged
      // Display the filtered rooms
      displayClientRooms(clientRooms);
    } else {
      console.error('Error fetching rooms:', rooms.message);
    }
  } catch (error) {
    console.error('Error fetching rooms:', error);
  }
}


// Function to display the rooms that belong to the client
function displayClientRooms(rooms) {
  const roomsContainer = document.getElementById('room-detailsH');
  if (!roomsContainer) {
    console.error('Element with id "room-detailsH" not found!');
    return;
  }

  console.log('Displaying client rooms:', rooms); // Log rooms for debugging
  roomsContainer.innerHTML = ''; // Clear any previous room details

  if (rooms.length > 0) {
    rooms.forEach(room => {
      const roomElement = document.createElement('div');
      roomElement.classList.add('room');
      roomElement.innerHTML = `
        <p><strong>Room Type:</strong> ${room.roomType}</p>
        <p><strong>Room Number:</strong> ${room.roomNumber}</p>
        <p><strong>Bed Number:</strong> ${room.bedNumber}</p>
        <p><strong>Level:</strong> ${room.level}</p>
        <p><strong>Status:</strong> ${room.roomStatus}</p>
        <p><strong>Price:</strong> $${room.price}</p>
        
        <button class="room-images-btn" data-room-id="${room._id}">Room Images</button>
        <div class="room-detailsH" id="room-detailsH-${room._id}" style="display: none;">
          <ul class="room-images-list">
            ${room.images.map(image => `
              <li>
                <strong>Category:</strong> ${image.category} <br />
                <strong>Description:</strong> ${image.description} <br />
                <img src="https://my-node-backend-fcdy.onrender.com/${image.url}" alt="${image.category}" width="100px" />
              </li>
            `).join('')}
          </ul>
          
          <!-- More Images Button -->
          <button class="more-images-btn" data-room-type="${room.roomType}" >More Room Type Images</button>
          <div class="more-room-type-images" id="more-room-type-images-${room._id}" style="display: none;"></div>
        </div>
      `;
      roomsContainer.appendChild(roomElement);

      // Add functionality to toggle room images visibility
      const roomImagesBtn = roomElement.querySelector('.room-images-btn');
      const roomDetails = roomElement.querySelector('.room-detailsH');
      roomImagesBtn.addEventListener('click', () => {
        roomDetails.style.display = roomDetails.style.display === 'none' ? 'block' : 'none';
      });

      // Add functionality to toggle room type images visibility
      const moreImagesBtn = roomElement.querySelector('.more-images-btn');
      const moreRoomTypeImagesContainer = roomElement.querySelector('.more-room-type-images');
      moreImagesBtn.addEventListener('click', async () => {
        // Toggle the visibility of the container
        const isVisible = moreRoomTypeImagesContainer.style.display === 'block';
        moreRoomTypeImagesContainer.style.display = isVisible ? 'none' : 'block';
        
        // If the images haven't been loaded yet, fetch and display the room type images
        if (!isVisible && moreRoomTypeImagesContainer.innerHTML.trim() === '') {
          await displayRoomTypeImages(room.roomType, moreRoomTypeImagesContainer);
        }
      });
    });
  } else {
    roomsContainer.innerHTML = '<p>No rooms assigned to you.</p>';
  }
}

// Function to fetch and display room type images for the selected room type
async function displayRoomTypeImages(roomType, container) {
  try {
    const hotelId = window.env.HOTELID2;  // Example hotelId

    const response = await fetch(`https://my-node-backend-fcdy.onrender.com/get-hotel-details/${hotelId}`);
    
    if (!response.ok) {
      console.error('Failed to fetch hotel details:', response.statusText);
      return;
    }

    const hotelData = await response.json(); // Hotel data including roomsImages
    const roomTypeImages = hotelData.roomsImages.find(room => room.roomType === roomType); // Find matching room type

    if (roomTypeImages) {
      console.log('Room type images for', roomType, ':', roomTypeImages); // Log matching room type images
      
      // Clear any previous images
      container.innerHTML = '';

      // Display the room type images
      roomTypeImages.images.forEach(image => {
        const imageElement = document.createElement('div');
        imageElement.id = "room-type-container"
        imageElement.innerHTML = `
          <strong>Category:</strong> ${image.category} <br />
          <strong>Description:</strong> ${image.description} <br />
          <img src="https://my-node-backend-fcdy.onrender.com/${image.url}" alt="${image.category}" width="100px" />
        `;
        container.appendChild(imageElement);
      });

      // Show the container
      container.style.display = 'block';
    } else {
      container.innerHTML = '<p>No images found for this room type.</p>';
    }
  } catch (error) {
    console.error('Error fetching room type images:', error);
  }
}

  // Submit a new rating and feedback
  document.getElementById('submit-rating-btn').addEventListener('click', async (event) => {
  event.preventDefault(); // Prevent the default form submission

  // Get form data
  const rating = document.getElementById('rating').value;
  const comment = document.getElementById('comment').value;


  // Validate input
  if (!rating || rating < 1 || rating > 5) {
    alert('Please provide a rating between 1 and 5.');
    return;
  }
  const hotelId = window.env.HOTELID1;  // Example hotelId
  // Prepare the data to send to the server
  const ratingData = {
    hotelId: hotelId, // You should get the actual hotelId dynamically
    rating: rating,
    comment: comment,
    clientId: clientId,  // Pass the clientId
    username: username   // Pass the username
  };

  try {
    // Send the rating to the server via a POST request
    const response = await fetch(`https://my-node-backend-fcdy.onrender.com/rate-hotel/${hotelId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(ratingData)
    });

    const result = await response.json();

    if (response.ok) {
      alert('Rating submitted successfully!');
      // Optionally, clear the form or update the UI
    } else {
      alert('Failed to submit rating: ' + result.message);
    }
  } catch (error) {
    console.error('Error submitting rating:', error);
    alert('An error occurred while submitting the rating.');
  }
});

  document.addEventListener('DOMContentLoaded', function() {
      fetchClientRooms();
      fetchHotelDetails(); // Or any other function that relies on DOM elements
  });
  </script>
   <script>
   // Hajj map initialization
   let hajApiLocations = {}; // Will be populated with { title: { lat, lng } }
    let hajjMap;
    const hajjLocations = {
  'الإحرام': { lat: 21.3891, lng: 39.8579 },
  'الطواف': { lat: 21.4225, lng: 39.8262 },
  'السعي بين الصفا والمروة': { lat: 21.4229, lng: 39.8267 },
  'الإقامة في مكة': { lat: 21.4227, lng: 39.8263 },   // slight shift
  'الذهاب إلى منى': { lat: 21.4135, lng: 39.8934 },   // slight shift
  'يوم عرفة': { lat: 21.3549, lng: 39.9841 },
  'مزدلفة': { lat: 21.3833, lng: 39.9167 },
  'يوم النحر': { lat: 21.4137, lng: 39.8932 },        // slight shift
  'أيام التشريق': { lat: 21.4139, lng: 39.8931 },     // slight shift
  'طواف الوداع': { lat: 21.4226, lng: 39.8261 },      // slight shift
  'الخطوات النهائية': { lat: 21.4228, lng: 39.8264 }  // slight shift
};


    

// Initialize Hajj map
function initializeHajjMap() {
    if (hajjMap) return;

    // Initialize the map centered on Makkah
    hajjMap = L.map('hajj-map').setView([21.4225, 39.8262], 11);

    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(hajjMap);

    // Add markers
    masterHajSteps.forEach((step, index) => {
        const location = hajApiLocations[step.title] || hajjLocations[step.title];
        if (location) {
            let markerColor = '#6c757d';
            if (index < currentStepIndex) markerColor = '#28a745';
            else if (index === currentStepIndex) markerColor = '#ffc107';

            const marker = L.circleMarker([location.lat, location.lng], {
                radius: 8,
                fillColor: markerColor,
                color: '#fff',
                weight: 1,
                opacity: 1,
                fillOpacity: 0.8
            })
            .bindPopup(step.title)
            .addTo(hajjMap);

            if (index === currentStepIndex) marker.bringToFront();
        }
    });
}
// Update Hajj map markers
function updateHajjMapMarkers() {
    if (!hajjMap) return;

    // Remove old markers
    hajjMap.eachLayer((layer) => {
        if (layer instanceof L.CircleMarker) {
            hajjMap.removeLayer(layer);
        }
    });

    masterHajSteps.forEach((step, index) => {
        const location = hajApiLocations[step.title] || hajjLocations[step.title];
        if (!location) return;

        let markerColor;
        let className = '';

        if (index < currentStepIndex) {
            markerColor = '#0d6efd'; // Blue - completed
        } else if (index === currentStepIndex) {
            markerColor = '#0d6efd'; // Blue - current
            className = 'blinking';
        } else {
            markerColor = '#ffffff'; // White - upcoming
        }

        const marker = L.circleMarker([location.lat, location.lng], {
            radius: 8,
            fillColor: markerColor,
            color: '#0d6efd',
            weight: 1,
            opacity: 1,
            fillOpacity: 0.9,
            className: className
        })
        .bindPopup(step.title)
        .addTo(hajjMap);

        if (index === currentStepIndex) {
            marker.bringToFront();
            hajjMap.setView([location.lat, location.lng], 13); // Zoom level 13 can be adjusted
        }
    });
}
    // Initialize Hajj map when steps are loaded
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Hajj map after a short delay to ensure the container is ready
        setTimeout(() => {
            initializeHajjMap();
        }, 1000);
    });

    // Update Hajj map markers when steps change
const originalUpdateSteps = window.updateSteps;
    window.updateSteps = function() {
        if (originalUpdateSteps) {
            originalUpdateSteps.apply(this, arguments);
        }
        updateHajjMapMarkers();
    };
    
    // Master list of all haj steps with numbers and titles
    const masterHajSteps = [
        { number: 1, title: "الإحرام" },
        { number: 2, title: "الطواف" },
        { number: 3, title: "السعي بين الصفا والمروة" },
        { number: 4, title: "الإقامة في مكة" },
        { number: 5, title: "الذهاب إلى منى" },
        { number: 6, title: "يوم عرفة" },
        { number: 7, title: "مزدلفة" },
        { number: 8, title: "يوم النحر" },
        { number: 9, title: "أيام التشريق" },
        { number: 10, title: "طواف الوداع" },
        { number: 11, title: "الخطوات النهائية" }
    ];

    // Initialize hajSteps with master steps
    let hajSteps = masterHajSteps.map(step => ({
        ...step,
        completed: false
    }));

    let hajStartTime = null;
    let currentStepIndex = 0;
    let currentType = null;
let currentStep = 0;
let conditionsCompleted = false;
let selectedGender = null;
let ihramSubStep = 1;
let makkahSubStep = 1;
let saiiSubStep = 1;
let minaSubStep = 1;
let arafahSubStep = 1;
let muzdalifahSubStep = 1;
let nahrDaySubStep = 1;
let tashreeqSubStep = 1;
let countdownInterval = null; // Global interval variable
// Add event listener to fetch Haj steps on page load
document.addEventListener('DOMContentLoaded', async function () {
    selectedGender = localStorage.getItem('gender');

    if (selectedGender) {
        await fetchHajSteps(GROUP_ID);  // Fetch from backend
        initializeHajjMap();            // Initialize map after fetching
        updateSteps();
    } else {
        const genderSelectionDiv = document.getElementById('gender-selection');
        genderSelectionDiv.style.display = 'block';

        const genderRadios = document.querySelectorAll('input[name="gender"]');
        genderRadios.forEach(radio => {
            radio.addEventListener('change', async (e) => {
                const chosenGender = e.target.value;
                const confirmed = confirm(`هل أنت متأكد أنك تريد اختيار "${chosenGender === 'male' ? 'ذكر' : 'أنثى'}"؟ لا يمكن تغييره لاحقاً.`);

                if (confirmed) {
                    selectedGender = chosenGender;
                    localStorage.setItem('gender', selectedGender);

                    genderRadios.forEach(r => r.disabled = true);
                    genderSelectionDiv.style.display = 'none';

                    await fetchHajSteps(GROUP_ID);
                    initializeHajjMap();
                    updateSteps();
                } else {
                    e.target.checked = false;
                }
            });
        });
    }
});


// Functions to handle step elements
    function disableStepElements(stepIndex) {
        // Wait for the step items to be rendered
        setTimeout(() => {
            const stepItems = document.querySelectorAll('.step-item');
            
            if (stepItems.length > 0) {
                // Get the current step item
                const currentStepItem = stepItems[stepIndex];
                
                if (currentStepItem) {
                    // Find the content div within this step item
                    const contentDiv = currentStepItem.querySelector('.ihram-content, .makkah-content, .saii-content, .mina-content, .arafah-content, .muzdalifah-content, .nahr-day-content, .tashreeq-content');
                    
                    if (contentDiv) {
                        const buttons = contentDiv.querySelectorAll('button:not(.btn-info)');
                        buttons.forEach(button => {
                            button.disabled = true;
                            button.classList.add('disabled');
                        });
                    }
                }
            } else {
                disableStepElements(stepIndex); // Retry after a delay
            }
        }, 100); // Small delay to allow for rendering
    }

    function enableStepElements(stepIndex) {
        // Wait for the step items to be rendered
        setTimeout(() => {
            const stepItems = document.querySelectorAll('.step-item');
            
            if (stepItems.length > 0) {
                // Get the current step item
                const currentStepItem = stepItems[stepIndex];
                
                if (currentStepItem) {
                    // Find the content div within this step item
                    const contentDiv = currentStepItem.querySelector('.ihram-content, .makkah-content, .saii-content, .mina-content, .arafah-content, .muzdalifah-content, .nahr-day-content, .tashreeq-content');
                    
                    if (contentDiv) {
                        const buttons = contentDiv.querySelectorAll('button:not(.btn-info)');
                        buttons.forEach(button => {
                            button.disabled = false;
                            button.classList.remove('disabled');
                        });
                    }
                }
            } else {
                console.log("Step items not found, retrying...");
                enableStepElements(stepIndex); // Retry after a delay
            }
        }, 100); // Small delay to allow for rendering
    }

       // Function to update the steps UI based on hajSteps data
// Update the step elements UI
function updateStepsUI() {
    const stepsContainer = document.querySelector('.steps-timeline');
    stepsContainer.innerHTML = '';

    if (!hajSteps || hajSteps.length === 0) {
        stepsContainer.innerHTML = '<p>لا توجد خطوات حج متاحة حالياً.</p>';
        return;
    }

    hajSteps.forEach((step, index) => {
        const stepDiv = document.createElement('div');
        stepDiv.className = 'step-item d-flex align-items-center justify-content-between mb-2';

        const stepTitle = document.createElement('span');
        stepTitle.textContent = step.title;

        const stepCheckbox = document.createElement('input');
        stepCheckbox.type = 'checkbox';
        stepCheckbox.checked = step.completed || false;
        stepCheckbox.addEventListener('change', () => {
            hajSteps[index].completed = stepCheckbox.checked;
        });

        stepDiv.appendChild(stepTitle);
        stepDiv.appendChild(stepCheckbox);

        stepsContainer.appendChild(stepDiv);
    });
}
function updateCountdown() {
        const countdownElement = document.getElementById('countdown');
        if (!countdownElement) return;

        const now = new Date().getTime();
        const distance = hajStartTime.getTime() - now;

        if (distance < 0) {
            // Countdown finished
            clearInterval(countdownInterval);
            countdownElement.style.display = 'none';

const messageDiv = document.createElement('div');
messageDiv.className = 'alert alert-success';
messageDiv.id = 'alert alert-success'
messageDiv.textContent = '✅ يمكنك البدء الآن!';
countdownElement.parentElement.appendChild(messageDiv);
            logStepStructure(); // Log structure before enabling
            enableStepElements(currentStep);
            return;
        }

        const days = Math.floor(distance / (1000 * 60 * 60 * 24));
        const hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);

        // Update the countdown display with the same style
        document.getElementById('days').textContent = days.toString().padStart(2, '0');
        document.getElementById('hours').textContent = hours.toString().padStart(2, '0');
        document.getElementById('minutes').textContent = minutes.toString().padStart(2, '0');
        document.getElementById('seconds').textContent = seconds.toString().padStart(2, '0');
    }

// Add this function before startCountdown
function logStepStructure() {
    console.log("Current step:", currentStep);
    console.log("All content elements:");
    const allContentElements = document.querySelectorAll('[id^="content-"]');
    allContentElements.forEach(el => console.log(el.id));
}

// Add this function before startCountdown
function waitForSteps(callback) {
    const checkSteps = () => {
        const stepItems = document.querySelectorAll('.step-item');
        if (stepItems.length > 0) {
            callback();
        } else {
            setTimeout(checkSteps, 100);
        }
    };
    checkSteps();
}

function startCountdown(startTime) {
    // Clear any existing interval
    if (countdownInterval) {
        clearInterval(countdownInterval);
    }

    hajStartTime = new Date(startTime);
    const now = new Date();
    
    // Wait for steps to be rendered before proceeding
    waitForSteps(() => {
        if (hajStartTime > now) {
            disableStepElements(currentStep);
            
            // Start the countdown
            updateCountdown(); // Initial update
            countdownInterval = setInterval(updateCountdown, 1000);
        } else {
            enableStepElements(currentStep);
            const countdownElement = document.getElementById('countdown');
            if (countdownElement) {
                countdownElement.innerHTML = '<div class="alert alert-success" id="alert alert-success">يمكنك البدء الآن!</div>';
               
            }
        }
    });
}

// Fetch Haj Steps from the API
async function fetchHajSteps(groupId) {
    try {
        const response = await fetch(`https://my-node-backend-fcdy.onrender.com/group-haj-steps/${groupId}`);
        const data = await response.json();

        if (!data.success) {
            alert('فشل في تحميل خطوات الحج');
            return;
        }

        const fetchedSteps = data.hajSteps && data.hajSteps.length > 0
            ? data.hajSteps
            : masterHajSteps.map(step => ({ ...step, completed: false }));

        const localStorageKey = `hajSteps_${groupId}`;
        const storedSteps = JSON.parse(localStorage.getItem(localStorageKey)) || [];

        const storedMap = new Map(storedSteps.map(step => [step.title, step]));

        hajSteps = fetchedSteps.map(step => {
            const storedStep = storedMap.get(step.title);
            return storedStep
                ? { ...step, completed: storedStep.completed }
                : { ...step, completed: false };
        });

        const currentStepTitle = fetchedSteps[0]?.title || '';
        currentStepIndex = masterHajSteps.findIndex(step => step.title === currentStepTitle);
        console.log("✅ Current step index:", currentStepIndex, "Title:", currentStepTitle);

        localStorage.setItem(localStorageKey, JSON.stringify(hajSteps));

        hajStartTime = data.hajStartTime ? new Date(data.hajStartTime) : null;

        // Build lookup from API hajLocations
        if (Array.isArray(data.hajLocations)) {
            hajApiLocations = {};
            data.hajLocations.forEach(loc => {
                if (loc.title && typeof loc.lat === 'number' && typeof loc.lng === 'number') {
                    hajApiLocations[loc.title] = { lat: loc.lat, lng: loc.lng };
                }
            });
        }

        if (hajStartTime) {
            startCountdown(hajStartTime);
        }

        initializeHajjMap();
        updateSteps();

    } catch (error) {
        console.error('Error fetching haj steps:', error);
        alert('حدث خطأ أثناء تحميل خطوات الحج');
    }
}

// Function to update the current step UI
function updateCurrentStepUI() {
    const currentStepDiv = document.querySelector('.current-step-content');
    const current = hajSteps.find(step => !step.completed);

    if (current) {
        updateSteps();
        currentStepDiv.innerHTML = `<h5>${current.title}</h5>`;
    } else {
        currentStepDiv.innerHTML = `<p>تم إكمال جميع الخطوات 🎉</p>`;
    }
}

function completeStep(stepIndex) {
    hajSteps[stepIndex].completed = true;
    currentStep++; // Move to next step
    console.log('Step completed:', hajSteps[stepIndex]);
    updateSteps(); // Refresh the UI
}


// Function to display "Step complete" button
function showStepCompleteButton(stepIndex) {
    console.log(' إكمال هذه الخطوة');
    return `
        <button class="btn btn-success" onclick="completeStep(${stepIndex})">
            إكمال الإحرام
        </button>
    `;
}


async function updateSteps() {
    const container = document.getElementById('steps-container');
    container.innerHTML = ''; // Clear the container first

    if (!selectedGender) {
        container.innerHTML = '<div class="alert alert-warning">يرجى اختيار الجنس أولاً لعرض الخطوات.</div>';
        return;
    }

    const steps = hajSteps;

    steps.forEach((step, index) => {
        renderProgressMap(step.title);
        
        const stepElement = document.createElement('div');
        stepElement.className = 'step-item';

if (step.completed) {
    stepElement.classList.add('completed');
} else if (index === currentStep) {
    stepElement.classList.add('current');
}
        // Add success message if the step is completed
        if (step.completed === true) {
    console.log(`Step ${index + 1} is completed`);
    
    const doneMessage = document.createElement('div');
    const divSuccessContainer = document.getElementById('alert alert-success');
    if (divSuccessContainer) {
        divSuccessContainer.innerText = '✅ تم إكمال هذه الخطوة. الرجاء انتظار الخطوة التالية.';
    }

    doneMessage.className = 'alert alert-success mb-3';
    doneMessage.innerHTML = `
        <i class="bi bi-check-circle"></i> 
        <span>تم إكمال الخطوة: ${step.title}</span>
    `;
    stepElement.appendChild(doneMessage);

    document.querySelectorAll('.step-item.current').forEach(item => {
    item.classList.remove('current');
    item.classList.add('completed');
});

    const currentDot = document.querySelector('.step-dot.current');
    if (currentDot) {
        const stepItem = currentDot.closest('.step-line-item');
        if (stepItem) {
            const stepTitle = stepItem.querySelector('div:nth-child(2)');
            if (stepTitle && stepTitle.textContent.trim() === step.title.trim()) {
                currentDot.classList.remove('current');
                currentDot.classList.add('completed');
                
            }
        }
    }

    



    // ✅ Update localStorage
    const localStorageKey = `hajSteps_${groupId}`; // Use consistent key
    let storedSteps = JSON.parse(localStorage.getItem(localStorageKey)) || [];
    const storedIndex = storedSteps.findIndex(s => s.title === step.title);
    if (storedIndex !== -1) {
        storedSteps[storedIndex].completed = true;
        localStorage.setItem(localStorageKey, JSON.stringify(storedSteps));
        console.log(`LocalStorage updated: step "${step.title}" marked as completed.`);

        
    }
}

        // Add countdown display for current step if not completed
        if (index === currentStep && !step.completed) {
            const countdownElement = document.createElement('div');
            countdownElement.className = 'countdown-display mb-3';
            countdownElement.innerHTML = `
                <div class="alert alert-info">
                    <i class="bi bi-clock"></i> 
                    <span id="step-countdown-${index}">جاري التحميل...</span>
                </div>
            `;
            stepElement.appendChild(countdownElement);
        }

        // Add the rest of the step content (buttons, etc.)
        if (index === currentStep && !step.completed) {
            const completeButton = document.createElement('button');
            completeButton.className = 'btn btn-success';
            completeButton.textContent = 'إكمال هذه الخطوة';
            completeButton.onclick = () => completeStep(index);
            stepElement.appendChild(completeButton);
        }
        
        if (step.title === "الإحرام") {
            stepElement.innerHTML = `
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <span class="step-number">${index + 1}</span>
                        <h3 class="mb-0">${step.title}</h3>
                    </div>
                    <button class="btn btn-info" onclick="showIhramInfo()">
                        <i class="bi bi-info-circle"></i> معلومات
                    </button>
                </div>
                ${index === currentStep && step.completed !== true ? `
                    <div class="ihram-content mt-3" id="content-${index + 1}">
                        <div class="progress mb-4">
                            <div class="progress-bar" role="progressbar" style="width: ${(ihramSubStep / 3) * 100}%" 
                                 aria-valuenow="${(ihramSubStep / 3) * 100}" aria-valuemin="0" aria-valuemax="100">
                                ${Math.round((ihramSubStep / 3) * 100)}%
                            </div>
                        </div>

                        <div id="ihram-substep-1" class="ihram-substep ${ihramSubStep === 1 ? 'active' : ''}" style="display: ${ihramSubStep === 1 ? 'block' : 'none'}">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h4>النية عند الميقات</h4>
                                            <p class="mb-3">عند الوصول إلى الميقات:</p>
                                            <ul class="list-group mb-3">
                                                <li class="list-group-item">ينوي الدخول في الحج إذا كان في وقت الحج</li>
                                                <li class="list-group-item">ينوي العمرة إذا كان في وقت العمرة (مثل رمضان)</li>
                                                <li class="list-group-item">إذا أراد العمرة والحج في نفس العام، يبدأ بالعمرة</li>
                                            </ul>
                                            <div class="alert alert-info">
                                                <p class="mb-0">يقول بعد النية: "اللهم لبيك عمرة" أو "اللهم لبيك حجاً" حسب نيته</p>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <img src="img/miqat.jpg" alt="الميقات" class="img-fluid rounded mb-3" style="width: 100%; object-fit: cover;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="ihram-substep-2" class="ihram-substep ${ihramSubStep === 2 ? 'active' : ''}" style="display: ${ihramSubStep === 2 ? 'block' : 'none'}">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h4>ملابس الإحرام ${selectedGender === 'male' ? 'للرجل' : 'للمرأة'}</h4>
                                            ${selectedGender === 'male' ? `
                                                <ul class="list-group mb-3">
                                                    <p>إزار يحيط أسفل البدن</p>
                                                    <p>رداء يغطي أعلى البدن (يفضل أن يكون أبيض)</p>
                                                    <p>نعال مناسبة لا تغطي كامل القدم</p>
                                                </ul>
                                                <div class="alert alert-warning">
                                                    <p class="mb-0">يجب التجرد من المخيط (القميص) وكشف الرأس، والتجرد من السراويل والفانيلة وأشباه ذلك من المخيطات</p>
                                                </div>
                                            ` : `
                                                <ul class="list-group mb-3">
                                                    <p>ملابس فضفاضة تسترها</p>
                                                    <p>لا تغطي الوجه (إلا بحضرة أجانب)</p>
                                                    <p>لا تلبس القفازين</p>
                                                </ul>
                                            `}
                                        </div>
                                        <div class="col-md-4">
                                            <img src="img/${selectedGender}-ihram.jpg" alt="ملابس الإحرام ${selectedGender === 'male' ? 'للرجل' : 'للمرأة'}" class="img-fluid rounded mb-3" style="max-height: 200px; width: 100%; object-fit: contain;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="ihram-substep-3" class="ihram-substep ${ihramSubStep === 3 ? 'active' : ''}" style="display: ${ihramSubStep === 3 ? 'block' : 'none'}">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h4>التلبية</h4>
                                            <div class="alert alert-primary mb-3">
                                                <p class="talbiyah-text text-center mb-0">
                                                    لَبَّيْكَ اللَّهُمَّ لَبَّيْكَ، لَبَّيْكَ لَا شَرِيكَ لَكَ لَبَّيْكَ، إِنَّ الْحَمْدَ وَالنِّعْمَةَ لَكَ وَالْمُلْكَ، لَا شَرِيكَ لَكَ
                                                </p>
                                            </div>
                                            <p class="text-muted">يجب أن تكون النية والتلبية في الميقات قبل تجاوزه</p>
                                        </div>
                                        <div class="col-md-4">
                                            <img src="img/talbiya.jfif" alt="التلبية" class="img-fluid rounded mb-3" style="max-height: 200px; width: 100%; object-fit: contain;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            ${ihramSubStep > 1 ? `
                                <button class="btn btn-primary" onclick="previousIhramSubStep()">
                                    <i class="bi bi-arrow-right"></i> السابق
                                </button>
                            ` : '<div></div>'}
                            
                            ${ihramSubStep < 3 ? `
                                <button class="btn btn-success" onclick="nextIhramSubStep()">
                                    التالي <i class="bi bi-arrow-left"></i>
                                </button>
                            ` : `
                                <button class="btn btn-success" onclick="completeStep(${index})">
                                    إكمال الإحرام
                                </button>
                            `}
                        </div>
                    </div>
                ` : ''}
            `;
            setTimeout(() => {
        // Make sure you're targeting the images inside the right element
        applyZoomEffect(stepElement);
    }, 50); // Add a small delay to ensure DOM is ready
        
        } else if (step.title === "الطواف") {
    stepElement.innerHTML = `
        <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-center">
                <span class="step-number">${index + 2}</span>
                <h3 class="mb-0">${step.title}</h3>
            </div>
            <button class="btn btn-info" onclick="showMakkahInfo()">
                <i class="bi bi-info-circle"></i> معلومات
            </button>
        </div>
        ${index === currentStep && step.completed !== true ? `
            <div class="makkah-content mt-3" id="content-${index + 2}">
                <div class="progress mb-4">
                    <div class="progress-bar" role="progressbar" style="width: ${(makkahSubStep / 3) * 100}%" 
                         aria-valuenow="${(makkahSubStep / 3) * 100}" aria-valuemin="0" aria-valuemax="100">
                        ${Math.round((makkahSubStep / 3) * 100)}%
                    </div>
                </div>

                <div id="makkah-substep-1" class="makkah-substep ${makkahSubStep === 1 ? 'active' : ''}" style="display: ${makkahSubStep === 1 ? 'block' : 'none'}">
                    <div class="card bg-light mb-4">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <h4>قبل دخول الحرم</h4>
                                    <ul class="list-group mb-3">
                                        <li class="list-group-item">تخلص من الحقائب أو أودعها في صناديق الأمانات</li>
                                        <li class="list-group-item">استخدم البوابة الأقرب لك (حسب رقمها)</li>
                                        <li class="list-group-item">تأكد من طهارتك (وضوء)</li>
                                        <li class="list-group-item">ابدأ الطواف في حال أداء العمرة أو طواف قدوم</li>
                                    </ul>
                                </div>
                                <div class="col-md-4">
                                    <img src="img/makkah-entrance.jpg" alt="دخول الحرم" class="img-fluid rounded mb-3" style="max-height: 200px; width: 100%; object-fit: contain;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="makkah-substep-2" class="makkah-substep ${makkahSubStep === 2 ? 'active' : ''}" style="display: ${makkahSubStep === 2 ? 'block' : 'none'}">
                    <div class="card bg-light mb-4">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <h4>خطوات الطواف</h4>
                                    <ul class="list-group mb-3">
                                        <li class="list-group-item">قف بمحاذاة الحجر الأسود، وكبّر قائلاً: "الله أكبر"</li>
                                        <li class="list-group-item">ابدأ الشوط الأول واجعل الكعبة على يسارك</li>
                                        <li class="list-group-item">كرر التكبير عند بداية كل شوط جديد</li>
                                        <li class="list-group-item">في الركن اليماني (قبل الحجر الأسود) استحب مسحه إن تيسر</li>
                                        <li class="list-group-item">أَدْعُ الله في كل شوط بما تشاء</li>
                                    </ul>
                                    ${selectedGender === 'male' ? 
                                        `<div class="alert alert-info">
                                            <h5>ملاحظات خاصة للرجال:</h5>
                                            <ul class="mb-0">
                                                <li>الرمل: أسرع بالمشي في الثلاثة أشواط الأولى</li>
                                                <li>الاضطباع: اكشف الكتف الأيمن</li>
                                            </ul>
                                        </div>`
                                     : ''}
                                </div>
                                <div class="col-md-4">
                                    <img src="img/tawaf-steps.jpg" alt="خطوات الطواف" class="img-fluid rounded mb-3" style="max-height: 200px; width: 100%; object-fit: contain;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="makkah-substep-3" class="makkah-substep ${makkahSubStep === 3 ? 'active' : ''}" style="display: ${makkahSubStep === 3 ? 'block' : 'none'}">
                    <div class="card bg-light mb-4">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <h4>بعد الطواف</h4>
                                    <ul class="list-group mb-3">
                                        <li class="list-group-item">صلِّ ركعتين خلف مقام إبراهيم إن أمكن</li>
                                        <li class="list-group-item">اشرب من ماء زمزم</li>
                                        <li class="list-group-item">استعد للسعي (إن كنت تؤدي عمرة أو حجاً بنسك يستدعيه)</li>
                                    </ul>
                                </div>
                                <div class="col-md-4">
                                    <img src="img/after-tawaf.jpg" alt="بعد الطواف" class="img-fluid rounded mb-3" style="max-height: 200px; width: 100%; object-fit: contain;">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="d-flex justify-content-between mt-4">
                    ${makkahSubStep > 1 ? 
                        `<button class="btn btn-primary" onclick="previousMakkahSubStep()">
                            <i class="bi bi-arrow-right"></i> السابق
                        </button>`
                    : '<div></div>'}
                    
                    ${makkahSubStep < 3 ? 
                        `<button class="btn btn-success" onclick="nextMakkahSubStep()">
                            التالي <i class="bi bi-arrow-left"></i>
                        </button>`
                    : 
                        `<button class="btn btn-success" onclick="completeStep(${index})">
                            إكمال هذه الخطوة
                        </button>`
                    }
                </div>
            </div>
        ` : ''}
    `;
    setTimeout(() => {
        // Make sure you're targeting the images inside the right element
        applyZoomEffect(stepElement);
    }, 50); // Add a small delay to ensure DOM is ready
}
 else if (step.title === "السعي بين الصفا والمروة") {
            stepElement.innerHTML = `
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <span class="step-number">${index + 3}</span>
                        <h3 class="mb-0">${step.title}</h3>
                    </div>
                    <button class="btn btn-info" onclick="showSaiiInfo()">
                        <i class="bi bi-info-circle"></i> معلومات
                    </button>
                </div>
                ${index === currentStep && step.completed !== true ? `
                    <div class="saii-content mt-3" id="content-${index + 3}">
                        <div class="progress mb-4">
                            <div class="progress-bar" role="progressbar" style="width: ${(saiiSubStep / 3) * 100}%" 
                                 aria-valuenow="${(saiiSubStep / 3) * 100}" aria-valuemin="0" aria-valuemax="100">
                                ${Math.round((saiiSubStep / 3) * 100)}%
                            </div>
                        </div>

                        <div id="saii-substep-1" class="saii-substep ${saiiSubStep === 1 ? 'active' : ''}" style="display: ${saiiSubStep === 1 ? 'block' : 'none'}">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h4>قبل السعي</h4>
                                            <ul class="list-group mb-3">
                                                <li class="list-group-item">اتبع اللوحات الإرشادية إلى "الصفا"</li>
                                                <li class="list-group-item">يُفضل استخدام الدور العلوي إذا كان الدور الأرضي مزدحمًا</li>
                                                <li class="list-group-item">تأكد من طهارتك (وضوء)</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-4">
                                            <img src="img/bidayat-safa.jpg" alt="بداية السعي" class="img-fluid rounded mb-3" style="max-height: 200px; width: 100%; object-fit: contain;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="saii-substep-2" class="saii-substep ${saiiSubStep === 2 ? 'active' : ''}" style="display: ${saiiSubStep === 2 ? 'block' : 'none'}">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h4>خطوات السعي</h4>
                                            <ul class="list-group mb-3">
                                                <li class="list-group-item">قف على جبل الصفا، ووجّه وجهك للكعبة، وقل: "إن الصفا والمروة من شعائر الله..." ثم كبّر وادعُ الله</li>
                                                <li class="list-group-item">امشِ من الصفا إلى المروة = الشوط الأول</li>
                                                <li class="list-group-item">الرجال يهرولون بين العلمين الأخضرين فقط</li>
                                                <li class="list-group-item">عند الوصول إلى المروة، كرر الدعاء والتكبير، ثم ارجع</li>
                                                <li class="list-group-item">استمر حتى تكمل 7 أشواط</li>
                                            </ul>
                                            ${selectedGender === 'male' ? `
                                                <div class="alert alert-info">
                                                    <h5>ملاحظات خاصة للرجال:</h5>
                                                    <ul class="mb-0">
                                                        <li>الهرولة بين العلمين الأخضرين فقط</li>
                                                        <li>يُفضل استخدام الدور العلوي لتجنب الزحام</li>
                                                    </ul>
                                                </div>
                                            ` : ''}
                                        </div>
                                        <div class="col-md-4">
                                            <img src="img/safa-step.png" alt="خطوات السعي" class="img-fluid rounded mb-3" style="max-height: 200px; width: 100%; object-fit: contain;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="saii-substep-3" class="saii-substep ${saiiSubStep === 3 ? 'active' : ''}" style="display: ${saiiSubStep === 3 ? 'block' : 'none'}">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h4>الحلق والتقصير</h4>
                                            <ul class="list-group mb-3">
                                                <li class="list-group-item">في العمرة: اذهب للحلق أو التقصير مباشرة بعد السعي</li>
                                                <li class="list-group-item">في الحج: الحلق أو التقصير يكون بعد رمي جمرة العقبة</li>
                                                <li class="list-group-item">الرجل: يُفضل الحلق كاملاً، ويبدأ بالشق الأيمن</li>
                                                <li class="list-group-item">المرأة: تقصّ من أطراف شعرها قدر أنملة (1–2 سم)</li>
                                                <li class="list-group-item">يُشترط حلق أو تقصير جميع شعر الرأس، لا جزء منه</li>
                                                <li class="list-group-item">يُنصح بالحلق في محلات نظيفة مرخصة، باستخدام أدوات جديدة ومعقّمة</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-4">
                                            <img src="img/hair-cutting.jpg" alt="الحلق والتقصير" class="img-fluid rounded mb-3" style="max-height: 200px; width: 100%; object-fit: contain;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            ${saiiSubStep > 1 ? `
                                <button class="btn btn-primary" onclick="previousSaiiSubStep()">
                                    <i class="bi bi-arrow-right"></i> السابق
                                </button>
                            ` : '<div></div>'}
                            
                            ${saiiSubStep < 3 ? `
                                <button class="btn btn-success" onclick="nextSaiiSubStep()">
                                    التالي <i class="bi bi-arrow-left"></i>
                                </button>
                            ` : `
                                <button class="btn btn-success" onclick="completeStep(${index})">
                                    إكمال هذه الخطوة
                                </button>
                            `}
                        </div>
                    </div>
                ` : ''}
            `;

              // Delay the zoom effect application
    setTimeout(() => {
        applyZoomEffect(stepElement);  // Apply to the current step's images
    }, 50);
        } else if (step.title === "الذهاب إلى منى") {
            stepElement.innerHTML = `
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <span class="step-number">${index + 4}</span>
                        <h3 class="mb-0">${step.title}</h3>
                    </div>
                    <button class="btn btn-info" onclick="showMinaInfo()">
                        <i class="bi bi-info-circle"></i> معلومات
                    </button>
                </div>
                ${index === currentStep && step.completed !== true ? `
                    <div class="mina-content mt-3" id="content-${index + 4}">
                        <div class="progress mb-4">
                            <div class="progress-bar" role="progressbar" style="width: ${(minaSubStep / 3) * 100}%" 
                                 aria-valuenow="${(minaSubStep / 3) * 100}" aria-valuemin="0" aria-valuemax="100">
                                ${Math.round((minaSubStep / 3) * 100)}%
                            </div>
                        </div>

                        <div id="mina-substep-1" class="mina-substep ${minaSubStep === 1 ? 'active' : ''}" style="display: 'block'}">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h4>عند الوصول إلى منى</h4>
                                            <ul class="list-group mb-3">
                                                <li class="list-group-item">تأكد من إنزال جميع أمتعتك من الحافلة</li>
                                                <li class="list-group-item">تعرّف على رقم مخيمك وشارعه وأقرب المعالم</li>
                                                <li class="list-group-item">التقط صورة للموقع، وسجّله على تطبيق خرائط بجوالك</li>
                                                <li class="list-group-item">تعرّف على مشرف الحملة</li>
                                                <li class="list-group-item">لا تخرج من المخيم إلا للضرورة، واستأذن المشرف أولاً</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-4">
                                            <img src="img/mina-arrival.jpg" alt="الوصول إلى منى" class="img-fluid rounded mb-3" style="max-height: 200px; width: 100%; object-fit: contain;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="mina-substep-2" class="mina-substep ${minaSubStep === 2 ? 'active' : ''}" style="display: ${minaSubStep === 2 ? 'block' : 'none'}">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h4>قطار المشاعر</h4>
                                            <ul class="list-group mb-3">
                                                <li class="list-group-item">اسأل مشرف الحملة عن رقم المحطة قبل مغادرة المخيم</li>
                                                <li class="list-group-item">لا تصعد القطار إذا كان ممتلئًا</li>
                                                <li class="list-group-item">حافظ على سوار القطار ولا تفقده</li>
                                                <li class="list-group-item">استخدم المصاعد إذا كنت من كبار السن أو أصحاب الإعاقة</li>
                                                <li class="list-group-item">بعد النزول، امشِ حتى تصل إلى الجمرات</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-4">
                                            <img src="img/mina-train.jpg" alt="قطار المشاعر" class="img-fluid rounded mb-3" style="max-height: 200px; width: 100%; object-fit: contain;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="mina-substep-3" class="mina-substep ${minaSubStep === 3 ? 'active' : ''}" style="display: ${minaSubStep === 3 ? 'block' : 'none'}">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h4>أداء المناسك</h4>
                                            <ul class="list-group mb-3">
                                                <li class="list-group-item">لا تنم داخل مسجد الخيف</li>
                                                <li class="list-group-item">اتبع تعليمات رجال الأمن لتجنب الزحام والضرر</li>
                                                <li class="list-group-item">استفد من المرافق بعد جمرة العقبة (مطاعم، حلاقة، دورات مياه)</li>
                                                <li class="list-group-item">احرص على أداء الصلوات في وقتها</li>
                                                <li class="list-group-item">استعد للذهاب إلى عرفة في اليوم التالي</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-4">
                                            <img src="img/mina-rituals.jpg" alt="أداء المناسك" class="img-fluid rounded mb-3" style="max-height: 200px; width: 100%; object-fit: contain;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            ${minaSubStep > 1 ? `
                                <button class="btn btn-primary" onclick="previousMinaSubStep()">
                                    <i class="bi bi-arrow-right"></i> السابق
                                </button>
                            ` : '<div></div>'}
                            
                            ${minaSubStep < 3 ? `
                                <button class="btn btn-success" onclick="nextMinaSubStep()">
                                    التالي <i class="bi bi-arrow-left"></i>
                                </button>
                            ` : `
                                <button class="btn btn-success" onclick="completeStep(${index})">
                                    إكمال هذه الخطوة
                                </button>
                            `}
                        </div>
                    </div>
                ` : ''}
            `;
       
            setTimeout(() => {
        applyZoomEffect(stepElement);
    }, 50);

        } else if (step.title === "يوم عرفة") {
            stepElement.innerHTML = `
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <span class="step-number">${index + 5}</span>
                        <h3 class="mb-0">${step.title}</h3>
                    </div>
                    <button class="btn btn-info" onclick="showArafahInfo()">
                        <i class="bi bi-info-circle"></i> معلومات
                    </button>
                </div>
                ${index === currentStep && step.completed !== true ? `
                    <div class="arafah-content mt-3" id="content-${index + 5}">
                        <div class="progress mb-4">
                            <div class="progress-bar" role="progressbar" style="width: ${(arafahSubStep / 6) * 100}%" 
                                 aria-valuenow="${(arafahSubStep / 6) * 100}" aria-valuemin="0" aria-valuemax="100">
                                ${Math.round((arafahSubStep / 6) * 100)}%
                            </div>
                        </div>

                        <div id="arafah-substep-1" class="arafah-substep ${arafahSubStep === 1 ? 'active' : ''}" style="display: ${arafahSubStep === 1 ? 'block' : 'none'}">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h4>في مخيمك بعرفة</h4>
                                            <ul class="list-group mb-3">
                                                <li class="list-group-item">صلِّ الظهر والعصر جمعاً وقصراً بعد الزوال</li>
                                                <li class="list-group-item">لا تغادر المخيم إلا لضرورة، فالطرق متشابهة، وقد تضيع</li>
                                                <li class="list-group-item">
                                                    استغل كل لحظة في العبادة:
                                                    <ul>
                                                        <li>الدعاء</li>
                                                        <li>التلبية</li>
                                                        <li>القرآن</li>
                                                        <li>الذكر</li>
                                                    </ul>
                                                </li>
                                                <li class="list-group-item">نوع بين هذه العبادات لتجنب الملل</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-4">
                                            <img src="img/arafah-camp.jpg" alt="مخيم عرفة" class="img-fluid rounded mb-3" style="max-height: 200px; width: 100%; object-fit: contain;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="arafah-substep-2" class="arafah-substep ${arafahSubStep === 2 ? 'active' : ''}" style="display: ${arafahSubStep === 2 ? 'block' : 'none'}">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h4>ما لا يُستحب</h4>
                                            <div class="alert alert-warning">
                                                <ul class="mb-0">
                                                    <li>لا تصعد جبل الرحمة؛ لأنه ليس من السنن، وفيه مشقة</li>
                                                    <li>لا تفتعل الزحام عند الشاخص أو عند المخارج</li>
                                                </ul>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <img src="img/arafah-warnings.webp" alt="تحذيرات عرفة" class="img-fluid rounded mb-3" style="max-height: 200px; width: 100%; object-fit: contain;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="arafah-substep-3" class="arafah-substep ${arafahSubStep === 3 ? 'active' : ''}" style="display: ${arafahSubStep === 3 ? 'block' : 'none'}">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h4>تعليمات الوقوف</h4>
                                            <ul class="list-group mb-3">
                                                <li class="list-group-item">الوقوف بعرفة يبدأ من الزوال حتى غروب الشمس</li>
                                                <li class="list-group-item">لا تغادر عرفة قبل غروب الشمس إلا بإذن المطوف أو الجهات المنظمة</li>
                                                <li class="list-group-item">إن وصلت لعرفة قبل الزوال، فاقض وقتك في الدعاء والذكر</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-4">
                                            <img src="img/arafah-standing.jpg" alt="الوقوف بعرفة" class="img-fluid rounded mb-3" style="max-height: 200px; width: 100%; object-fit: contain;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="arafah-substep-4" class="arafah-substep ${arafahSubStep === 4 ? 'active' : ''}" style="display: ${arafahSubStep === 4 ? 'block' : 'none'}">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h4>الدعاء في عرفة</h4>
                                            <div class="alert alert-info">
                                                <p class="mb-2">أفضل الدعاء دعاء عرفة</p>
                                                <ul class="mb-0">
                                                    <li>اجمع بين أدعية القرآن والسنة، وأدعية من قلبك</li>
                                                    <li>ادعُ بصدق، وتوجّه إلى الله بخشوع</li>
                                                    <li>فهو يوم القرب والمغفرة</li>
                                                </ul>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <img src="img/arafah-prayer.jpg" alt="الدعاء في عرفة" class="img-fluid rounded mb-3" style="max-height: 200px; width: 100%; object-fit: contain;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="arafah-substep-5" class="arafah-substep ${arafahSubStep === 5 ? 'active' : ''}" style="display: ${arafahSubStep === 5 ? 'block' : 'none'}">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h4>تعليمات قطار المشاعر</h4>
                                            <ul class="list-group mb-3">
                                                <li class="list-group-item">اتبع تعليمات مسؤولي القطار بدقة</li>
                                                <li class="list-group-item">استخدم المصاعد إذا كنت من كبار السن أو من أصحاب الإعاقة</li>
                                                <li class="list-group-item">لا تصعد القطار إن كانت العربة ممتلئة</li>
                                                <li class="list-group-item">حافظ على سوار القطار فهو تذكرتك الوحيدة للركوب</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-4">
                                            <img src="img/arafah-train.png" alt="قطار المشاعر" class="img-fluid rounded mb-3" style="max-height: 200px; width: 100%; object-fit: contain;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="arafah-substep-6" class="arafah-substep ${arafahSubStep === 6 ? 'active' : ''}" style="display: ${arafahSubStep === 6 ? 'block' : 'none'}">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h4>تعليمات التفويج إلى مزدلفة</h4>
                                            <ul class="list-group mb-3">
                                                <li class="list-group-item">التزم بموعد التفويج الذي تحدده الحملة</li>
                                                <li class="list-group-item">ادخل دورة المياه قبل المغادرة؛ فقد تتأخر في الطريق</li>
                                                <li class="list-group-item">لا تستعجل ولا تندفع، وتمسك بالسكينة</li>
                                                <li class="list-group-item">تذكّر قول النبي ﷺ: "السكينة السكينة، فإن البر ليس بالإيضاع"</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-4">
                                            <img src="img/arafah-muzdalifah.jpg" alt="التفويج إلى مزدلفة" class="img-fluid rounded mb-3" style="max-height: 200px; width: 100%; object-fit: contain;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            ${arafahSubStep > 1 ? `
                                <button class="btn btn-primary" onclick="previousArafahSubStep()">
                                    <i class="bi bi-arrow-right"></i> السابق
                                </button>
                            ` : '<div></div>'}
                            
                            ${arafahSubStep < 6 ? `
                                <button class="btn btn-success" onclick="nextArafahSubStep()">
                                    التالي <i class="bi bi-arrow-left"></i>
                                </button>
                            ` : `
                                <button class="btn btn-success" onclick="completeStep(${index})">
                                    إكمال هذه الخطوة
                                </button>
                            `}
                        </div>
                    </div>
                ` : ''}
            `;
        } else if (step.title === "مزدلفة") {
            stepElement.innerHTML = `
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <span class="step-number">${index + 6}</span>
                        <h3 class="mb-0">${step.title}</h3>
                    </div>
                    <button class="btn btn-info" onclick="showMuzdalifahInfo()">
                        <i class="bi bi-info-circle"></i> معلومات
                    </button>
                </div>
                ${index === currentStep && step.completed !== true ? `
                    <div class="muzdalifah-content mt-3" id="content-${index + 6}t">
                        <div class="progress mb-4">
                            <div class="progress-bar" role="progressbar" style="width: ${(muzdalifahSubStep / 4) * 100}%" 
                                 aria-valuenow="${(muzdalifahSubStep / 4) * 100}" aria-valuemin="0" aria-valuemax="100">
                                ${Math.round((muzdalifahSubStep / 4) * 100)}%
                            </div>
                        </div>

                        <div id="muzdalifah-substep-1" class="muzdalifah-substep ${muzdalifahSubStep === 1 ? 'active' : ''}" style="display: ${muzdalifahSubStep === 1 ? 'block' : 'none'}">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <h4>الوصول إلى مزدلفة</h4>
                                    <div class="alert alert-primary">
                                        <h5>عند الوصول:</h5>
                                        <ul class="mb-0">
                                            <li>صَلِّ المغرب والعشاء مع الحملة (جمعًا وقصرًا)</li>
                                            <li>نم واسترح استعدادًا ليوم العيد</li>
                                            <li>اذكر الله وادعُ في وقتك بهدوء</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="muzdalifah-substep-2" class="muzdalifah-substep ${muzdalifahSubStep === 2 ? 'active' : ''}" style="display: ${muzdalifahSubStep === 2 ? 'block' : 'none'}">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <h4>جمع الحصى</h4>
                                    <div class="alert alert-info">
                                        <h5>كيف تجمع الحصى:</h5>
                                        <ul class="mb-0">
                                            <li>اجمع 7 حصيات صغيرة من الأرض</li>
                                            <li>احرص أن تكون الحصى صغيرة، بحجم حبة الحمص تقريبًا</li>
                                            <li>لا حاجة لغسلها أو اختيار شكل موحّد لها</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="muzdalifah-substep-3" class="muzdalifah-substep ${muzdalifahSubStep === 3 ? 'active' : ''}" style="display: ${muzdalifahSubStep === 3 ? 'block' : 'none'}">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <h4>الاستعداد للمغادرة</h4>
                                    <div class="alert alert-warning">
                                        <h5>قبل المغادرة:</h5>
                                        <ul class="mb-0">
                                            <li>تأكد من جمع الحصى المطلوبة</li>
                                            <li>استعد للنوم مبكرًا للراحة</li>
                                            <li>احتفظ بماء كافٍ للشرب</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="muzdalifah-substep-4" class="muzdalifah-substep ${muzdalifahSubStep === 4 ? 'active' : ''}" style="display: ${muzdalifahSubStep === 4 ? 'block' : 'none'}">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <h4>مغادرة مزدلفة</h4>
                                    <div class="alert alert-success" id= "alert alert-success">
                                        <h5>تعليمات المغادرة:</h5>
                                        <ul class="mb-0">
                                            <li>التزم بتعليمات الحملة حول وقت التحرك إلى منى</li>
                                            <li>غادر بعد منتصف الليل أو بعد الفجر حسب جدول الحملة</li>
                                            <li>احمل معك مظلة مريحة وحذاء جيد إن كنت تمشي</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            ${muzdalifahSubStep > 1 ? `
                                <button class="btn btn-primary" onclick="previousMuzdalifahSubStep()">
                                    <i class="bi bi-arrow-right"></i> السابق
                                </button>
                            ` : '<div></div>'}
                            
                            ${muzdalifahSubStep < 4 ? `
                                <button class="btn btn-success" onclick="nextMuzdalifahSubStep()">
                                    التالي <i class="bi bi-arrow-left"></i>
                                </button>
                            ` : `
                                <button class="btn btn-success" onclick="completeStep(${index})">
                                    إكمال هذه الخطوة
                                </button>
                            `}
                        </div>
                    </div>
                ` : ''}
            `;
        } else if (step.title === "يوم النحر") {
            stepElement.innerHTML = `
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <span class="step-number">${index + 7}</span>
                        <h3 class="mb-0">${step.title}</h3>
                    </div>
                    <button class="btn btn-info" onclick="showNahrDayInfo()">
                        <i class="bi bi-info-circle"></i> معلومات
                    </button>
                </div>
                ${index === currentStep && step.completed !== true ? `
                    <div class="nahr-day-content mt-3" id="content-${index + 7}">
                        <div class="progress mb-4">
                            <div class="progress-bar" role="progressbar" style="width: ${(nahrDaySubStep / 6) * 100}%" 
                                 aria-valuenow="${(nahrDaySubStep / 6) * 100}" aria-valuemin="0" aria-valuemax="100">
                                ${Math.round((nahrDaySubStep / 6) * 100)}%
                            </div>
                        </div>

                        <div id="nahr-day-substep-1" class="nahr-day-substep ${nahrDaySubStep === 1 ? 'active' : ''}" style="display: ${nahrDaySubStep === 1 ? 'block' : 'none'}">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <h4>رمي جمرة العقبة</h4>
                                    <div class="alert alert-primary">
                                        <h5>تعليمات الرمي:</h5>
                                        <ul class="mb-0">
                                            <li>اذهب مع مجموعتك حسب الوقت المحدد</li>
                                            <li>ارمي 7 حصيات متفرقات، واحدة تلو الأخرى</li>
                                            <li>كبّر مع كل رمية: "الله أكبر"</li>
                                            <li>احرص أن تقع الحصاة في حوض الجمرة</li>
                                            <li>لا تتوقف بعد الرمي، وابتعد عن الزحام</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="nahr-day-substep-2" class="nahr-day-substep ${nahrDaySubStep === 2 ? 'active' : ''}" style="display: ${nahrDaySubStep === 2 ? 'block' : 'none'}">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <h4>ذبح الهدي</h4>
                                    <div class="alert alert-info">
                                        <h5>تعليمات الهدي:</h5>
                                        <ul class="mb-0">
                                            <li>إن وكلت جهة رسمية (مثل مشروع أضاحي)، فبمجرد خصم المبلغ أو وصول القسيمة، تم التوكيل</li>
                                            <li>لا يجب عليك الانتظار لتأكيد الذبح</li>
                                            <li>يمكن التوكيل عبر: adahi.org أو haj.gov.sa أو ehsan.sa</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="nahr-day-substep-3" class="nahr-day-substep ${nahrDaySubStep === 3 ? 'active' : ''}" style="display: ${nahrDaySubStep === 3 ? 'block' : 'none'}">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <h4>الحلق أو التقصير</h4>
                                    <div class="alert alert-warning">
                                        <h5>تعليمات الحلق:</h5>
                                        <ul class="mb-0">
                                            <li>اذهب إلى الحلاقين المرخصين فقط</li>
                                            <li>تأكد من نظافة الأدوات (استخدام موس جديد)</li>
                                            <li>الحلق أفضل للرجال، أما النساء فالتقصير (بقدر أنملة)</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="nahr-day-substep-4" class="nahr-day-substep ${nahrDaySubStep === 4 ? 'active' : ''}" style="display: ${nahrDaySubStep === 4 ? 'block' : 'none'}">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <h4>التحلل الأول</h4>
                                    <div class="alert alert-success" id="alert alert-success">
                                        <h5>بعد الرمي + الذبح + الحلق أو التقصير:</h5>
                                        <ul class="mb-0">
                                            <li>يمكنك الآن لبس الثياب</li>
                                            <li>استخدام العطر</li>
                                            <li>تقليم الأظافر</li>
                                            <li>يبقى الجماع فقط محظورًا حتى طواف الإفاضة</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="nahr-day-substep-5" class="nahr-day-substep ${nahrDaySubStep === 5 ? 'active' : ''}" style="display: ${nahrDaySubStep === 5 ? 'block' : 'none'}">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <h4>طواف الإفاضة</h4>
                                    <div class="alert alert-primary">
                                        <h5>تعليمات الطواف:</h5>
                                        <ul class="mb-0">
                                            <li>ركن من أركان الحج، لا يصح الحج بدونه</li>
                                            <li>يمكن أداؤه بعد التحلل، أو تأخيره وجمعه مع طواف الوداع لاحقًا</li>
                                            <li>تطوف 7 أشواط حول الكعبة</li>
                                            <li>يمكن الطواف بملابسك العادية بعد التحلل</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="nahr-day-substep-6" class="nahr-day-substep ${nahrDaySubStep === 6 ? 'active' : ''}" style="display: ${nahrDaySubStep === 6 ? 'block' : 'none'}">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <h4>سعي الحج</h4>
                                    <div class="alert alert-info">
                                        <h5>تعليمات السعي:</h5>
                                        <ul class="mb-0">
                                            <li>إن لم تكن سعيت بعد طواف القدوم، تسعى الآن بين الصفا والمروة</li>
                                            <li>7 أشواط تبدأ من الصفا وتنتهي بالمروة</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            ${nahrDaySubStep > 1 ? `
                                <button class="btn btn-primary" onclick="previousNahrDaySubStep()">
                                    <i class="bi bi-arrow-right"></i> السابق
                                </button>
                            ` : '<div></div>'}
                            
                            ${nahrDaySubStep < 6 ? `
                                <button class="btn btn-success" onclick="nextNahrDaySubStep()">
                                    التالي <i class="bi bi-arrow-left"></i>
                                </button>
                            ` : `
                                <button class="btn btn-success" onclick="completeStep(${index})">
                                    إكمال هذه الخطوة
                                </button>
                            `}
                        </div>
                    </div>
                ` : ''}
            `;
        } else if (step.title === "أيام التشريق") {
            stepElement.innerHTML = `
                <div class="d-flex align-items-center justify-content-between">
                    <div class="d-flex align-items-center">
                        <span class="step-number">${index + 8}</span>
                        <h3 class="mb-0">${step.title}</h3>
                    </div>
                    <button class="btn btn-info" onclick="showTashreeqInfo()">
                        <i class="bi bi-info-circle"></i> معلومات
                    </button>
                </div>
                ${index === currentStep && step.completed !== true ? `
                    <div class="tashreeq-content mt-3" id="content-${index + 8}">
                        <div class="progress mb-4">
                            <div class="progress-bar" role="progressbar" style="width: ${(tashreeqSubStep / 5) * 100}%" 
                                 aria-valuenow="${(tashreeqSubStep / 5) * 100}" aria-valuemin="0" aria-valuemax="100">
                                ${Math.round((tashreeqSubStep / 5) * 100)}%
                            </div>
                        </div>

                        <div id="tashreeq-substep-1" class="tashreeq-substep ${tashreeqSubStep === 1 ? 'active' : ''}" style="display: ${tashreeqSubStep === 1 ? 'block' : 'none'}">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <h4>قبل الظهر</h4>
                                    <div class="alert alert-primary">
                                        <h5>الاستعداد للرمي:</h5>
                                        <ul class="mb-0">
                                            <li>المكوث في منى</li>
                                            <li>الاستعداد للرمي مع الحملة</li>
                                            <li>تجهيز الحصى المطلوبة</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="tashreeq-substep-2" class="tashreeq-substep ${tashreeqSubStep === 2 ? 'active' : ''}" style="display: ${tashreeqSubStep === 2 ? 'block' : 'none'}">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <h4>رمي الجمرات</h4>
                                    <div class="alert alert-info">
                                        <h5>ترتيب الرمي:</h5>
                                        <ul class="mb-0">
                                            <li>الجمرة الصغرى: 7 حصيات، ثم الوقوف للدعاء</li>
                                            <li>الجمرة الوسطى: 7 حصيات، ثم الوقوف للدعاء</li>
                                            <li>جمرة العقبة: 7 حصيات، ولا وقوف بعدها</li>
                                            <li>التكبير مع كل رمية: "الله أكبر"</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="tashreeq-substep-3" class="tashreeq-substep ${tashreeqSubStep === 3 ? 'active' : ''}" style="display: ${tashreeqSubStep === 3 ? 'block' : 'none'}">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <h4>بعد الرمي</h4>
                                    <div class="alert alert-success">
                                        <h5>أعمال اليوم:</h5>
                                        <ul class="mb-0">
                                            <li>الذكر والتكبير في كل وقت</li>
                                            <li>التوسّع في الأكل والشرب (سنة)</li>
                                            <li>البقاء في منى (البيتوتة واجبة للحاج القادر)</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="tashreeq-substep-4" class="tashreeq-substep ${tashreeqSubStep === 4 ? 'active' : ''}" style="display: ${tashreeqSubStep === 4 ? 'block' : 'none'}">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <h4>التعجل أو التأخر</h4>
                                    <div class="alert alert-warning">
                                        <h5>إن كنت من المتعجلين (اليوم 12):</h5>
                                        <ul class="mb-0">
                                            <li>ارْمِ الجمرات بعد الزوال</li>
                                            <li>اخرج من منى قبل المغرب</li>
                                            <li>اذهب إلى مكة وأدِّ طواف الوداع</li>
                                        </ul>
                                    </div>
                                    <div class="alert alert-info mt-3">
                                        <h5>إن كنت من المتأخرين (اليوم 13):</h5>
                                        <ul class="mb-0">
                                            <li>ابقَ في منى ليلة 12</li>
                                            <li>ارْمِ الجمرات بعد الزوال</li>
                                            <li>غادر إلى مكة وأدِّ طواف الوداع</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="tashreeq-substep-5" class="tashreeq-substep ${tashreeqSubStep === 5 ? 'active' : ''}" style="display: ${tashreeqSubStep === 5 ? 'block' : 'none'}">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <h4>ملاحظات هامة</h4>
                                    <div class="alert alert-danger">
                                        <h5>استثناءات وتنبيهات:</h5>
                                        <ul class="mb-0">
                                            <li>الحائض أو النفساء: لا طواف وداع عليها</li>
                                            <li>إن طهرت قبل مغادرة مكة، يجب عليها الطواف</li>
                                            <li>لا تُرمى جمرات يوم 13 مسبقًا</li>
                                            <li>يمكن شراء زمزم في المطارات (عبوة 5 لترات)</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            ${tashreeqSubStep > 1 ? `
                                <button class="btn btn-primary" onclick="previousTashreeqSubStep()">
                                    <i class="bi bi-arrow-right"></i> السابق
                                </button>
                            ` : '<div></div>'}
                            
                            ${tashreeqSubStep < 5 ? `
                                <button class="btn btn-success" onclick="nextTashreeqSubStep()">
                                    التالي <i class="bi bi-arrow-left"></i>
                                </button>
                            ` : `
                                <button class="btn btn-success" onclick="completeStep(${index})">
                                    إكمال هذه الخطوة
                                </button>
                            `}
                        </div>
                    </div>
                ` : ''}
            `;
        } else {
            // Regular step content
            stepElement.innerHTML = `
                <div class="d-flex align-items-center">
                    <span class="step-number">${index + 1}</span>
                    <h3 class="mb-0">${step.title}</h3>
                </div>
                ${index === currentStep && step.completed !== true ? `
                    <div class="row mt-3">
                        <div class="col-md-8">
                            <p>${step.description}</p>
                        </div>
                        <div class="col-md-4">
                            <img src="img/${step.title.toLowerCase().replace(/\s+/g, '-')}.jpg" 
                                 alt="${step.title}" 
                                 class="img-fluid rounded mb-3" 
                                 style="max-height: 200px; width: 100%; object-fit: contain;">
                        </div>
                    </div>
                    <button class="btn btn-success" onclick="completeStep(${index})">
                        إكمال هذه الخطوة
                    </button>
                ` : ''}
            `;
        }
        
        container.appendChild(stepElement);
    });

   
}

function previousStep() {
    const carousel = document.getElementById('stepsCarousel');
    const bsCarousel = new bootstrap.Carousel(carousel);
    bsCarousel.prev();
}

function nextStep() {
    const carousel = document.getElementById('stepsCarousel');
    const bsCarousel = new bootstrap.Carousel(carousel);
    bsCarousel.next();
}

function completeSubStep(stepIndex) {
    const step = hajjSteps[currentType][stepIndex];
    const currentSubStep = step.subSteps[step.currentSubStep];
    
    currentSubStep.completed = true;
    
    if (step.currentSubStep < step.subSteps.length - 1) {
        step.currentSubStep++;
    } else {
        step.completed = true;
        currentStep++;
    }
    
    updateSteps();
}

function completeStep(stepIndex) {
    if (stepIndex === currentStep) {
        hajSteps[stepIndex].completed = true;
        currentStep++;
        
        // Update the button text for the completed step
        const stepElement = document.querySelector(`.step-item:nth-child(${stepIndex + 1})`);
        if (stepElement) {
            const button = stepElement.querySelector('button.btn-success');
            if (button) {
                button.textContent = 'تم الإكمال - انتظر الخطوة التالية';
                button.disabled = true;
                button.classList.remove('btn-success');
                button.classList.add('btn-secondary');
            }
        }
        
   
        
        // Update the UI
        updateSteps();
    }
}

function nextIhramSubStep() {
    if (ihramSubStep < 3) {
        ihramSubStep++;
        updateSteps();
    }
}

function previousIhramSubStep() {
    if (ihramSubStep > 1) {
        ihramSubStep--;
        updateSteps();
    }
}

function nextMakkahSubStep() {
    if (makkahSubStep < 3) {
        makkahSubStep++;
        updateSteps();
    }
}

function previousMakkahSubStep() {
    if (makkahSubStep > 1) {
        makkahSubStep--;
        updateSteps();
    }
}

function nextSaiiSubStep() {
    if (saiiSubStep < 3) {
        saiiSubStep++;
        updateSteps();
    }
}

function previousSaiiSubStep() {
    if (saiiSubStep > 1) {
        saiiSubStep--;
        updateSteps();
    }
}

function nextMinaSubStep() {
    if (minaSubStep < 3) {
        minaSubStep++;
        updateSteps();
    }
}

function previousMinaSubStep() {
    if (minaSubStep > 1) {
        minaSubStep--;
        updateSteps();
    }
}

function nextArafahSubStep() {
    if (arafahSubStep < 6) {
        arafahSubStep++;
        updateSteps();
    }
}

function previousArafahSubStep() {
    if (arafahSubStep > 1) {
        arafahSubStep--;
        updateSteps();
    }
}

function nextMuzdalifahSubStep() {
    if (muzdalifahSubStep < 4) {
        muzdalifahSubStep++;
        updateSteps();
    }
}

function previousMuzdalifahSubStep() {
    if (muzdalifahSubStep > 1) {
        muzdalifahSubStep--;
        updateSteps();
    }
}

function nextNahrDaySubStep() {
    if (nahrDaySubStep < 6) {
        nahrDaySubStep++;
        updateSteps();
    }
}

function previousNahrDaySubStep() {
    if (nahrDaySubStep > 1) {
        nahrDaySubStep--;
        updateSteps();
    }
}

function nextTashreeqSubStep() {
    if (tashreeqSubStep < 5) {
        tashreeqSubStep++;
        updateSteps();
    }
}

function previousTashreeqSubStep() {
    if (tashreeqSubStep > 1) {
        tashreeqSubStep--;
        updateSteps();
    }
}

// Add modal HTML to the body
document.body.insertAdjacentHTML('beforeend', `
    <div id="ihramInfoModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>الإحرام</h2>
                <button class="close-btn" onclick="closeIhramInfo()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="ihramInfoCarousel" class="carousel slide" data-bs-ride="carousel" data-bs-interval="false">
                    <div class="carousel-indicators">
                        <button type="button" data-bs-target="#ihramInfoCarousel" data-bs-slide-to="0" class="active"></button>
                        <button type="button" data-bs-target="#ihramInfoCarousel" data-bs-slide-to="1"></button>
                        <button type="button" data-bs-target="#ihramInfoCarousel" data-bs-slide-to="2"></button>
                        <button type="button" data-bs-target="#ihramInfoCarousel" data-bs-slide-to="3"></button>
                        <button type="button" data-bs-target="#ihramInfoCarousel" data-bs-slide-to="4"></button>
                        <button type="button" data-bs-target="#ihramInfoCarousel" data-bs-slide-to="5"></button>
                        <button type="button" data-bs-target="#ihramInfoCarousel" data-bs-slide-to="6"></button>
                    </div>
                    <div class="carousel-inner">
                        <!-- Definition -->
                        <div class="carousel-item active">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h3>تعريف الإحرام</h3>
                                            <p>الإحرام هو الدخول في عبادة الحج أو العمرة، والاشتغال بأعمالها قصداً. ويقال أَحْرَم إذا دخل في النسك، فيصبح محرّماً عليه ما كان مباحاً.</p>
                                            <p>للإحرام مظاهر وشعائر مخصوصة، ودلالات ترمز إلى التجرد من الدنيا وزينتها والإقبال على الله والعبادة بقلب نقي، وجوارح مطيعة.</p>
                                        </div>
                                        <div class="col-md-4">
                                            <img src="img/ihram-def2.jpeg" alt="تعريف الإحرام" class="img-fluid rounded mb-3" style="width: 100%; object-fit: cover;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Prohibitions -->
                        <div class="carousel-item">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h3>محظورات الإحرام</h3>
                                            <ul class="list-group mb-3">
                                                <li class="list-group-item">لبس المخيط للرجال - قص الشعر أو الأظافر - تغطية الرأس للرجال</li>
                                                
                                                <li class="list-group-item"> الجماع - الصيد - استخدام الطيب</li>
                                                
                                                <li class="list-group-item"> تغطية الوجه للنساء - الخطبة والنكاح</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-4">
                                            <img src="img/ihram-rstrctd.jpeg" alt="محظورات الإحرام" class="img-fluid rounded mb-3" style="width: 100%; object-fit: cover;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Men's Clothing -->
                        <div class="carousel-item">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h3>ملابس الإحرام للرجل</h3>
                                            <h5>الواجب خلعه:</h5>
                                        
                                                <p>أغطية الرأس (قبعة، عمامة، وغيرها)</p>
                                                <p>الجوربين والقفازين - اللباس المفصل (قميص، بنطلون)</p>
                                              
                                                <p>الأحذية التي تحيط بالقدمين والكعبين</p>
                                          
                                            <h5>ما يلبسه:</h5>
                                            
                                                <p>إزار يحيط أسفل البدن</p>
                                                <p>رداء يغطي أعلى البدن (يفضل أن يكون أبيض)</p>
                                                <p>نعال مناسبة لا تغطي كامل القدم</p>
                                           
                                        </div>
                                        <div class="col-md-4">
                                            <img src="img/ihram-men2.jpeg" alt="ملابس الإحرام للرجل" class="img-fluid rounded mb-3" style="width: 100%; object-fit: cover;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Women's Clothing -->
                        <div class="carousel-item">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h3>ملابس الإحرام للمرأة</h3>
                                            <h5>محظورات على المرأة:</h5>
                                           
                                                <p>تغطية الوجه ولبس النقاب - لبس القفازين</p>
                                            
                                            <h5>شروط ملابس المرأة:</h5>
                                            
                                                <p>فضفاضة تسترها - لا تعيق حركتها - خالية من الزينة الظاهرة</p>
                                            
                                        </div>
                                        <div class="col-md-4">
                                            <img src="img/women-rstrctd.jpeg" alt="ملابس الإحرام للمرأة" class="img-fluid rounded mb-3" style="width: 100%; object-fit: cover;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Talbiyah -->
                        <div class="carousel-item">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h3>التلبية</h3>
                                            <h5>كيفية التلبية:</h5>
                                            <div class="alert alert-primary mb-3">
                                                <p class="talbiyah-text text-center mb-0">
                                                    لَبَّيْكَ اللَّهُمَّ لَبَّيْكَ، لَبَّيْكَ لَا شَرِيكَ لَكَ لَبَّيْكَ، إِنَّ الْحَمْدَ وَالنِّعْمَةَ لَكَ وَالْمُلْكَ، لَا شَرِيكَ لَكَ
                                                </p>
                                            </div>
                                            <h5>وقت التلبية:</h5>
                                            <ul class="list-group">
                                                <p>تبدأ مع الإحرام</p>
                                                <p>تنتهي في العمرة عند رؤية البيت أو بدء الطواف</p>
                                                <p>تنتهي في الحج عند رمي جمرة العقبة</p>
                                            </ul>
                                        </div>
                                        <div class="col-md-4">
                                            <img src="img/ihram-talbiya.jpeg" alt="التلبية" class="img-fluid rounded mb-3" style="width: 100%; object-fit: cover;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Conditions -->
                        <div class="carousel-item">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h3>الاشتراط في الإحرام</h3>
                                            <p>يقول بعد النية (لبيك عمرة) أو (لبيك حجاً):</p>
                                            <div class="alert alert-primary mb-3">
                                                <p class="text-center mb-0 talbiyah-text">
                                                    فَإِنْ حَبَسَنِي حَابِسٌ فَمَحِلِّي حَيْثُ حَبَسْتَنِي
                                                </p>
                                            </div>
                                            <p class="text-muted">يمكن قولها بأي لغة يُحسنها الحاج أو المعتمر</p>
                                        </div>
                                        <div class="col-md-4">
                                            <img src="img/ichtirat-ihram.webp" alt="الاشتراط في الإحرام" class="img-fluid rounded mb-3" style="width: 100%; object-fit: cover;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Sunnah -->
                        <div class="carousel-item">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h3>سنن الإحرام</h3>
                                            <div class="list-group mb-3">
                                                <p>الاغتسال أو الوضوء</p>
                                                <p>النظافة الشخصية</p>
                                                <p>الإحرام بعد صلاة</p>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <img src="img/sunan-ihram.webp" alt="سنن الإحرام" class="img-fluid rounded mb-3" style="width: 100%; object-fit: cover;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button class="carousel-control-prev" type="button" data-bs-target="#ihramInfoCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#ihramInfoCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
`);

function showIhramInfo() {
    const modal = document.getElementById('ihramInfoModal');
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden';
}

function closeIhramInfo() {
    const modal = document.getElementById('ihramInfoModal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
}

// Add Makkah info modal
document.body.insertAdjacentHTML('beforeend', `
    <div id="makkahInfoModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>الطواف</h2>
                <button class="close-btn" onclick="closeMakkahInfo()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="makkahInfoCarousel" class="carousel slide" data-bs-ride="carousel" data-bs-interval="false">
                    <div class="carousel-indicators">
                        <button type="button" data-bs-target="#makkahInfoCarousel" data-bs-slide-to="0" class="active"></button>
                        <button type="button" data-bs-target="#makkahInfoCarousel" data-bs-slide-to="1"></button>
                        <button type="button" data-bs-target="#makkahInfoCarousel" data-bs-slide-to="2"></button>
                        <button type="button" data-bs-target="#makkahInfoCarousel" data-bs-slide-to="3"></button>
                        <button type="button" data-bs-target="#makkahInfoCarousel" data-bs-slide-to="4"></button>
                    </div>
                    <div class="carousel-inner">
                        <!-- Spiritual Entry -->
                        <div class="carousel-item active">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h3>روحانية دخول الحرم</h3>
                                            <p>دخول الحرم تجربة روحانية عظيمة تُشعر بالخشوع والخضوع لله، ويُستحسن التأمل والدعاء عند دخوله.</p>
                                        </div>
                                        <div class="col-md-4">
                                            <img src="img/spiritual-entry.jpg" alt="روحانية دخول الحرم" class="img-fluid rounded mb-3" style="max-height: 200px; width: 100%; object-fit: contain;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Prohibited Items -->
                        <div class="carousel-item">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h3>ما يُمنع إدخاله للحرم</h3>
                                            <ul class="list-group mb-3">
                                                <li class="list-group-item">الطعام والشراب (عدا التمر والماء والقهوة)</li>
                                                <li class="list-group-item">السوائل القابلة للاشتعال</li>
                                                <li class="list-group-item">الأدوات الحادة</li>
                                                <li class="list-group-item">الحقائب الكبيرة</li>
                                                <li class="list-group-item">عربات الأطفال</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-4">
                                            <img src="img/prohibited-items.png" alt="الممنوعات" class="img-fluid rounded mb-3" style="max-height: 200px; width: 100%; object-fit: contain;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Gates -->
                        <div class="carousel-item">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h3>بوابات الحرم المكي</h3>
                                            <h5>أبرز الأبواب:</h5>
                                            <ul class="list-group mb-3">
                                                <li class="list-group-item">باب الملك عبد العزيز (رقم 1)</li>
                                                <li class="list-group-item">باب الصفا (11)</li>
                                                <li class="list-group-item">باب الفتح (45)</li>
                                                <li class="list-group-item">باب العمرة (62)</li>
                                                <li class="list-group-item">باب الملك فهد (79)</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-4">
                                            <img src="img/haram-gates.jpg" alt="بوابات الحرم" class="img-fluid rounded mb-3" style="max-height: 200px; width: 100%; object-fit: contain;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Children and Wheelchairs -->
                        <div class="carousel-item">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h3>الأطفال والعربات</h3>
                                            <h5>الأطفال في الحرم:</h5>
                                            <ul class="list-group mb-3">
                                                <li class="list-group-item">يُسمح بدخول الأطفال</li>
                                                <li class="list-group-item">من فوق 5 سنوات يحتاجون لتصريح عمرة</li>
                                                <li class="list-group-item">يُنصح ببطاقة تعريف أو سوار تعريفي للطفل</li>
                                            </ul>
                                            <h5>الدخول بالعربات:</h5>
                                            <ul class="list-group">
                                                <li class="list-group-item">يُسمح بالعربات اليدوية والكهربائية من مداخل مخصصة</li>
                                                <li class="list-group-item">تتوفر عربات مجانية وكهربائية</li>
                                                <li class="list-group-item">خدمة دافعي العربات متوفرة</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-4">
                                            <img src="img/children-wheelchairs.jpg" alt="الأطفال والعربات" class="img-fluid rounded mb-3" style="max-height: 200px; width: 100%; object-fit: contain;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Tawaf Details -->
                        <div class="carousel-item">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h3>صفة الطواف</h3>
                                            <ul class="list-group mb-3">
                                                <li class="list-group-item">يبدأ الطواف من الحجر الأسود</li>
                                                <li class="list-group-item">اجعل الكعبة على يسارك وابدأ 7 أشواط</li>
                                                <li class="list-group-item">كبّر عند بداية كل شوط</li>
                                                <li class="list-group-item">يُستحب تقبيل الحجر الأسود إن أمكن أو الإشارة إليه</li>
                                            </ul>
                                            <h5>الرمل والاضطباع (للرجال فقط):</h5>
                                            <ul class="list-group mb-3">
                                                <li class="list-group-item">الرمل: إسراع بالمشي في الثلاثة أشواط الأولى</li>
                                                <li class="list-group-item">الاضطباع: كشف الكتف الأيمن في طواف العمرة والقدوم</li>
                                            </ul>
                                            <h5>سنة الدعاء والركعتين بعد الطواف:</h5>
                                            <ul class="list-group">
                                                <li class="list-group-item">يُستحب الإكثار من الدعاء أثناء الطواف</li>
                                                <li class="list-group-item">بعد الطواف، تُصلّى ركعتان خلف مقام إبراهيم إن تيسر</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-4">
                                            <img src="img/tawaf-details.jpg" alt="صفة الطواف" class="img-fluid rounded mb-3" style="max-height: 200px; width: 100%; object-fit: contain;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button class="carousel-control-prev" type="button" data-bs-target="#makkahInfoCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#makkahInfoCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
`);

function showMakkahInfo() {
    const modal = document.getElementById('makkahInfoModal');
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden';
}

function closeMakkahInfo() {
    const modal = document.getElementById('makkahInfoModal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
}


const style = document.createElement('style');
style.textContent = `
/* Ensures the parent containers don't let children overflow */
.card,
.card-body,
.carousel-item,
.col-md-4 {
    overflow: hidden;
    position: relative; /* Needed to clip the zoomed image inside */
}

/* Base image style */
img.img-fluid {
    transition: transform 0.3s ease;
    transform: scale(1);
    transform-origin: center center;
    display: block;
    width: 100%;
    height: auto;
    object-fit: contain;       /* ensures the full image is visible */
    max-height: 100%;          /* or remove this entirely */
}


/* Hover-enabled zoom effect */
img.img-fluid.zoom-hover:hover {
    transform: scale(2); /* Zoom level */
    cursor: zoom-in;
}

/* Optional: prevent zoomed image from going out of bounds visually */
img.img-fluid.zoom-hover {
    will-change: transform;
}

    .modal-overlay {
       position: fixed;
    top: 0; /* Fullscreen start */
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(5px);
    z-index: 1000;

    display: flex;
    justify-content: center;
    align-items: center;
    }

    .modal-content {
         background: white;
    padding: 2rem;
    border-radius: 8px;
    width: 90%;
    max-width: 1200px;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);

    /* These ensure it stays centered within the flex parent */
    margin: 0 auto;
    top: 20px;
    height: 95vh;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #dee2e6;
    }

    .close-btn {
       color: #000;
    width: 50px;
    border-radius: 50%;
    height: 50px;
    color: white;
    background: red;
    font-weight: 900;
    }

    .close-btn:hover {
        color: #000;
        background: #fff;
    }

    .modal-body {
        padding: 10px 0;
    }

    .carousel-item {
        padding: 20px;
    }

    .carousel-control-prev,
    .carousel-control-next {
    width: 5px;
    opacity: 0.8;
    height: 5vh;
    position: fixed;
    top: 50%;
    margin: 0 50px;
    }

    .carousel-control-prev-icon,
    .carousel-control-next-icon {
        background-color: rgba(0, 0, 0, 0.5);
        border-radius: 50%;
        padding: 20px;

        height: 50px;
    }

    .carousel-indicators {
        margin-bottom: 0;
        position: fixed;
        bottom: 50px;
    }

    .carousel-indicators button {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin: 0 5px;
    }
`;
document.head.appendChild(style);

// Add Sa'i info modal
document.body.insertAdjacentHTML('beforeend', `
    <div id="saiiInfoModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>السعي بين الصفا والمروة</h2>
                <button class="close-btn" onclick="closeSaiiInfo()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="saiiInfoCarousel" class="carousel slide" data-bs-ride="carousel" data-bs-interval="false">
                    <div class="carousel-indicators">
                        <button type="button" data-bs-target="#saiiInfoCarousel" data-bs-slide-to="0" class="active"></button>
                        <button type="button" data-bs-target="#saiiInfoCarousel" data-bs-slide-to="1"></button>
                        <button type="button" data-bs-target="#saiiInfoCarousel" data-bs-slide-to="2"></button>
                        <button type="button" data-bs-target="#saiiInfoCarousel" data-bs-slide-to="3"></button>
                    </div>
                    <div class="carousel-inner">
                        <!-- General Information -->
                        <div class="carousel-item active">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h3>معلومات عامة عن السعي</h3>
                                            <p>السعي بين الصفا والمروة من شعائر الله، وهو سُنّة مأخوذة عن هاجر -عليها السلام- عندما كانت تبحث عن الماء لابنها إسماعيل.</p>
                                            <ul class="list-group mb-3">
                                                <li class="list-group-item">يبدأ من الصفا ويختم بالمروة</li>
                                                <li class="list-group-item">7 أشواط (الذهاب شوط، والعودة شوط)</li>
                                                <li class="list-group-item">يُستحب الإكثار من الدعاء أثناء السعي</li>
                                                <li class="list-group-item">لا يشترط الطهارة للسعي</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-4">
                                            <img src="img/76-163617-hajj-season-pilgrimage2-2.jpg" alt="معلومات عامة عن السعي" class="img-fluid rounded mb-3" style="max-height: 200px; width: 100%; object-fit: contain;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Wheelchair Access -->
                        <div class="carousel-item">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h3>السعي على الكرسي المتحرك</h3>
                                            <ul class="list-group mb-3">
                                                <li class="list-group-item">يُسمح بالسعي على الكرسي المتحرك</li>
                                                <li class="list-group-item">تتوفر مسارات مخصصة للكراسي المتحركة</li>
                                                <li class="list-group-item">يمكن الاستعانة بمن يدفع الكرسي</li>
                                                <li class="list-group-item">يُفضل استخدام الدور العلوي لتجنب الزحام</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-4">
                                            <img src="img/wheelchairs.jpeg" alt="السعي على الكرسي المتحرك" class="img-fluid rounded mb-3" style="max-height: 200px; width: 100%; object-fit: contain;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Guidelines -->
                        <div class="carousel-item">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h3>إرشادات السعي</h3>
                                            <ul class="list-group mb-3">
                                                <li class="list-group-item">يُستحب الإكثار من الدعاء أثناء السعي</li>
                                                <li class="list-group-item">الرجال يهرولون بين العلمين الأخضرين فقط</li>
                                                <li class="list-group-item">يُفضل استخدام الدور العلوي لتجنب الزحام</li>
                                                <li class="list-group-item">يمكن أخذ قسط من الراحة بين الأشواط</li>
                                                <li class="list-group-item">يُستحب شرب ماء زمزم أثناء السعي</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-4">
                                            <img src="img/advertice-safa.webp" alt="إرشادات السعي" class="img-fluid rounded mb-3" style="max-height: 200px; width: 100%; object-fit: contain;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Hair Cutting -->
                        <div class="carousel-item">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h3>الحلق والتقصير</h3>
                                            <ul class="list-group mb-3">
                                                <li class="list-group-item">في العمرة: اذهب للحلق أو التقصير مباشرة بعد السعي</li>
                                                <li class="list-group-item">في الحج: الحلق أو التقصير يكون بعد رمي جمرة العقبة</li>
                                                <li class="list-group-item">الرجل: يُفضل الحلق كاملاً، ويبدأ بالشق الأيمن</li>
                                                <li class="list-group-item">المرأة: تقصّ من أطراف شعرها قدر أنملة (1–2 سم)</li>
                                                <li class="list-group-item">يُشترط حلق أو تقصير جميع شعر الرأس، لا جزء منه</li>
                                                <li class="list-group-item">يُنصح بالحلق في محلات نظيفة مرخصة، باستخدام أدوات جديدة ومعقّمة</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-4">
                                            <img src="img/halq.png" alt="الحلق والتقصير" class="img-fluid rounded mb-3" style="max-height: 200px; width: 100%; object-fit: contain;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button class="carousel-control-prev" type="button" data-bs-target="#saiiInfoCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#saiiInfoCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
`);

function showSaiiInfo() {
    const modal = document.getElementById('saiiInfoModal');
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden';
}

function closeSaiiInfo() {
    const modal = document.getElementById('saiiInfoModal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
}

// Add Mina info modal
document.body.insertAdjacentHTML('beforeend', `
    <div id="minaInfoModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>الذهاب إلى منى</h2>
                <button class="close-btn" onclick="closeMinaInfo()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="minaInfoCarousel" class="carousel slide" data-bs-ride="carousel" data-bs-interval="false">
                    <div class="carousel-indicators">
                        <button type="button" data-bs-target="#minaInfoCarousel" data-bs-slide-to="0" class="active"></button>
                        <button type="button" data-bs-target="#minaInfoCarousel" data-bs-slide-to="1"></button>
                        <button type="button" data-bs-target="#minaInfoCarousel" data-bs-slide-to="2"></button>
                        <button type="button" data-bs-target="#minaInfoCarousel" data-bs-slide-to="3"></button>
                        <button type="button" data-bs-target="#minaInfoCarousel" data-bs-slide-to="4"></button>
                    </div>
                    <div class="carousel-inner">
                        <!-- General Information -->
                        <div class="carousel-item active">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h3>معلومات عن مشعر منى</h3>
                                            <p>وادٍ صغير يقع بين مكة وعرفات، أقرب المشاعر إلى المسجد الحرام. يمكث فيه الحجاج من يوم التروية (8 ذو الحجة) حتى آخر أيام التشريق.</p>
                                            <h5>معالم مشعر منى:</h5>
                                            <ul class="list-group mb-3">
                                                <li class="list-group-item">مسجد الخيف: صلى فيه 70 نبيًا، ومنهم النبي محمد ﷺ</li>
                                                <li class="list-group-item">مسجد البيعة: على أرض أول بيعة في الإسلام</li>
                                                <li class="list-group-item">الجمرات الثلاث: الصغرى، الوسطى، وجمرة العقبة (الكبرى)</li>
                                                <li class="list-group-item">مجزر الكبش: الموضع الذي فُدي فيه إسماعيل عليه السلام</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-4">
                                            <img src="img/mina-general.jpg" alt="مشعر منى" class="img-fluid rounded mb-3" style="max-height: 200px; width: 100%; object-fit: contain;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Day of Tarwiyah -->
                        <div class="carousel-item">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h3>يوم التروية (8 ذو الحجة)</h3>
                                            <ul class="list-group mb-3">
                                                <li class="list-group-item">يوم التهيئة قبل الوقوف بعرفة</li>
                                                <li class="list-group-item">يُسمى "التروية" لأن الحجاج قديماً كانوا يتزوّدون بالماء</li>
                                                <li class="list-group-item">الحجاج يصلّون الظهر والعصر والمغرب والعشاء والفجر في منى</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-4">
                                            <img src="img/tarwiyah-day.jpg" alt="يوم التروية" class="img-fluid rounded mb-3" style="max-height: 200px; width: 100%; object-fit: contain;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Location Guide -->
                        <div class="carousel-item">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h3>كيف تعرف موقعك في منى؟</h3>
                                            <ul class="list-group mb-3">
                                                <li class="list-group-item">استخدم GPS لتحديد موقعك</li>
                                                <li class="list-group-item">لا تخرج من المخيم إلا بإذن مشرف الحملة</li>
                                                <li class="list-group-item">احفظ رقم مخيمك وأقرب المعالم إليه</li>
                                                <li class="list-group-item">التقط صورة للموقع، وسجّله على تطبيق خرائط بجوالك</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-4">
                                            <img src="img/mina-location.png" alt="موقع منى" class="img-fluid rounded mb-3" style="max-height: 200px; width: 100%; object-fit: contain;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Health Guidelines -->
                        <div class="carousel-item">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h3>وصايا صحية في منى</h3>
                                            <ul class="list-group mb-3">
                                                <li class="list-group-item">احمل أدويتك معك واحرص على تخزينها بشكل سليم</li>
                                                <li class="list-group-item">استخدم الملابس القطنية، واشرب الكثير من الماء</li>
                                                <li class="list-group-item">تجنب التعرّض المباشر لهواء المكيّف بعد التعرّق</li>
                                                <li class="list-group-item">ابتعد عن المصابين بنزلات البرد</li>
                                                <li class="list-group-item">الحامل تتجنب الزحام والمجهود</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-4">
                                            <img src="img/mina-health.jpg" alt="الوصايا الصحية" class="img-fluid rounded mb-3" style="max-height: 200px; width: 100%; object-fit: contain;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Services -->
                        <div class="carousel-item">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h3>الخدمات في منى</h3>
                                            <ul class="list-group mb-3">
                                                <li class="list-group-item">مستشفيات ومراكز صحية طوارئ</li>
                                                <li class="list-group-item">سيارات إسعاف وفرق طبية متنقلة</li>
                                                <li class="list-group-item">خدمات نقل وقطار المشاعر</li>
                                                <li class="list-group-item">بخاخات رذاذ لتخفيف الحرارة</li>
                                                <li class="list-group-item">أماكن للحلاقة، دورات مياه، مطاعم</li>
                                                <li class="list-group-item">سيارات جولف لكبار السن</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-4">
                                            <img src="img/mina-services.jpg" alt="الخدمات" class="img-fluid rounded mb-3" style="max-height: 200px; width: 100%; object-fit: contain;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button class="carousel-control-prev" type="button" data-bs-target="#minaInfoCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#minaInfoCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
`);

function showMinaInfo() {
    const modal = document.getElementById('minaInfoModal');
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden';
}

function closeMinaInfo() {
    const modal = document.getElementById('minaInfoModal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
}

// Add Arafah info modal
document.body.insertAdjacentHTML('beforeend', `
    <div id="arafahInfoModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>يوم عرفة</h2>
                <button class="close-btn" onclick="closeArafahInfo()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="arafahInfoCarousel" class="carousel slide" data-bs-ride="carousel" data-bs-interval="false">
                    <div class="carousel-indicators">
                        <button type="button" data-bs-target="#arafahInfoCarousel" data-bs-slide-to="0" class="active"></button>
                        <button type="button" data-bs-target="#arafahInfoCarousel" data-bs-slide-to="1"></button>
                        <button type="button" data-bs-target="#arafahInfoCarousel" data-bs-slide-to="2"></button>
                        <button type="button" data-bs-target="#arafahInfoCarousel" data-bs-slide-to="3"></button>
                        <button type="button" data-bs-target="#arafahInfoCarousel" data-bs-slide-to="4"></button>
                    </div>
                    <div class="carousel-inner">
                        <!-- General Information -->
                        <div class="carousel-item active">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h3>معلومات عن يوم عرفة</h3>
                                            <p>هو اليوم التاسع من شهر ذو الحجة، ويقع مشعر عرفة بين مكة والطائف.</p>
                                            <ul class="list-group mb-3">
                                                <li class="list-group-item">يبعد عن المسجد الحرام 23 كم</li>
                                                <li class="list-group-item">يبعد عن منى 10 كم</li>
                                                <li class="list-group-item">يبعد عن مزدلفة 6 كم</li>
                                                <li class="list-group-item">فيه الوقوف بعرفة، وهو ركن الحج الأعظم</li>
                                            </ul>
                                            <div class="alert alert-info">
                                                <p class="mb-0">يُعد من أعظم أيام الدنيا: فيه عتق من النار أكثر من أي يوم آخر، والله يُباهي بعباده ملائكته، وخير الدعاء هو دعاء يوم عرفة.</p>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <img src="img/arafah-general.png" alt="معلومات عن يوم عرفة" class="img-fluid rounded mb-3" style="max-height: 200px; width: 100%; object-fit: contain;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Namira Mosque -->
                        <div class="carousel-item">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h3>مسجد نمرة</h3>
                                            <ul class="list-group mb-3">
                                                <li class="list-group-item">المكان الذي خطب فيه النبي ﷺ خطبة الوداع</li>
                                                <li class="list-group-item">تُقام فيه صلاة الظهر والعصر جمعًا وقصرًا بإمام واحد</li>
                                                <li class="list-group-item">ثاني أكبر مسجد بمكة بعد الحرم</li>
                                                <li class="list-group-item">مساحته أكثر من 110 ألف م²</li>
                                                <li class="list-group-item">يتسع لـ 350 ألف مصلٍّ</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-4">
                                            <img src="img/namira-mosque.jpg" alt="مسجد نمرة" class="img-fluid rounded mb-3" style="max-height: 200px; width: 100%; object-fit: contain;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Mount Arafah -->
                        <div class="carousel-item">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h3>جبل عرفة (جبل الرحمة)</h3>
                                            <ul class="list-group mb-3">
                                                <li class="list-group-item">شاخص إسمنتي بطول 7 أمتار وُضع عليه</li>
                                                <li class="list-group-item">يُسمى أيضًا: جبل التوبة أو الرحمة</li>
                                                <li class="list-group-item">الصعود عليه ليس من السنّة</li>
                                                <li class="list-group-item">السنة الوقوف في أي موضع من عرفة</li>
                                            </ul>
                                            <div class="alert alert-warning">
                                                <p class="mb-0">النبي ﷺ وقف أسفل الجبل وقال: "وقفتُ ها هنا، وعرفة كلها موقف"</p>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <img src="img/mount-arafah.jpg" alt="جبل عرفة" class="img-fluid rounded mb-3" style="max-height: 200px; width: 100%; object-fit: contain;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Activities -->
                        <div class="carousel-item">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h3>كيف يقضي الحاج يوم عرفة؟</h3>
                                            <ul class="list-group mb-3">
                                                <li class="list-group-item">الصلاة: الظهر والعصر جمعًا وقصرًا في جماعة</li>
                                                <li class="list-group-item">العبادة: قراءة القرآن، الدعاء، التلبية، الذكر</li>
                                                <li class="list-group-item">المكوث: الأفضل البقاء في المخيم وعدم مغادرته إلا لضرورة</li>
                                                <li class="list-group-item">الدعاء: يُستحب الإكثار من الدعاء؛ فهو أفضل الدعاء</li>
                                            </ul>
                                            <div class="alert alert-info">
                                                <p class="mb-0">الصيام: لا يُشرع للحاج، لكن لغير الحاج ثوابه عظيم (يكفّر سنتين)</p>
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <img src="img/arafah-activities.jpg" alt="أنشطة يوم عرفة" class="img-fluid rounded mb-3" style="max-height: 200px; width: 100%; object-fit: contain;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Guidelines -->
                        <div class="carousel-item">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-8">
                                            <h3>إرشادات مهمة</h3>
                                            <h5>في مخيمك بعرفة:</h5>
                                            <ul class="list-group mb-3">
                                                <li class="list-group-item">صلِّ الظهر والعصر جمعًا وقصرًا بعد الزوال</li>
                                                <li class="list-group-item">لا تغادر المخيم إلا لضرورة، فالطرق متشابهة</li>
                                                <li class="list-group-item">استغل كل لحظة في العبادة: الدعاء، التلبية، القرآن، الذكر</li>
                                                <li class="list-group-item">نوع بين هذه العبادات لتجنب الملل</li>
                                            </ul>
                                            <h5>ما لا يُستحب:</h5>
                                            <ul class="list-group">
                                                <li class="list-group-item">لا تصعد جبل الرحمة؛ لأنه ليس من السنن، وفيه مشقة</li>
                                                <li class="list-group-item">لا تفتعل الزحام عند الشاخص أو عند المخارج</li>
                                            </ul>
                                        </div>
                                        <div class="col-md-4">
                                            <img src="img/arafah-guidelines.jpg" alt="إرشادات يوم عرفة" class="img-fluid rounded mb-3" style="max-height: 200px; width: 100%; object-fit: contain;">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button class="carousel-control-prev" type="button" data-bs-target="#arafahInfoCarousel" data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" type="button" data-bs-target="#arafahInfoCarousel" data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                </div>
            </div>
        </div>
    </div>
`);

function showArafahInfo() {
    const modal = document.getElementById('arafahInfoModal');
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden';
}

function closeArafahInfo() {
    const modal = document.getElementById('arafahInfoModal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
}

// Add Muzdalifah info modal
document.body.insertAdjacentHTML('beforeend', `
    <div id="muzdalifahInfoModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>مزدلفة</h2>
                <button class="close-btn" onclick="closeMuzdalifahInfo()">&times;</button>
            </div>
            <div class="modal-body">
                <div id="muzdalifahInfoCarousel" class="carousel slide" data-bs-ride="carousel" data-bs-interval="false">
                    <div class="carousel-indicators">
                        <button type="button" data-bs-target="#muzdalifahInfoCarousel" data-bs-slide-to="0" class="active"></button>
                        <button type="button" data-bs-target="#muzdalifahInfoCarousel" data-bs-slide-to="1"></button>
                        <button type="button" data-bs-target="#muzdalifahInfoCarousel" data-bs-slide-to="2"></button>
                        <button type="button" data-bs-target="#muzdalifahInfoCarousel" data-bs-slide-to="3"></button>
                        <button type="button" data-bs-target="#muzdalifahInfoCarousel" data-bs-slide-to="4"></button>
                    </div>
                    <div class="carousel-inner">
                        <!-- General Information -->
                        <div class="carousel-item active">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <h3>معلومات عامة عن مزدلفة</h3>
                                    <div class="alert alert-info mb-3">
                                        <p class="mb-2">ما هو مشعر مزدلفة؟</p>
                                        <ul class="mb-0">
                                            <li>مزدلفة من المشاعر المقدسة الواقعة بين عرفات ومنى</li>
                                            <li>تُسمى كذلك "المشعر الحرام"، و"جَمع" لاجتماع الناس فيها</li>
                                            <li>ذُكرت في القرآن: ﴿فَاذْكُرُوا الله عِندَ الْمَشْعَرِ الْحَرَامِ﴾</li>
                                            <li>فيها يُجمع الحجاج بين صلاتي المغرب والعشاء جمعًا وقصرًا</li>
                                            <li>مسجدها الشهير هو مسجد المشعر الحرام حيث نزل النبي ﷺ في حجة الوداع</li>
                                            <li>من فضائلها: أن الله يغفر لأهل عرفات وأهل مزدلفة معًا</li>
                                        </ul>
                                    </div>
                                    <h4>الموقع:</h4>
                                    <ul class="list-group mb-3">
                                        <li class="list-group-item">تقع جنوب شرق مكة، بين منى وعرفات</li>
                                        <li class="list-group-item">تبعد 10 كم عن الحرم، و9 كم عن عرفات</li>
                                        <li class="list-group-item">فيها طرق للمشاة مزوّدة بماء، ومرتبطة بقطار المشاعر</li>
                                    </ul>
                                    <h4>وقت الوقوف:</h4>
                                    <ul class="list-group mb-3">
                                        <li class="list-group-item">يبدأ بعد غروب شمس يوم عرفة</li>
                                        <li class="list-group-item">يُستحب البقاء حتى الفجر، لكن يجوز المغادرة بعد منتصف الليل للنساء وكبار السن</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- Pebbles -->
                        <div class="carousel-item">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <h4>حصى مزدلفة</h4>
                                    <div class="alert alert-primary mb-3">
                                        <h5>كيف تحضر الحصى؟</h5>
                                        <ul class="mb-0">
                                            <li>يجب أن تكون الحصى صغيرة، بحجم حبة الحمص تقريبًا</li>
                                            <li>لا حاجة لغسلها أو اختيار شكل موحّد لها</li>
                                        </ul>
                                    </div>
                                    <div class="alert alert-info">
                                        <h5>لماذا نلتقط الحصى؟</h5>
                                        <ul class="mb-0">
                                            <li>لرمْي جمرة العقبة الكبرى يوم العيد</li>
                                            <li>الحصى يجب أن تكون صغيرة، بحجم حبة الحمص تقريبًا</li>
                                            <li>لا حاجة لغسلها أو اختيار شكل موحّد لها</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Arrival -->
                        <div class="carousel-item">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <h4>الوصول إلى مزدلفة</h4>
                                    <ul class="list-group mb-3">
                                        <li class="list-group-item">صَلِّ المغرب والعشاء مع الحملة (جمعًا وقصرًا)</li>
                                        <li class="list-group-item">نم واسترح استعدادًا ليوم العيد</li>
                                        <li class="list-group-item">اذكر الله وادعُ في وقتك بهدوء</li>
                                    </ul>
                                    <div class="alert alert-info">
                                        <h5>الاستعداد ليوم العيد:</h5>
                                        <ul class="mb-0">
                                            <li>اجمع 7 حصيات صغيرة من الأرض (أو من أي مكان لاحقًا)</li>
                                            <li>احرص أن تكون الحصى صغيرة، بدون مبالغة في الحجم أو الشكل</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Departure -->
                        <div class="carousel-item">
                            <div class="card bg-light mb-4">
                                <div class="card-body">
                                    <h4>مغادرة مزدلفة والتوجه إلى الجمرات</h4>
                                    <div class="alert alert-warning mb-3">
                                        <h5>مغادرة مزدلفة:</h5>
                                        <ul class="mb-0">
                                            <li>التزم بتعليمات الحملة حول وقت التحرك إلى منى، خاصة للنساء أو كبار السن</li>
                                            <li>غادر بعد منتصف الليل أو بعد الفجر حسب جدول الحملة</li>
                                        </ul>
                                    </div>
                                    <div class="alert alert-info">
                                        <h5>التوجه إلى الجمرات:</h5>
                                        <ul class="mb-0">
                                            <li>التزم بوسيلة النقل المحددة لك (قطار – حافلة – مشيًا)</li>
                                            <li>احمل معك مظلة مريحة وحذاء جيد إن كنت تمشي</li>
                                            <li>رمِ جمرة العقبة بـ7 حصيات، وقل "الله أكبر" مع كل رمية</li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-between mt-4">
                            ${muzdalifahSubStep > 1 ? `
                                <button class="btn btn-primary" onclick="previousMuzdalifahSubStep()">
                                    <i class="bi bi-arrow-right"></i> السابق
                                </button>
                            ` : '<div></div>'}
                            
                            ${muzdalifahSubStep < 4 ? `
                                <button class="btn btn-success" onclick="nextMuzdalifahSubStep()">
                                    التالي <i class="bi bi-arrow-left"></i>
                                </button>
                            ` : `
                                <button class="btn btn-success" onclick="completeStep(${index})">
                                    إكمال هذه الخطوة
                                </button>
                            `}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
`);

function showMuzdalifahInfo() {
    const modal = document.getElementById('muzdalifahInfoModal');
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden';
}

function closeMuzdalifahInfo() {
    const modal = document.getElementById('muzdalifahInfoModal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
}

// Add Nahr Day info modal
document.body.insertAdjacentHTML('beforeend', `
    <div id="nahrDayInfoModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>معلومات عن يوم النحر</h2>
                <button class="close-btn" onclick="closeNahrDayInfo()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="card bg-light mb-4">
                    <div class="card-body">
                        <h3>ما هو "يوم النحر"؟</h3>
                        <div class="alert alert-info mb-3">
                            <ul class="mb-0">
                                <li>يوم النحر هو اليوم العاشر من ذي الحجة، ويُعد أفضل يوم في السنة</li>
                                <li>يُسمى أيضًا "يوم الحج الأكبر" لأن فيه تُؤدى معظم مناسك الحج</li>
                                <li>قال ﷺ: "أفضل الأيام عند الله يوم النحر"</li>
                                <li>هو أول أيام العيد ويتبعه أيام التشريق (11، 12، 13)</li>
                            </ul>
                        </div>

                        <h4>فضل هذا اليوم:</h4>
                        <ul class="list-group mb-3">
                            <li class="list-group-item">فيه يفرح المسلمون ويؤدّون العبادات</li>
                            <li class="list-group-item">تُجمع فيه أعظم أعمال الحج في يوم واحد</li>
                        </ul>

                        <h4>أبرز أعمال الحاج في هذا اليوم:</h4>
                        <ul class="list-group mb-3">
                            <li class="list-group-item">رمي جمرة العقبة الكبرى فقط</li>
                            <li class="list-group-item">ذبح الهدي (للمتمتع والقارن فقط)</li>
                            <li class="list-group-item">الحلق أو التقصير (الحلق أفضل للرجال)</li>
                            <li class="list-group-item">التحلل الأول (يحل للحاج كل شيء إلا العلاقة الزوجية)</li>
                            <li class="list-group-item">طواف الإفاضة (ركن من أركان الحج)</li>
                            <li class="list-group-item">سعي الحج (إن لم يسع من قبل)</li>
                        </ul>

                        <h4>من يجب عليه الهدي؟</h4>
                        <ul class="list-group mb-3">
                            <li class="list-group-item">المتمتع: من اعتمر ثم أحرم بالحج</li>
                            <li class="list-group-item">القارن: من جمع بين العمرة والحج</li>
                            <li class="list-group-item">لا يجب على المُفرد</li>
                        </ul>

                        <div class="alert alert-warning">
                            <h5>هل يجب ترتيب الأعمال؟</h5>
                            <p class="mb-0">لا. يجوز تقديم أو تأخير أي عمل منها حسب التيسير. قال النبي ﷺ: "افعل ولا حرج" لمن سأل عن تقديم أو تأخير المناسك.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
`);

// Add Nahr Day navigation functions
function nextNahrDaySubStep() {
    if (nahrDaySubStep < 6) {
        nahrDaySubStep++;
        updateSteps();
    }
}

function previousNahrDaySubStep() {
    if (nahrDaySubStep > 1) {
        nahrDaySubStep--;
        updateSteps();
    }
}

function showNahrDayInfo() {
    const modal = document.getElementById('nahrDayInfoModal');
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden';
}

function closeNahrDayInfo() {
    const modal = document.getElementById('nahrDayInfoModal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
}

// Add Tashreeq info modal
document.body.insertAdjacentHTML('beforeend', `
    <div id="tashreeqInfoModal" class="modal-overlay" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h2>معلومات عن أيام التشريق</h2>
                <button class="close-btn" onclick="closeTashreeqInfo()">&times;</button>
            </div>
            <div class="modal-body">
                <div class="card bg-light mb-4">
                    <div class="card-body">
                        <h3>ما هي أيام التشريق؟</h3>
                        <div class="alert alert-info mb-3">
                            <ul class="mb-0">
                                <li>أيام التشريق هي 11، 12، 13 من ذي الحجة، وتبدأ بعد عيد الأضحى مباشرة</li>
                                <li>هي أيام عيد وأكل وذكر لله، وفيها يُكمل الحجاج مناسكهم</li>
                                <li>سُمّيت بالتشريق لأن الناس في الماضي كانوا يشرّقون اللحم (يقطعونه ويجففونه في الشمس)</li>
                            </ul>
                        </div>

                        <h4>فضل أيام التشريق:</h4>
                        <ul class="list-group mb-3">
                            <li class="list-group-item">قال النبي ﷺ: "أيام التشريق أيام أكل وشرب وذكر لله"</li>
                            <li class="list-group-item">لا يُشرع فيها صيام</li>
                            <li class="list-group-item">تُعد من الأيام المعدودات التي أمر الله فيها بذكره: ﴿وَاذْكُرُوا اللَّهَ فِي أَيَّامٍ مَعْدُودَاتٍ﴾</li>
                        </ul>

                        <h4>الذكر والتكبير:</h4>
                        <div class="alert alert-primary mb-3">
                            <p class="mb-2">يُستحب التكبير بعد الصلوات وفي كل وقت</p>
                            <p class="mb-0">من صيغ التكبير: "الله أكبر الله أكبر، لا إله إلا الله، الله أكبر الله أكبر، ولله الحمد"</p>
                        </div>

                        <h4>التعجل والتأخر:</h4>
                        <div class="alert alert-warning">
                            <p class="mb-0">قال الله: ﴿فَمَنْ تَعَجَّلَ فِي يَوْمَيْنِ فَلَا إِثْمَ عَلَيْهِ وَمَنْ تَأَخَّرَ فَلَا إِثْمَ عَلَيْهِ﴾</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
`);

// Add Tashreeq navigation functions
function nextTashreeqSubStep() {
    if (tashreeqSubStep < 5) {
        tashreeqSubStep++;
        updateSteps();
    }
}

function previousTashreeqSubStep() {
    if (tashreeqSubStep > 1) {
        tashreeqSubStep--;
        updateSteps();
    }
}

function showTashreeqInfo() {
    const modal = document.getElementById('tashreeqInfoModal');
    modal.style.display = 'block';
    document.body.style.overflow = 'hidden';
}

function closeTashreeqInfo() {
    const modal = document.getElementById('tashreeqInfoModal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
}

// Initialize the application
document.addEventListener('DOMContentLoaded', () => {
    // Hide types section initially
    
    // Add smooth scrolling to all links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener('click', function (e) {
            e.preventDefault();
            document.querySelector(this.getAttribute('href')).scrollIntoView({
                behavior: 'smooth'
            });
        });
    });
}); 


document.querySelectorAll('img.img-fluid').forEach(img => {
    img.classList.add('zoom-hover');

    img.addEventListener('mousemove', (e) => {
        const rect = img.getBoundingClientRect();
        const x = ((e.clientX - rect.left) / rect.width) * 100;
        const y = ((e.clientY - rect.top) / rect.height) * 100;
        img.style.transformOrigin = `${x}% ${y}%`;
    });

    img.addEventListener('mouseleave', () => {
        img.style.transformOrigin = 'center center';
    });
});


document.querySelectorAll('img.img-fluid').forEach(img => {
    img.classList.add('zoom-hover');

    img.addEventListener('mousemove', (e) => {
        const rect = img.getBoundingClientRect();
        const x = ((e.clientX - rect.left) / rect.width) * 100;
        const y = ((e.clientY - rect.top) / rect.height) * 100;
        img.style.transformOrigin = `${x}% ${y}%`;
    });

    img.addEventListener('mouseleave', () => {
        img.style.transformOrigin = 'center center';
    });
});


function applyZoomEffect(scope = document) {
    const images = scope.querySelectorAll('img.img-fluid');

    images.forEach(img => {
        img.classList.add('zoom-hover');

        img.addEventListener('mousemove', (e) => {
            const rect = img.getBoundingClientRect();
            const x = ((e.clientX - rect.left) / rect.width) * 100;
            const y = ((e.clientY - rect.top) / rect.height) * 100;
            img.style.transformOrigin = `${x}% ${y}%`;
        });

        img.addEventListener('mouseleave', () => {
            img.style.transformOrigin = 'center center';
        });
    });
}

function renderProgressMap(currentStepTitle) {
    const normalize = str => (str ?? '').trim().replace(/\s+/g, '');
    

    const currentIndex = masterHajSteps.findIndex(
        step => normalize(step.title) === normalize(currentStepTitle)
    );

    const completedSteps = currentIndex >= 0 ? currentIndex + 1 : 0;

    const totalSteps = masterHajSteps.length;
    const percentage = Math.round((completedSteps / totalSteps) * 100);
    const currentTitle = currentIndex >= 0 ? masterHajSteps[currentIndex].title : "لا يوجد";
    const nextTitle = currentIndex + 1 < masterHajSteps.length
        ? masterHajSteps[currentIndex + 1]?.title
        : "تمت كل الخطوات";

    let stepVisualHTML = '';
    masterHajSteps.forEach((step, idx) => {
        let dotClass = 'step-dot';
        if (idx < currentIndex) {
            dotClass += ' completed';
        } else if (idx === currentIndex) {
            dotClass += ' current';
        }

        stepVisualHTML += `
            <div class="step-line-item">
                <div class="${dotClass}"></div>
                <div>${step.title}</div>
            </div>
        `;
    });

    const progressMap = `
        <div class="alert alert-light border">
            <h5 class="mb-3">🧭 خريطة التقدم في خطوات الحج</h5>
            <p>✅ عدد الخطوات المكتملة: <strong>${completedSteps}</strong> من <strong>${totalSteps}</strong></p>
            <p>📍 الخطوة الحالية: <strong>${currentTitle}</strong></p>
            <p>⏭️ الخطوة التالية: <strong>${nextTitle}</strong></p>
            <p><strong>${percentage}%</strong></p>
            <div class="step-line-container mt-4" data-progress="${percentage}%">
                ${stepVisualHTML}
            </div>
        </div>
    `;

    document.getElementById('progress-map').innerHTML = progressMap;
}

document.querySelector('.step-line-container').style.setProperty('--progress-percent', `${percentage}%`);


  </script>
  
  </body>
</html>